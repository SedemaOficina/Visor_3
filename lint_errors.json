[{"filePath":"C:\\Users\\jorge\\Documents\\consulta-de-predios-V3\\src\\components\\analysis\\ResultsContent.jsx","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: Unexpected token return","line":102,"column":9}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo } from 'react';\r\nimport { InView } from 'react-intersection-observer';\r\nimport StickyBox from 'react-sticky-box';\r\nimport Fuse from 'fuse.js';\r\n\r\nimport Icons from '../ui/Icons';\r\nimport Tooltip from '../ui/Tooltip';\r\nimport { CONSTANTS } from '../../utils/constants';\r\nimport { getZoningColor, getSectorStyle } from '../../utils/geoUtils';\r\n\r\n/* Helper de Zonificaci√≥n Display */\r\nconst getZoningDisplay = (analysis) => {\r\n    if (analysis.zoningKey === 'ANP') return '√ÅREA NATURAL PROTEGIDA';\r\n    if (analysis.zoningKey === 'NODATA') return 'Informaci√≥n no disponible';\r\n\r\n    const store = CONSTANTS.ZONING_CAT_INFO || {};\r\n    const catInfo = store[analysis.zoningKey];\r\n    if (catInfo && catInfo.label) return catInfo.label;\r\n\r\n    return analysis.zoningName || 'Sin informaci√≥n';\r\n};\r\n\r\n/* Helper Texto Contraste (YIQ) */\r\nconst getContrastYIQ = (hexcolor) => {\r\n    if (!hexcolor) return 'black';\r\n    hexcolor = hexcolor.replace(\"#\", \"\");\r\n    if (hexcolor.length === 3) hexcolor = hexcolor.split('').map(c => c + c).join('');\r\n    var r = parseInt(hexcolor.substr(0, 2), 16);\r\n    var g = parseInt(hexcolor.substr(2, 2), 16);\r\n    var b = parseInt(hexcolor.substr(4, 2), 16);\r\n    var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;\r\n    return (yiq >= 128) ? '#000000' : '#ffffff';\r\n};\r\n\r\n/* ------------------------------------------------ */\r\n/* SUB-COMPONENTES */\r\n/* ------------------------------------------------ */\r\n\r\nconst InlineAlert = ({ tone, children }) => {\r\n    // Configuraci√≥n de tonos\r\n    const variants = {\r\n        anp: {\r\n            bg: 'bg-purple-50',\r\n            border: 'border-purple-400',\r\n            text: 'text-purple-900',\r\n            icon: Icons.Leaf // Opcional, podr√≠a ser gen√©rico\r\n        },\r\n        nodata: {\r\n            bg: 'bg-yellow-50',\r\n            border: 'border-yellow-400',\r\n            text: 'text-yellow-800',\r\n            icon: Icons.AlertTriangle\r\n        },\r\n        urban: {\r\n            bg: 'bg-blue-50',\r\n            border: 'border-blue-400',\r\n            text: 'text-blue-900',\r\n            icon: Icons.Info\r\n        },\r\n        error: {\r\n            bg: 'bg-red-50',\r\n            border: 'border-red-400',\r\n            text: 'text-red-900',\r\n            icon: Icons.XCircle\r\n        }\r\n    };\r\n\r\n    const variant = variants[tone] || variants.nodata;\r\n    const Icon = variant.icon || (() => null);\r\n\r\n    return (\r\n        <div className={`p-3 text-xs border-l-4 rounded-r mb-3 flex items-start gap-2 animate-in fade-in ${variant.bg} ${variant.border} ${variant.text}`}>\r\n            {Icon && <Icon className=\"h-4 w-4 shrink-0 mt-0.5 opacity-80\" />}\r\n            <div className=\"leading-snug\">{children}</div>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst NormativeInstrumentCard = ({ analysis }) => {\r\n    const { status, zoningKey } = analysis;\r\n    const isSC = status === 'CONSERVATION_SOIL';\r\n    const isUrban = status === 'URBAN_SOIL';\r\n    const hasSpecificPDU = zoningKey && zoningKey.startsWith('PDU_');\r\n\r\n    if (!isSC && !isUrban) return null;\r\n\r\n    const NormativeInstrumentContainer = ({ children }) => (\r\n        <div className=\"bg-gray-50/50 rounded-lg p-3 mb-4 border border-gray-100/50\">\r\n            <div className=\"flex items-start gap-3 opacity-80 hover:opacity-100 transition-opacity\">\r\n                <div className=\"shrink-0 mt-0.5 text-gray-400\">\r\n                    {Icons.BookOpen ? <Icons.BookOpen className=\"h-4 w-4\" /> : <span>üìñ</span>}\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                    {children}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    if (isSC) {\r\n        return (\r\n        return (\r\n            <NormativeInstrumentContainer>\r\n                <div className=\"text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5\">\r\n                    Fuente Normativa\r\n                </div>\r\n                <div className=\"text-xs font-semibold text-gray-700 mb-1\">\r\n                    PGOEDF (Ordenamiento Ecol√≥gico)\r\n                </div>\r\n                <Tooltip content=\"Consultar documento oficial en nueva pesta√±a\">\r\n                    <a\r\n                        href=\"https://paot.org.mx/centro/programas/pgoedf.pdf\"\r\n                        target=\"_blank\"\r\n                        rel=\"noreferrer\"\r\n                        className=\"inline-flex items-center gap-1 text-[10px] text-blue-500 hover:text-blue-700 hover:underline\"\r\n                    >\r\n                        Ver documento oficial\r\n                        {Icons.ExternalLink && <Icons.ExternalLink className=\"h-2.5 w-2.5\" />}\r\n                    </a>\r\n                </Tooltip>\r\n            </NormativeInstrumentContainer>\r\n        );\r\n    }\r\n\r\n    if (isUrban) {\r\n        return (\r\n        return (\r\n            <NormativeInstrumentContainer>\r\n                <div className=\"text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5\">\r\n                    Fuente Normativa\r\n                </div>\r\n                <div className=\"text-xs font-semibold text-gray-700 mb-1\">\r\n                    {hasSpecificPDU ? 'Programa Parcial (PPDU)' : 'Programa Delegacional (PDDU)'}\r\n                </div>\r\n                <div className=\"flex flex-wrap gap-x-3 gap-y-1\">\r\n                    <Tooltip content=\"Ir a sitio de SEDUVI - Delegacionales\">\r\n                        <a\r\n                            href=\"https://metropolis.cdmx.gob.mx/programas-delegacionales-de-desarrollo-urbano\"\r\n                            target=\"_blank\"\r\n                            rel=\"noreferrer\"\r\n                            className=\"inline-flex items-center gap-1 text-[10px] text-blue-500 hover:text-blue-700 hover:underline\"\r\n                        >\r\n                            Programas Delegacionales\r\n                            {Icons.ExternalLink && <Icons.ExternalLink className=\"h-2.5 w-2.5\" />}\r\n                        </a>\r\n                    </Tooltip>\r\n                    <Tooltip content=\"Ir a sitio de SEDUVI - Parciales\">\r\n                        <a\r\n                            href=\"https://metropolis.cdmx.gob.mx/programas-parciales-de-desarrollo-urbano\"\r\n                            target=\"_blank\"\r\n                            rel=\"noreferrer\"\r\n                            className=\"inline-flex items-center gap-1 text-[10px] text-blue-500 hover:text-blue-700 hover:underline\"\r\n                        >\r\n                            Programas Parciales\r\n                            {Icons.ExternalLink && <Icons.ExternalLink className=\"h-2.5 w-2.5\" />}\r\n                        </a>\r\n                    </Tooltip>\r\n                </div>\r\n            </NormativeInstrumentContainer>\r\n        );\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\nconst ZoningResultCard = ({ analysis, zoningDisplay }) => {\r\n    const { status, zoningKey } = analysis;\r\n    const isSC = status === 'CONSERVATION_SOIL';\r\n\r\n    if (!isSC || !zoningKey || zoningKey === 'NODATA' || zoningKey === 'ANP' || status === 'OUTSIDE_CDMX') return null;\r\n\r\n    let zoningColor = '#9ca3af';\r\n    if (analysis.zoningKey && getZoningColor) {\r\n        zoningColor = getZoningColor(analysis.zoningKey);\r\n    }\r\n\r\n    return (\r\n        <div className=\"bg-white border border-gray-200 rounded-lg p-3 mb-3 shadow-sm animate-slide-up\">\r\n            <div className=\"text-[10px] text-gray-500 font-bold uppercase tracking-wide mb-1 flex items-center gap-1\">\r\n                Zonificaci√≥n PGOEDF\r\n                <Tooltip content=\"Zonificaci√≥n impuesta por el Programa General de Ordenamiento Ecol√≥gico del DF\">\r\n                    <span className=\"text-gray-300 hover:text-gray-500 transition-colors\">‚ìò</span>\r\n                </Tooltip>\r\n            </div>\r\n            <div className=\"flex items-start gap-2\">\r\n                <div\r\n                    className=\"w-3 h-3 rounded-full mt-1 shrink-0 border border-black/10 shadow-sm\"\r\n                    style={{ backgroundColor: zoningColor }}\r\n                />\r\n                <div className=\"text-base font-bold text-gray-800 leading-snug break-words\">\r\n                    {zoningDisplay}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst AnpGeneralCard = ({ analysis }) => {\r\n    if (!analysis || !analysis.isANP) return null;\r\n    const { anpNombre, anpCategoria, anpTipoDecreto, anpFechaDecreto, anpSupDecretada } = analysis;\r\n\r\n    return (\r\n        <div className=\"bg-purple-50 rounded-lg p-3 mb-3 animate-slide-up border border-purple-100\">\r\n            <div className=\"flex items-center gap-2 text-purple-800 font-bold text-xs uppercase mb-2 border-b border-purple-200 pb-1\">\r\n                {Icons.Leaf && <Icons.Leaf className=\"h-3 w-3\" />}\r\n                <span>R√©gimen ANP</span>\r\n            </div>\r\n\r\n            <div className=\"space-y-3 text-xs text-gray-700\">\r\n                <div className=\"grid grid-cols-1 gap-0.5\">\r\n                    <span className=\"text-[10px] uppercase font-bold text-gray-500 tracking-wide\">Nombre Oficial</span>\r\n                    <span className=\"font-semibold text-gray-900 leading-tight\">{anpNombre || 'No disponible'}</span>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 gap-3\">\r\n                    <div>\r\n                        <span className=\"text-[10px] uppercase font-bold text-gray-500 block mb-0.5 tracking-wide\">Categor√≠a</span>\r\n                        <span className=\"font-medium text-gray-900\">{anpCategoria || 'N/D'}</span>\r\n                    </div>\r\n                    <div>\r\n                        <span className=\"text-[10px] uppercase font-bold text-gray-500 block mb-0.5 tracking-wide\">Decreto</span>\r\n                        <span className=\"font-medium text-gray-900\">{anpTipoDecreto || 'N/D'}</span>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 gap-3\">\r\n                    <div>\r\n                        <span className=\"text-[10px] uppercase font-bold text-gray-500 block mb-0.5 tracking-wide\">Fecha</span>\r\n                        <span className=\"font-medium text-gray-900\">{anpFechaDecreto || 'N/D'}</span>\r\n                    </div>\r\n                    <div>\r\n                        <span className=\"text-[10px] uppercase font-bold text-gray-500 block mb-0.5 tracking-wide\">Superficie</span>\r\n                        <span className=\"font-medium text-gray-900\">{anpSupDecretada ? `${anpSupDecretada} ha` : 'N/D'}</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst AnpInternalCard = ({ analysis }) => {\r\n    if (!analysis.hasInternalAnpZoning || !analysis.anpInternalFeature) return null;\r\n    const data = analysis.anpInternalFeature.properties || {};\r\n    const zonificacion = data.ZONIFICACION || data.CATEGORIA_PROTECCION || analysis.anpCategoria || 'N/A';\r\n\r\n    return (\r\n        <div className=\"bg-purple-50 rounded-lg p-3 mb-3 animate-slide-up border border-purple-100\">\r\n            <div className=\"flex items-center gap-2 text-purple-800 font-bold text-xs uppercase mb-2 border-b border-purple-200 pb-1\">\r\n                {Icons.Verified && <Icons.Verified className=\"h-3 w-3\" />}\r\n                <span>Zonificaci√≥n Interna ANP</span>\r\n            </div>\r\n\r\n            <div className=\"space-y-1 text-xs text-gray-700\">\r\n                <span className=\"text-[10px] uppercase font-bold text-gray-500 block tracking-wide\">Zonificaci√≥n Programa de Manejo</span>\r\n                <span className=\"font-bold text-base text-gray-900 block leading-tight\">{zonificacion || 'N/A'}</span>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst LocationSummary = ({ analysis, approximateAddress, onExportPDF, isExporting, exportProgress }) => {\r\n    const COLORS = CONSTANTS.COLORS || {};\r\n\r\n    const { status } = analysis;\r\n    const isSC = status === 'CONSERVATION_SOIL';\r\n    const isUrban = status === 'URBAN_SOIL';\r\n\r\n    let zoningColor = '#9ca3af';\r\n    if (analysis.zoningKey === 'ANP') {\r\n        zoningColor = COLORS.anp || '#9333ea';\r\n    } else if (analysis.zoningKey === 'NODATA') {\r\n        zoningColor = '#9ca3af';\r\n    } else if (analysis.zoningKey && getZoningColor) {\r\n        zoningColor = getZoningColor(analysis.zoningKey);\r\n    }\r\n\r\n    const zoningBadgeLabel = analysis.zoningKey && analysis.zoningKey !== 'NODATA' && analysis.zoningKey !== 'ANP'\r\n        ? getZoningDisplay(analysis)\r\n        : null;\r\n\r\n    if (status === 'OUTSIDE_CDMX') return null;\r\n\r\n    return (\r\n        <div className=\"bg-white border border-gray-100 rounded-xl p-4 mb-4 shadow-none animate-slide-up\">\r\n\r\n            {/* 1. Direcci√≥n Aproximada */}\r\n            {approximateAddress && (\r\n                <div className=\"mb-3 pb-3 border-b border-gray-100\">\r\n                    <div className=\"flex items-start gap-2\">\r\n                        {Icons.MapPin && <div className=\"mt-0.5 text-[#9d2449]\"><Icons.MapPin className=\"h-3.5 w-3.5\" /></div>}\r\n                        <div>\r\n                            <div className=\"text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5\">\r\n                                Direcci√≥n Aproximada (Orientativa)\r\n                            </div>\r\n                            <div className=\"text-xs font-semibold text-gray-800 leading-snug\">\r\n                                {approximateAddress}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* 2. Alcald√≠a */}\r\n            {\r\n                status !== 'OUTSIDE_CDMX' && (\r\n                    <div className=\"mb-3 pb-3 border-b border-gray-100\">\r\n                        <div className=\"text-[10px] text-gray-500 font-semibold uppercase tracking-wide mb-0.5\">Alcald√≠a</div>\r\n                        <div className=\"text-lg font-bold text-gray-900 leading-tight\">\r\n                            {analysis.alcaldia || 'Ciudad de M√©xico'}\r\n                        </div>\r\n                    </div>\r\n                )\r\n            }\r\n\r\n            {/* 3. Badges */}\r\n            <div className=\"flex flex-wrap items-center gap-2 mb-2\">\r\n                {/* Badge Suelo Base */}\r\n                {status !== 'OUTSIDE_CDMX' && (\r\n                    <span\r\n                        className=\"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase leading-none\"\r\n                        style={{\r\n                            backgroundColor: isSC ? COLORS.sc : isUrban ? COLORS.su : '#6b7280',\r\n                            color: '#ffffff'\r\n                        }}\r\n                    >\r\n                        {isSC ? 'Suelo de Conservaci√≥n' : 'Suelo Urbano'}\r\n                    </span>\r\n                )}\r\n\r\n                {/* Badge Zonificaci√≥n */}\r\n                {zoningBadgeLabel && (\r\n                    <span\r\n                        className=\"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase leading-none\"\r\n                        style={{\r\n                            backgroundColor: zoningColor,\r\n                            color: getContrastYIQ(zoningColor)\r\n                        }}\r\n                    >\r\n                        {zoningBadgeLabel}\r\n                    </span>\r\n                )}\r\n\r\n                {/* Badge ANP */}\r\n                {analysis.isANP && (\r\n                    <span\r\n                        className=\"inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase leading-none bg-[#9333ea] text-white\"\r\n                    >\r\n                        ANP\r\n                    </span>\r\n                )}\r\n            </div>\r\n\r\n            {/* 4. Botones de Acci√≥n */}\r\n            <div className=\"mt-4 pt-3 border-t border-gray-100 flex gap-3\">\r\n                <Tooltip content=\"Ver ubicaci√≥n exacta en Google Maps\">\r\n                    <a\r\n                        href={analysis.coordinate ? `https://www.google.com/maps/search/?api=1&query=${analysis.coordinate.lat},${analysis.coordinate.lng}` : '#'}\r\n                        target=\"_blank\"\r\n                        rel=\"noreferrer\"\r\n                        className=\"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg text-gray-700 font-bold text-[10px] md:text-xs shadow-sm hover:bg-gray-50 transition-colors\"\r\n                    >\r\n                        {Icons.MapIcon && <Icons.MapIcon className=\"h-4 w-4 text-blue-500\" />}\r\n                        <span>Google Maps</span>\r\n                    </a>\r\n                </Tooltip>\r\n\r\n                <Tooltip content=\"Generar ficha PDF con informaci√≥n oficial preliminar\">\r\n                    <button\r\n                        type=\"button\"\r\n                        onClick={(e) => {\r\n                            e.preventDefault();\r\n                            if (!isExporting && onExportPDF) onExportPDF(e);\r\n                        }}\r\n                        disabled={isExporting}\r\n                        className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg font-bold text-[10px] md:text-xs text-white shadow-sm transition-all active:scale-95\r\n                        ${isExporting ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#9d2449] hover:bg-[#8a1f40]'}`}\r\n                    >\r\n                        {isExporting ? (\r\n                            <div className=\"flex items-center gap-2\">\r\n                                {Icons.Loader2 ? <Icons.Loader2 className=\"h-4 w-4 animate-spin\" /> : <div className=\"h-3 w-3 rounded-full border-2 border-white/50 border-t-white animate-spin\" />}\r\n                                <span>{exportProgress ? `${exportProgress}%` : 'Generando...'}</span>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"flex items-center gap-2\">\r\n                                {Icons.Pdf && <Icons.Pdf className=\"h-4 w-4\" />}\r\n                                <span>Descargar Ficha</span>\r\n                            </div>\r\n                        )}\r\n                    </button>\r\n                </Tooltip>\r\n            </div>\r\n        </div >\r\n    );\r\n};\r\n\r\n\r\nconst GroupedActivities = ({ title, activities, icon, headerClass, bgClass, accentColor }) => {\r\n    if (!activities || activities.length === 0) return null;\r\n\r\n    // 1. Grouping\r\n    const groups = {};\r\n    activities.forEach(a => {\r\n        if (!groups[a.sector]) groups[a.sector] = {};\r\n        if (!groups[a.sector][a.general]) groups[a.sector][a.general] = new Set();\r\n        // Deduplicate specifics using Set\r\n        groups[a.sector][a.general].add(a.specific);\r\n    });\r\n\r\n    // 2. Sorting Steps\r\n    const sortedSectors = Object.keys(groups).sort((a, b) => a.localeCompare(b));\r\n\r\n    return (\r\n        <details open className={`group rounded-lg border border-gray-200 overflow-hidden mb-3 ${bgClass}`}>\r\n            <summary className={`flex items-center justify-between px-3 py-2.5 cursor-pointer ${headerClass} hover:opacity-90 transition-opacity`}>\r\n                <div className=\"flex items-center gap-2 font-bold text-xs\">\r\n                    {icon}\r\n                    <span>\r\n                        {title}{' '}\r\n                        <span className=\"text-[10px] font-normal opacity-80\">\r\n                            ({activities.length})\r\n                        </span>\r\n                    </span>\r\n                </div>\r\n                {Icons.ChevronDown && <Icons.ChevronDown className=\"h-4 w-4 group-open:rotate-180 transition-transform\" />}\r\n            </summary>\r\n\r\n            {/* Mobile Scroll Limit: max-h-[45vh] on mobile only. MD: no limit */}\r\n            <div className=\"px-3 py-2 bg-white border-t border-gray-100 space-y-3 overflow-y-auto custom-scrollbar max-h-[45vh] md:max-h-none\">\r\n                {sortedSectors.map((sector, i) => {\r\n                    const generalsMap = groups[sector];\r\n                    const sortedGenerals = Object.keys(generalsMap).sort((a, b) => a.localeCompare(b));\r\n                    const st = getSectorStyle ? getSectorStyle(sector) : { border: '#ccc', text: '#333' };\r\n\r\n                    return (\r\n                        <div key={i} className=\"mb-2 rounded overflow-hidden border border-gray-100\">\r\n                            <div\r\n                                className=\"px-3 py-1.5 font-bold text-[10px] uppercase tracking-wide bg-gray-50 border-b border-gray-100 text-gray-500\"\r\n                            >\r\n                                {sector}\r\n                            </div>\r\n\r\n                            <div className=\"bg-white\">\r\n                                {sortedGenerals.map((gen, j) => {\r\n                                    const specificSet = generalsMap[gen];\r\n                                    const specificList = Array.from(specificSet).sort((a, b) => a.localeCompare(b));\r\n\r\n                                    return (\r\n                                        <details key={j} className=\"group/inner border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors\">\r\n                                            <summary className=\"px-3 py-2 text-[11px] font-medium text-gray-700 cursor-pointer flex justify-between select-none items-start gap-2\">\r\n                                                <div className=\"flex items-start gap-2\">\r\n                                                    <span\r\n                                                        className=\"w-1.5 h-1.5 rounded-full mt-1.5 shrink-0\"\r\n                                                        style={{ backgroundColor: accentColor || st.border }}\r\n                                                    />\r\n                                                    <span className=\"leading-snug\">{gen}</span>\r\n                                                </div>\r\n                                                <div className=\"flex items-center gap-1 shrink-0 mt-0.5\">\r\n                                                    <span className=\"text-[9px] text-gray-400 bg-gray-100 px-1.5 rounded-full\">\r\n                                                        {specificList.length}\r\n                                                    </span>\r\n                                                    {Icons.ChevronDown && <Icons.ChevronDown className=\"h-3 w-3 text-gray-400 group-open/inner:rotate-180 transition-transform\" />}\r\n                                                </div>\r\n                                            </summary>\r\n\r\n                                            <ul className=\"bg-gray-50/30 px-4 py-2 space-y-1.5\">\r\n                                                {specificList.map((spec, k) => (\r\n                                                    <li\r\n                                                        key={k}\r\n                                                        className=\"text-[11px] text-gray-600 pl-3 relative border-l-2 border-gray-200 leading-snug\"\r\n                                                    >\r\n                                                        {spec}\r\n                                                    </li>\r\n                                                ))}\r\n                                            </ul>\r\n                                        </details>\r\n                                    );\r\n                                })}\r\n                            </div>\r\n                        </div>\r\n                    );\r\n                })}\r\n            </div>\r\n        </details>\r\n    );\r\n};\r\n\r\nconst LegalDisclaimer = () => (\r\n    <div className=\"mt-6 mb-2 p-0 text-[10px] text-gray-400 text-center uppercase tracking-wide opacity-70\">\r\n        Informaci√≥n de car√°cter orientativo. No sustituye documentos oficiales.\r\n    </div>\r\n);\r\n\r\n\r\n\r\nconst CitizenSummaryCard = ({ analysis }) => {\r\n    if (!analysis) return null;\r\n\r\n    const { status, zoningKey, isANP, alcaldia } = analysis;\r\n\r\n    // --- REGLAS DE INTERPRETACION (Determinista) ---\r\n    const getExplanation = () => {\r\n        if (status === 'OUTSIDE_CDMX') {\r\n            const estado = analysis.outsideContext;\r\n            if (estado) {\r\n                return `La ubicaci√≥n consultada se localiza en el **${estado}**. La presente herramienta corresponde a normatividad de la **Ciudad de M√©xico**, por lo que **no aplica** en este territorio. La determinaci√≥n normativa corresponde a las **autoridades competentes del ${estado}**.`;\r\n            } else {\r\n                return `La ubicaci√≥n consultada se localiza **fuera de la Ciudad de M√©xico**. La normatividad consultada en este visor **no es aplicable** en este territorio. La determinaci√≥n normativa corresponde a las **autoridades estatales o municipales competentes**.`;\r\n            }\r\n        }\r\n\r\n        if (status === 'URBAN_SOIL') {\r\n            if (isANP) {\r\n                return `Aunque el punto se ubica en **Suelo Urbano**, se localiza dentro de un **√Årea Natural Protegida (ANP)**. En estos casos, la regulaci√≥n espec√≠fica de usos y destinos del suelo se determina por el **Programa de Manejo** correspondiente, conforme al PGOEDF.`;\r\n            }\r\n            return `El punto se ubica en **Suelo Urbano**. La regulaci√≥n aplicable en materia de usos del suelo se determina mediante los **Programas de Desarrollo Urbano** (Delegacionales o Parciales) y la autoridad competente en la demarcaci√≥n correspondiente (**${alcaldia || 'la alcald√≠a'}**).`;\r\n        }\r\n\r\n        if (status === 'CONSERVATION_SOIL') {\r\n            // ANP CASE\r\n            if (isANP) {\r\n                return `El punto se ubica en **Suelo de Conservaci√≥n** y dentro de un **√Årea Natural Protegida (ANP)**. Conforme al PGOEDF, la regulaci√≥n espec√≠fica de usos y destinos del suelo se define por el **Programa de Manejo** correspondiente.`;\r\n            }\r\n\r\n            // ZONING CASES (PGOEDF)\r\n            switch (zoningKey) {\r\n                case 'RE':\r\n                    return `Zona orientada a la **restauraci√≥n ecol√≥gica** de √°reas con afectaci√≥n. En el marco del PGOEDF, la gesti√≥n ambiental se enfoca en **recuperar la cobertura y funcionalidad** del territorio, priorizando acciones compatibles con la conservaci√≥n de bienes y servicios ambientales.`;\r\n                case 'FC':\r\n                case 'FCE':\r\n                case 'FP':\r\n                case 'FPE':\r\n                    return `Zona con **altos valores ambientales** asociados a vegetaci√≥n natural y funciones clave como **recarga del acu√≠fero** y **conservaci√≥n de biodiversidad**. El PGOEDF establece que su uso debe ser **planificado y regulado** para evitar deterioro, frenar el cambio de cobertura natural y asegurar la permanencia de los ecosistemas.`;\r\n                case 'PR':\r\n                case 'PRA':\r\n                    return `Zona con aptitud para **actividades productivas rurales**. El PGOEDF orienta estas actividades para que sean **compatibles con la conservaci√≥n de recursos naturales** y para minimizar conflictos ambientales, promoviendo el aprovechamiento sustentable en funci√≥n de la capacidad del territorio.`;\r\n                case 'AE':\r\n                case 'AEE':\r\n                case 'AF':\r\n                case 'AFE':\r\n                    return `Zona con **alto potencial para actividades agr√≠colas y pecuarias**. El PGOEDF se√±ala que deben evitarse pr√°cticas que alteren la **capacidad f√≠sica y productiva del suelo**, aplicar **t√©cnicas de conservaci√≥n de suelo y agua**, y promover el uso de **composta y abonos org√°nicos**, reduciendo al m√°ximo productos qu√≠micos.`;\r\n                case 'PDU_ER':\r\n                    return `Zona identificada por Programas de Desarrollo Urbano (PDU) para **equipamientos** en territorio rural. Conforme al PGOEDF, estos pol√≠gonos se regulan por los **Programas Delegacionales o Parciales** aplicables y deben considerarse en congruencia con la gesti√≥n del Suelo de Conservaci√≥n.`;\r\n                case 'PDU_PR':\r\n                    return `Zona identificada como **Poblado Rural** dentro de los Programas de Desarrollo Urbano (PDU). Conforme al PGOEDF, estos pol√≠gonos se regulan por los **Programas Delegacionales o Parciales** aplicables, al tratarse de asentamientos y √°reas normadas por planeaci√≥n urbana vigente.`;\r\n                default:\r\n                    return `El punto se ubica en **Suelo de Conservaci√≥n**. El PGOEDF define una zonificaci√≥n para delinear un patr√≥n de usos del suelo que **maximice servicios ambientales** (incluida la **recarga del acu√≠fero**) y la capacidad productiva, y que **minimice conflictos ambientales**, asignando actividades conforme a la capacidad del territorio para sostenerlas y frenar el cambio de cobertura natural.`;\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    const text = getExplanation();\r\n    if (!text) return null;\r\n\r\n    const isOutside = status === 'OUTSIDE_CDMX';\r\n\r\n    // Styles Configuration\r\n    const baseClasses = isOutside\r\n        ? \"relative mb-4 rounded-xl p-4 bg-red-50 to-white border border-red-100 shadow-sm animate-in slide-in-from-bottom-2 duration-500\"\r\n        : \"relative mb-4 rounded-xl p-4 bg-gradient-to-br from-blue-50 to-white border border-blue-100 shadow-sm animate-in slide-in-from-bottom-2 duration-500\";\r\n\r\n    const iconContainerClasses = isOutside\r\n        ? \"shrink-0 mt-0.5 p-1.5 bg-red-100 rounded-lg text-red-600\"\r\n        : \"shrink-0 mt-0.5 p-1.5 bg-blue-100 rounded-lg text-blue-600\";\r\n\r\n    const titleClasses = isOutside\r\n        ? \"hidden\"\r\n        : \"text-[10px] font-bold text-blue-500 uppercase tracking-wide mb-1 flex items-center gap-1\";\r\n\r\n    const textClasses = isOutside\r\n        ? \"text-xs text-red-800 leading-relaxed font-medium\"\r\n        : \"text-xs text-slate-700 leading-relaxed font-medium\";\r\n\r\n    return (\r\n        <div className={baseClasses}>\r\n            <div className=\"flex items-start gap-3 relative z-10\">\r\n                <div className={iconContainerClasses}>\r\n                    {isOutside && Icons.AlertTriangle ? <Icons.AlertTriangle className=\"h-4 w-4\" /> : (Icons.Info ? <Icons.Info className=\"h-4 w-4\" /> : <span>i</span>)}\r\n                </div>\r\n                <div>\r\n\r\n                    <p className={textClasses}>\r\n                        <span dangerouslySetInnerHTML={{ __html: text.replace(/\\*\\*(.*?)\\*\\*/g, '<strong class=\"font-bold\">$1</strong>') }} />\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n\r\n\r\n// --- REFACTORED HEADER (Desktop Only) ---\r\nconst PrimaryActionHeader = ({ analysis, approximateAddress, onExportPDF, isExporting, exportProgress }) => {\r\n    // Visible on Desktop only.\r\n    if (!analysis?.coordinate) return null;\r\n\r\n    return (\r\n        <div className=\"mb-4 bg-white sticky top-0 z-50 pb-3 border-b border-gray-100 md:block hidden animate-in fade-in\">\r\n            {/* Address Display (Desktop Sticky) */}\r\n            {/* Address Display (Desktop Sticky) - HIDDEN as it is now in LocationSummary */}\r\n            {/* {approximateAddress && (\r\n                <div className=\"mb-3 px-1\">\r\n                    <div className=\"text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5 flex items-center gap-1\">\r\n                        <Icons.MapPin className=\"h-3 w-3\" />\r\n                        Direcci√≥n Aproximada\r\n                    </div>\r\n                    <div className=\"text-sm font-bold text-gray-800 leading-snug\">\r\n                        {approximateAddress}\r\n                    </div>\r\n                </div>\r\n            )} */}\r\n\r\n            {/* Action Buttons */}\r\n            <div className=\"flex gap-3\">\r\n                <Tooltip content=\"Ver ubicaci√≥n exacta en Google Maps\">\r\n                    <a\r\n                        href={`https://www.google.com/maps/search/?api=1&query=${analysis.coordinate.lat},${analysis.coordinate.lng}`}\r\n                        target=\"_blank\"\r\n                        rel=\"noreferrer\"\r\n                        className=\"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg text-gray-700 font-bold text-xs shadow-sm hover:bg-gray-50 transition-colors\"\r\n                    >\r\n                        {Icons.MapIcon && <Icons.MapIcon className=\"h-4 w-4 text-blue-500\" />}\r\n                        <span>Google Maps</span>\r\n                    </a>\r\n                </Tooltip>\r\n\r\n                <Tooltip content=\"Generar ficha PDF con informaci√≥n oficial preliminar\">\r\n                    <button\r\n                        type=\"button\"\r\n                        onClick={(e) => {\r\n                            e.preventDefault();\r\n                            if (!isExporting && onExportPDF) onExportPDF(e);\r\n                        }}\r\n                        disabled={isExporting}\r\n                        className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg font-bold text-xs text-white shadow-sm transition-all active:scale-95\r\n                        ${isExporting ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#9d2449] hover:bg-[#8a1f40]'}`}\r\n                    >\r\n                        {isExporting ? (\r\n                            <div className=\"flex items-center gap-2\">\r\n                                {Icons.Loader2 ? <Icons.Loader2 className=\"h-4 w-4 animate-spin\" /> : <div className=\"h-3 w-3 rounded-full border-2 border-white/50 border-t-white animate-spin\" />}\r\n                                <span>{exportProgress ? `${exportProgress}%` : 'Generando...'}</span>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"flex items-center gap-2\">\r\n                                {Icons.Pdf && <Icons.Pdf className=\"h-4 w-4\" />}\r\n                                <span>Descargar Ficha</span>\r\n                            </div>\r\n                        )}\r\n                    </button>\r\n                </Tooltip>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// --- NEW OVERLAY PROGRESS ---\r\nconst ExportProgressOverlay = ({ isExporting, progress }) => {\r\n    if (!isExporting) return null;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-[2px] animate-in fade-in duration-200\">\r\n            <div className=\"bg-white rounded-2xl shadow-2xl p-6 flex flex-col items-center gap-4 max-w-xs w-full mx-4 animate-in zoom-in-95 duration-200\">\r\n                <div className=\"relative\">\r\n                    <div className=\"w-12 h-12 border-4 border-gray-100 rounded-full\"></div>\r\n                    <div className=\"absolute inset-0 w-12 h-12 border-4 border-[#9d2449] border-t-transparent rounded-full animate-spin\"></div>\r\n                    <div className=\"absolute inset-0 flex items-center justify-center text-sm font-bold text-[#9d2449]\">\r\n                        {progress || 0}%\r\n                    </div>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                    <h3 className=\"text-sm font-bold text-gray-900 mb-1\">Generando PDF</h3>\r\n                    <p className=\"text-xs text-gray-500\">Por favor espere un momento...</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n\r\n// --- NEW CATALOG CONTROLLER ---\r\nconst ActivityCatalogController = ({ analysis, Icons, COLORS }) => {\r\n    const [activeTab, setActiveTab] = useState('prohibidas');\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [selectedSectors, setSelectedSectors] = useState(new Set());\r\n    const [showCatalog, setShowCatalog] = useState(true);\r\n\r\n    // 1. Data Source\r\n    const sourceList = activeTab === 'prohibidas' ? (analysis.prohibitedActivities || []) : (analysis.allowedActivities || []);\r\n\r\n    // 2. Extract Sectors (from current list)\r\n    const allSectors = Array.from(new Set(sourceList.map(item => item.sector))).sort();\r\n\r\n    // 3. Filter with Fuse.js\r\n    // Fuse Instance\r\n    const fuse = useMemo(() => {\r\n        if (!Fuse) return null;\r\n        return new Fuse(sourceList, {\r\n            keys: ['sector', 'general', 'specific'],\r\n            threshold: 0.3,\r\n            ignoreLocation: true\r\n        });\r\n    }, [sourceList]);\r\n\r\n    const filteredList = useMemo(() => {\r\n        let results = sourceList;\r\n\r\n        // A) Search Filter\r\n        if (searchTerm.trim() && fuse) {\r\n            results = fuse.search(searchTerm).map(r => r.item);\r\n        } else if (searchTerm.trim()) {\r\n            // Fallback simple filter if Fuse fails\r\n            const lower = searchTerm.toLowerCase();\r\n            results = sourceList.filter(item =>\r\n                item.general.toLowerCase().includes(lower) ||\r\n                item.specific.toLowerCase().includes(lower) ||\r\n                item.sector.toLowerCase().includes(lower)\r\n            );\r\n        }\r\n\r\n        // B) Sector Filter\r\n        if (selectedSectors.size > 0) {\r\n            results = results.filter(item => selectedSectors.has(item.sector));\r\n        }\r\n\r\n        return results;\r\n    }, [sourceList, searchTerm, selectedSectors, fuse]);\r\n\r\n    // Handlers\r\n    const toggleSector = (sec) => {\r\n        const next = new Set(selectedSectors);\r\n        if (next.has(sec)) next.delete(sec);\r\n        else next.add(sec);\r\n        setSelectedSectors(next);\r\n    };\r\n\r\n    const clearFilters = () => {\r\n        setSearchTerm('');\r\n        setSelectedSectors(new Set());\r\n    };\r\n\r\n    return (\r\n        <div className=\"mt-8 mb-6\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <div className=\"p-1.5 bg-gray-100 rounded-md text-gray-500\">\r\n                        {Icons.List ? <Icons.List className=\"h-4 w-4\" /> : <span>=</span>}\r\n                    </div>\r\n                    <div>\r\n                        <h3 className=\"text-sm font-bold text-gray-800 uppercase tracking-wide\">\r\n                            Cat√°logo de Actividades\r\n                            <Tooltip content=\"Alcance: Estas actividades aplican espec√≠ficamente a la zonificaci√≥n PGOEDF del predio consultado.\">\r\n                                <span className=\"ml-1 text-gray-400 hover:text-gray-600 text-xs cursor-help\">‚ìò</span>\r\n                            </Tooltip>\r\n                        </h3>\r\n                        <p className=\"text-[10px] text-gray-400\">Consulta los usos permitidos y prohibidos</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Controls Container */}\r\n            <div className=\"bg-white border border-gray-100 rounded-xl shadow-sm p-4 mb-4\">\r\n\r\n                {/* Search & Tabs Row */}\r\n                <div className=\"flex flex-col gap-3 mb-4\">\r\n                    {/* Search Input */}\r\n                    <div className=\"relative\">\r\n                        <div className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\">\r\n                            {Icons.Search ? <Icons.Search className=\"h-4 w-4\" /> : <span>üîç</span>}\r\n                        </div>\r\n                        <input\r\n                            type=\"text\"\r\n                            className=\"w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all placeholder-gray-400\"\r\n                            placeholder=\"Buscar actividad (ej. vivienda, comercio, abarrotes)...\"\r\n                            value={searchTerm}\r\n                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                        />\r\n                        {searchTerm && (\r\n                            <Tooltip content=\"Limpiar b√∫squeda\">\r\n                                <button\r\n                                    onClick={() => setSearchTerm('')}\r\n                                    className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600\"\r\n                                >\r\n                                    ‚úï\r\n                                </button>\r\n                            </Tooltip>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Accessible Tabs (Headless UI Pattern) */}\r\n                    <div className=\"flex p-1 bg-gray-100 rounded-lg shrink-0\" role=\"tablist\" aria-label=\"Filtro de actividades\">\r\n                        <button\r\n                            role=\"tab\"\r\n                            aria-selected={activeTab === 'prohibidas'}\r\n                            aria-controls=\"panel-prohibidas\"\r\n                            id=\"tab-prohibidas\"\r\n                            onClick={() => setActiveTab('prohibidas')}\r\n                            className={`flex-1 px-4 py-2 text-[10px] font-bold uppercase tracking-wide rounded-md transition-all focus:outline-none focus:ring-2 focus:ring-[#9d2449] ${activeTab === 'prohibidas'\r\n                                ? 'bg-white text-red-700 shadow-sm ring-1 ring-black/5'\r\n                                : 'text-gray-500 hover:text-gray-700'\r\n                                }`}\r\n                        >\r\n                            Prohibidas ({analysis.prohibitedActivities?.length || 0})\r\n                        </button>\r\n                        <button\r\n                            role=\"tab\"\r\n                            aria-selected={activeTab === 'permitidas'}\r\n                            aria-controls=\"panel-permitidas\"\r\n                            id=\"tab-permitidas\"\r\n                            onClick={() => setActiveTab('permitidas')}\r\n                            className={`flex-1 px-4 py-2 text-[10px] font-bold uppercase tracking-wide rounded-md transition-all focus:outline-none focus:ring-2 focus:ring-[#9d2449] ${activeTab === 'permitidas'\r\n                                ? 'bg-white text-green-700 shadow-sm ring-1 ring-black/5'\r\n                                : 'text-gray-500 hover:text-gray-700'\r\n                                }`}\r\n                        >\r\n                            Permitidas ({analysis.allowedActivities?.length || 0})\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Sector Chips & Mobile Index */}\r\n                {allSectors.length > 0 && (\r\n                    <div className=\"space-y-2\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-[10px] font-bold text-gray-400 uppercase tracking-wider\">Filtrar por Sector</span>\r\n                            {(selectedSectors.size > 0) && (\r\n                                <button onClick={clearFilters} className=\"text-[10px] text-blue-500 hover:text-blue-700 font-medium hover:underline\">\r\n                                    Limpiar filtros\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                        <div className=\"flex flex-wrap gap-2 max-h-[120px] overflow-y-auto custom-scrollbar\">\r\n                            {allSectors.map(sec => {\r\n                                const isSelected = selectedSectors.has(sec);\r\n                                return (\r\n                                    <button\r\n                                        key={sec}\r\n                                        onClick={() => toggleSector(sec)}\r\n                                        className={`px-2 py-0.5 rounded-md text-[9px] font-bold border transition-all active:scale-95 text-left ${isSelected\r\n                                            ? 'bg-blue-600 border-blue-600 text-white shadow-sm'\r\n                                            : 'bg-white border-gray-200 text-gray-500 hover:border-gray-300 hover:bg-gray-50'\r\n                                            }`}\r\n                                    >\r\n                                        {sec}\r\n                                    </button>\r\n                                )\r\n                            })}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Results List (Tab Panel) */}\r\n            <div\r\n                role=\"tabpanel\"\r\n                id={`panel-${activeTab}`}\r\n                aria-labelledby={`tab-${activeTab}`}\r\n                className=\"animate-in fade-in slide-in-from-bottom-2 focus:outline-none\"\r\n                tabIndex={0}\r\n            >\r\n                <div className=\"text-[10px] text-gray-400 font-medium mb-2 text-right\">\r\n                    Mostrando {filteredList.length} de {sourceList.length} resultados\r\n                </div>\r\n\r\n                {filteredList.length === 0 ? (\r\n                    <div className=\"p-8 text-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200\">\r\n                        <div className=\"text-2xl mb-2 opacity-20\">üîç</div>\r\n                        <div className=\"text-sm font-semibold text-gray-500\">No se encontraron actividades</div>\r\n                        <div className=\"text-xs text-gray-400\">Intenta ajustar tu b√∫squeda o los filtros de sector</div>\r\n                        <button onClick={clearFilters} className=\"mt-4 px-4 py-2 bg-white border border-gray-200 shadow-sm rounded-lg text-xs font-bold text-gray-600 hover:text-blue-600\">\r\n                            Ver todo\r\n                        </button>\r\n                    </div>\r\n                ) : (\r\n                    <GroupedActivities\r\n                        title={activeTab === 'prohibidas' ? \"Listado de Prohibiciones\" : \"Listado de Usos Permitidos\"}\r\n                        activities={filteredList}\r\n                        icon={activeTab === 'prohibidas'\r\n                            ? (Icons.XCircle ? <Icons.XCircle className=\"h-4 w-4\" /> : null)\r\n                            : (Icons.CheckCircle ? <Icons.CheckCircle className=\"h-4 w-4\" /> : null)\r\n                        }\r\n                        headerClass={activeTab === 'prohibidas' ? \"text-red-800\" : \"text-green-800\"}\r\n                        bgClass=\"bg-white shadow-sm hover:shadow-md transition-shadow\"\r\n                        accentColor={activeTab === 'prohibidas' ? COLORS.error : COLORS.success}\r\n                    />\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nconst ResultsContent = ({ analysis, approximateAddress, onExportPDF, isExporting, exportProgress }) => {\r\n    const [showNotes, setShowNotes] = useState(false);\r\n    const [activeSection, setActiveSection] = useState('Resumen');\r\n\r\n    const COLORS = CONSTANTS.COLORS || {};\r\n\r\n    if (!analysis) return null;\r\n\r\n    const { status, zoningKey, isANP } = analysis;\r\n    const zoningDisplay = getZoningDisplay(analysis);\r\n\r\n    return (\r\n        <div className=\"space-y-3 animate-in pb-4\">\r\n\r\n            {/* 1. Location and basic context */}\r\n            <InView as=\"div\" onChange={(inView) => inView && setActiveSection('Resumen Contextual')} threshold={0.5}>\r\n                <LocationSummary\r\n                    analysis={analysis}\r\n                    approximateAddress={approximateAddress}\r\n                    onExportPDF={onExportPDF}\r\n                    isExporting={isExporting}\r\n                    exportProgress={exportProgress}\r\n                />\r\n            </InView>\r\n\r\n            {/* 1.A Primary Actions (Desktop Static) */}\r\n            <div className=\"hidden md:block z-20\">\r\n                <StickyBox offsetTop={45} offsetBottom={20}>\r\n                    <PrimaryActionHeader analysis={analysis} approximateAddress={approximateAddress} onExportPDF={onExportPDF} isExporting={isExporting} exportProgress={exportProgress} />\r\n                </StickyBox>\r\n            </div>\r\n\r\n            {/* NEW: Full Screen Overlay for PDF Generation */}\r\n            <ExportProgressOverlay isExporting={isExporting} progress={exportProgress} />\r\n\r\n            {/* 1.B Citizen Summary (Rule Based) */}\r\n            <CitizenSummaryCard analysis={analysis} />\r\n\r\n            {/* 2. Unified Critical Alerts */}\r\n\r\n            {(status === 'NO_DATA' || zoningKey === 'NODATA') && status !== 'URBAN_SOIL' && status !== 'OUTSIDE_CDMX' && (\r\n                <InlineAlert tone=\"nodata\">\r\n                    <strong>Sin Informaci√≥n:</strong> No se encontraron datos de zonificaci√≥n para esta ubicaci√≥n.\r\n                </InlineAlert>\r\n            )}\r\n\r\n            {(isANP || zoningKey === 'ANP') && (\r\n                <InlineAlert tone=\"anp\">\r\n                    <strong>√Årea Natural Protegida:</strong> Este punto se encuentra dentro de un ANP y se rige por su Programa de Manejo.\r\n                </InlineAlert>\r\n            )}\r\n\r\n            {/* 3. Instrumento Rector */}\r\n            <NormativeInstrumentCard analysis={analysis} />\r\n\r\n            {/* 4. Zonificaci√≥n PGOEDF (Solo SC) */}\r\n            <ZoningResultCard analysis={analysis} zoningDisplay={zoningDisplay} />\r\n\r\n            {/* 5. ANP Details (Si aplica) */}\r\n            <AnpGeneralCard analysis={analysis} />\r\n            <AnpInternalCard analysis={analysis} />\r\n\r\n            {/* 6. Cat√°logo de Actividades (Solo SC, no PDU) - REFACTORED */}\r\n            {analysis.status === 'CONSERVATION_SOIL' &&\r\n                !analysis.isPDU &&\r\n                !analysis.noActivitiesCatalog && (\r\n                    <InView as=\"div\" onChange={(inView) => inView && setActiveSection('Cat√°logo de Actividades')} threshold={0.2} rootMargin=\"-20% 0px -50% 0px\">\r\n                        <ActivityCatalogController analysis={analysis} Icons={Icons} COLORS={COLORS} />\r\n                    </InView>\r\n                )}\r\n\r\n            {/* 7. Notas Normativas, Instrumentos, Disclaimers (Soporte) */}\r\n            <InView as=\"div\" onChange={(inView) => inView && setActiveSection('Soporte Normativo')} threshold={0.3}>\r\n                {/* 7. NOTAS moved here logic wise for grouping */}\r\n                {status === 'CONSERVATION_SOIL' && zoningKey && zoningKey !== 'NODATA' && zoningKey !== 'ANP' && (\r\n                    <div className=\"mt-4 mb-4 border border-gray-100 rounded-lg overflow-hidden\">\r\n                        <Tooltip content=\"Ver detalles y excepciones normativas\">\r\n                            <button\r\n                                type=\"button\"\r\n                                aria-expanded={showNotes}\r\n                                aria-controls=\"notes-panel\"\r\n                                onClick={() => setShowNotes(!showNotes)}\r\n                                className=\"w-full flex items-center gap-2 p-3 bg-white hover:bg-gray-50 transition-colors text-left group focus:outline-none focus:bg-gray-50\"\r\n                            >\r\n                                <div className=\"p-1 bg-gray-100 rounded text-gray-500 group-hover:text-gray-700 transition-colors\">\r\n                                    {showNotes ? (Icons.ChevronUp ? <Icons.ChevronUp className=\"h-3 w-3\" /> : <span>-</span>) : (Icons.ChevronDown ? <Icons.ChevronDown className=\"h-3 w-3\" /> : <span>+</span>)}\r\n                                </div>\r\n                                <span className=\"text-[10px] font-bold text-gray-500 uppercase tracking-wide group-hover:text-gray-700\">\r\n                                    Notas Normativas y Criterios\r\n                                </span>\r\n                            </button>\r\n                        </Tooltip>\r\n\r\n                        <div\r\n                            id=\"notes-panel\"\r\n                            hidden={!showNotes}\r\n                            className={`bg-gray-50/50 border-t border-gray-100 ${showNotes ? 'block animate-in slide-in-from-top-1 fade-in' : 'hidden'}`}\r\n                        >\r\n                            <div className=\"p-3 pl-4 prose prose-sm max-w-none\">\r\n                                <ul className=\"space-y-2\">\r\n                                    {[\r\n                                        \"Adicionalmente a lo dispuesto en la tabla de usos del suelo, para cualquier obra o actividad que se pretenda desarrollar se deber√°n contemplar los criterios y lineamientos se√±alados en el programa de Ordenamiento Ecol√≥gico, as√≠ como cumplir con los permisos y autorizaciones en materia ambiental del Distrito Federal.\",\r\n                                        \"Los usos del suelo no identificados en esta tabla deber√°n cumplir con los permisos y autorizaciones en materia urbana y ambiental aplicables en Suelo de Conservaci√≥n.\",\r\n                                        \"En las Areas Naturales Protegidas ANP regir√° la zonificaci√≥n especificada en su respectivo Programa de Manejo.\",\r\n                                        \"La zonificaci√≥n denominada PDU corresponde a las √°reas normadas por los Programas Delegacionales o Parciales de Desarrollo Urbano vigentes.\",\r\n                                        \"Las disposiciones de la presente regulaci√≥n no prejuzgan sobre la propiedad de la tierra.\",\r\n                                        \"El Suelo de Conservaci√≥n definido por las barrancas estar√° regulado por la zonificaci√≥n Forestal de Conservaci√≥n FC, conforme al l√≠mites establecidos por la Norma de Ordenaci√≥n N¬∞ 21, se√±alada en los Programas de Desarrollo Urbano.\",\r\n                                        \"* Se instrumentar√° un programa de reconversi√≥n de esta actividad por la producci√≥n de composta. Para ello, se elaborar√° un padr√≥n de los productores y dise√±ar y ejecutar un programa de capacitaci√≥n y proponer paquetes tecnol√≥gicos para transferencia y el desarrollo de estudios de mercado para la sustituci√≥n progresiva del producto y la reducci√≥n de la extracci√≥n directa.\"\r\n                                    ].map((note, idx) => (\r\n                                        <li key={idx} className=\"text-[10px] text-gray-500 leading-relaxed text-justify relative pl-3\">\r\n                                            <span className=\"absolute left-0 top-1.5 w-1 h-1 rounded-full bg-gray-300\"></span>\r\n                                            {note}\r\n                                        </li>\r\n                                    ))}\r\n                                </ul>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* 9. Disclaimer */}\r\n                <LegalDisclaimer />\r\n            </InView>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default ResultsContent;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jorge\\Documents\\consulta-de-predios-V3\\src\\components\\features\\PdfExportController.jsx","messages":[{"ruleId":"react/display-name","severity":2,"message":"Component definition is missing display name","line":88,"column":18,"nodeType":"CallExpression","messageId":"noDisplayName","endLine":618,"endColumn":3},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n  306 |                                     <tr>\n  307 |                                         <td style={{ verticalAlign: 'top', width: '50%', paddingRight: '15px', paddingBottom: '10px' }}>\n> 308 |                                             <PdfBox title=\"Entidad Federativa\">\n      |                                              ^^^^^^ This component is created during render\n  309 |                                                 {isOutside ? (outsideContextName || 'Otro Estado') : 'Ciudad de M√©xico'}\n  310 |                                             </PdfBox>\n  311 |                                         </td>\n\n  202 |     };\n  203 |\n> 204 |     const PdfBox = ({ title, children, style }) => (\n      |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 205 |         <div style={{ ...style }}>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 206 |             <div style={styleLabel}>{title}</div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 207 |             <div style={styleValue}>{children}</div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 208 |         </div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 209 |     );\n      | ^^^^^^ The component is created during render here\n  210 |\n  211 |     // Table Styles\n  212 |     const tblC = {","line":308,"column":46,"nodeType":null,"endLine":308,"endColumn":52},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n  311 |                                         </td>\n  312 |                                         <td style={{ verticalAlign: 'top', width: '50%', paddingBottom: '10px' }}>\n> 313 |                                             <PdfBox title=\"Coordenadas Geogr√°ficas\">\n      |                                              ^^^^^^ This component is created during render\n  314 |                                                 <span style={{ fontFamily: T.mono, fontSize: '11px', background: '#f3f4f6', padding: '4px 8px', borderRadius: '4px', display: 'inline-block' }}>\n  315 |                                                     {coordText}\n  316 |                                                 </span>\n\n  202 |     };\n  203 |\n> 204 |     const PdfBox = ({ title, children, style }) => (\n      |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 205 |         <div style={{ ...style }}>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 206 |             <div style={styleLabel}>{title}</div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 207 |             <div style={styleValue}>{children}</div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 208 |         </div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 209 |     );\n      | ^^^^^^ The component is created during render here\n  210 |\n  211 |     // Table Styles\n  212 |     const tblC = {","line":313,"column":46,"nodeType":null,"endLine":313,"endColumn":52},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n  323 |                                         <tr>\n  324 |                                             <td style={{ verticalAlign: 'top', paddingRight: '15px', paddingBottom: '10px' }}>\n> 325 |                                                 <PdfBox title=\"Alcald√≠a\">{analysis.alcaldia || 'N/D'}</PdfBox>\n      |                                                  ^^^^^^ This component is created during render\n  326 |                                             </td>\n  327 |                                             <td style={{ verticalAlign: 'top', paddingBottom: '10px' }}></td>\n  328 |                                         </tr>\n\n  202 |     };\n  203 |\n> 204 |     const PdfBox = ({ title, children, style }) => (\n      |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 205 |         <div style={{ ...style }}>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 206 |             <div style={styleLabel}>{title}</div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 207 |             <div style={styleValue}>{children}</div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 208 |         </div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 209 |     );\n      | ^^^^^^ The component is created during render here\n  210 |\n  211 |     // Table Styles\n  212 |     const tblC = {","line":325,"column":50,"nodeType":null,"endLine":325,"endColumn":56},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n  332 |                                     <tr>\n  333 |                                         <td colSpan=\"2\" style={{ verticalAlign: 'top', paddingBottom: '10px' }}>\n> 334 |                                             <PdfBox title=\"Direcci√≥n Aproximada / Lugar\">{direccion}</PdfBox>\n      |                                              ^^^^^^ This component is created during render\n  335 |                                         </td>\n  336 |                                     </tr>\n  337 |                                 </tbody>\n\n  202 |     };\n  203 |\n> 204 |     const PdfBox = ({ title, children, style }) => (\n      |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 205 |         <div style={{ ...style }}>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 206 |             <div style={styleLabel}>{title}</div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 207 |             <div style={styleValue}>{children}</div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 208 |         </div>\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 209 |     );\n      | ^^^^^^ The component is created during render here\n  210 |\n  211 |     // Table Styles\n  212 |     const tblC = {","line":334,"column":46,"nodeType":null,"endLine":334,"endColumn":52},{"ruleId":"no-async-promise-executor","severity":2,"message":"Promise executor functions should not be async.","line":739,"column":28,"nodeType":"Identifier","messageId":"async","endLine":739,"endColumn":33},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":749,"column":75,"nodeType":"BlockStatement","messageId":"unexpected","endLine":749,"endColumn":78,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[40489,40490],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":789,"column":35,"nodeType":"BlockStatement","messageId":"unexpected","endLine":789,"endColumn":38,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[42309,42310],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":851,"column":51,"nodeType":"BlockStatement","messageId":"unexpected","endLine":851,"endColumn":54,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[46403,46404],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-async-promise-executor","severity":2,"message":"Promise executor functions should not be async.","line":885,"column":28,"nodeType":"Identifier","messageId":"async","endLine":885,"endColumn":33}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport L from 'leaflet';\r\nimport leafletImage from 'leaflet-image';\r\nimport { jsPDF } from 'jspdf';\r\nimport 'jspdf-autotable';\r\nimport html2canvas from 'html2canvas';\r\nimport QRCode from 'qrcode';\r\n\r\nimport Icons from '../ui/Icons';\r\nimport { CONSTANTS } from '../../utils/constants';\r\nimport { getBaseLayerUrl, getZoningColor, formatDateTime, generateFolio } from '../../utils/geoUtils';\r\n\r\n/* ------------------------------------------------ */\r\n/* HELPERS INTERNOS */\r\n/* ------------------------------------------------ */\r\n\r\nconst getStaticMapUrl = ({ lat, lng, zoom = 14, width = 900, height = 520 }) => {\r\n    const clampedW = Math.min(Math.max(width, 300), 1280);\r\n    const clampedH = Math.min(Math.max(height, 200), 1280);\r\n    const overlay = `pin-s+9d2449(${lng},${lat})`;\r\n    const token = CONSTANTS.MAPBOX_TOKEN;\r\n\r\n    if (!token) return '';\r\n\r\n    return (\r\n        `https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/static/` +\r\n        `${overlay}/${lng},${lat},${zoom}/${clampedW}x${clampedH}` +\r\n        `?access_token=${token}&logo=false&attribution=false`\r\n    );\r\n};\r\n\r\nconst preloadImage = (src) =>\r\n    new Promise((resolve) => {\r\n        if (!src) return resolve(false);\r\n        const img = new Image();\r\n        img.crossOrigin = 'anonymous';\r\n        img.onload = () => resolve(true);\r\n        img.onerror = () => resolve(false);\r\n        img.src = src;\r\n    });\r\n\r\n/* ------------------------------------------------ */\r\n/* COMPONENTES DE APOYO */\r\n/* ------------------------------------------------ */\r\n\r\nconst QrCodeImg = ({ value, size = 74 }) => {\r\n    const [src, setSrc] = useState(null);\r\n\r\n    useEffect(() => {\r\n        if (!value) return;\r\n        // Generate QR as Data URL\r\n        QRCode.toDataURL(value, {\r\n            width: size,\r\n            margin: 0,\r\n            errorCorrectionLevel: 'M'\r\n        })\r\n            .then(url => {\r\n                setSrc(url);\r\n            })\r\n            .catch(err => {\r\n                console.error(\"QR Generation Error\", err);\r\n            });\r\n    }, [value, size]);\r\n\r\n    if (!value) return null;\r\n\r\n    if (src) {\r\n        return (\r\n            <img\r\n                src={src}\r\n                alt=\"QR visor\"\r\n                style={{\r\n                    width: size,\r\n                    height: size,\r\n                    border: '1px solid #e5e7eb',\r\n                    borderRadius: 6,\r\n                    display: 'block'\r\n                }}\r\n            />\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div style={{ width: size, height: size, border: '1px solid #e5e7eb', borderRadius: 6, background: '#f9fafb' }} />\r\n    );\r\n};\r\n\r\nconst PdfFicha = React.forwardRef(({ analysis, mapImage, includeActivities = true, approximateAddress }, ref) => {\r\n    if (!analysis) return null;\r\n\r\n    const { COLORS, REGULATORY_NOTES, ZONING_CAT_INFO } = CONSTANTS;\r\n\r\n    const fecha = formatDateTime(analysis.timestamp || new Date());\r\n    // Folio includes seconds now (14 chars: YYYYMMDDHHmmss)\r\n    const folio = generateFolio ? generateFolio() : `F-${new Date().toISOString().replace(/[-:T.Z]/g, '').slice(0, 14)}`;\r\n\r\n    const isUrban = analysis.status === 'URBAN_SOIL';\r\n    const isSC = analysis.status === 'CONSERVATION_SOIL';\r\n    const isOutside = analysis.status === 'OUTSIDE_CDMX';\r\n    const outsideContextName = analysis.outsideContext || null;\r\n    const isANP = analysis.isANP || analysis.zoningKey === 'ANP';\r\n\r\n    const statusLabel =\r\n        isSC ? 'Suelo de Conservaci√≥n' :\r\n            isUrban ? 'Suelo Urbano' :\r\n                isOutside ? 'Fuera de la Ciudad de M√©xico' :\r\n                    'Informaci√≥n no disponible';\r\n\r\n    const direccion =\r\n        approximateAddress ||\r\n        analysis.address ||\r\n        analysis.placeName ||\r\n        analysis.label ||\r\n        'Sin direcci√≥n disponible (consulta por coordenadas).';\r\n\r\n    const coordText = `${analysis.coordinate.lat.toFixed(5)}, ${analysis.coordinate.lng.toFixed(5)}`;\r\n    const visorUrl = `${window.location.origin}${window.location.pathname}?lat=${analysis.coordinate.lat}&lng=${analysis.coordinate.lng}&open=1`;\r\n\r\n    const detalleProhibidas = analysis.prohibitedActivities || [];\r\n    const detallePermitidas = analysis.allowedActivities || [];\r\n\r\n    // Zoning Logic\r\n    let zoningColor = '#6b7280';\r\n    if (isANP) {\r\n        zoningColor = COLORS?.anp || '#9d2148';\r\n    } else if (analysis.zoningKey === 'NODATA') {\r\n        zoningColor = '#9ca3af';\r\n    } else if (analysis.zoningKey && getZoningColor) {\r\n        zoningColor = getZoningColor(analysis.zoningKey);\r\n    }\r\n\r\n    // Resolve Friendly Name using Map if available, else fallback to zoningName\r\n    let friendlyName = analysis.zoningName || 'Sin informaci√≥n';\r\n    if (ZONING_CAT_INFO && analysis.zoningKey && ZONING_CAT_INFO[analysis.zoningKey]?.label) {\r\n        friendlyName = ZONING_CAT_INFO[analysis.zoningKey].label;\r\n    }\r\n\r\n    const zoningDisplay = isANP ? '√ÅREA NATURAL PROTEGIDA' :\r\n        analysis.zoningKey === 'NODATA' ? 'Informaci√≥n no disponible' :\r\n            friendlyName;\r\n\r\n    const T = {\r\n        font: 'Roboto, Arial, sans-serif',\r\n        mono: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace',\r\n        base: 10,       // Reduced slightly for density\r\n        small: 8.5,\r\n        micro: 7.5,\r\n        h1: 15,         // Larger Header\r\n        h2: 12,\r\n        lead: 10,\r\n        lh: 1.2\r\n    };\r\n\r\n    const S = {\r\n        pageW: 794,\r\n        pagePad: 30,    // Increased margins\r\n        gap1: 5,\r\n        gap2: 12,\r\n        gap3: 20,\r\n        radius: 4,\r\n        hair: '1px solid #d1d5db' // Slightly darker hair\r\n    };\r\n\r\n    // OFFICIAL PALETTE (Based on InstitutionalHeader)\r\n    const C = {\r\n        ink: '#333333',     // Dark Gray (Gris Oscuro)\r\n        sub: '#666666',     // Medium Gray\r\n        guinda: '#9D2449',  // Guinda Oficial\r\n        dorado: '#D4C19C',  // Dorado Oficial\r\n        gris: '#B38E5D',    // (Variant, using Dorado/Gris blend usually, adhering to header usage)\r\n        hair: '#d1d5db',\r\n        panel: '#f8f9fa',\r\n        sc: '#3B7D23',\r\n        su: '#2563EB',      // Brighter Blue for digital\r\n        red: '#B91C1C',\r\n        green: '#15803D'\r\n    };\r\n\r\n    const styleH2 = {\r\n        fontSize: `${T.h2}px`,\r\n        fontWeight: 700,\r\n        color: C.guinda,\r\n        borderBottom: `2px solid ${C.dorado}`,\r\n        paddingBottom: '4px',\r\n        marginBottom: `${S.gap2}px`,\r\n        textTransform: 'uppercase',\r\n        letterSpacing: '0.05em'\r\n    };\r\n\r\n    const styleLabel = {\r\n        fontSize: `${T.small}px`,\r\n        color: C.sub,\r\n        fontWeight: 600,\r\n        textTransform: 'uppercase',\r\n        marginBottom: '2px'\r\n    };\r\n\r\n    const styleValue = {\r\n        fontSize: `${T.base}px`,\r\n        color: C.ink,\r\n        fontWeight: 400\r\n    };\r\n\r\n    const PdfBox = ({ title, children, style }) => (\r\n        <div style={{ ...style }}>\r\n            <div style={styleLabel}>{title}</div>\r\n            <div style={styleValue}>{children}</div>\r\n        </div>\r\n    );\r\n\r\n    // Table Styles\r\n    const tblC = {\r\n        width: '100%',\r\n        borderCollapse: 'collapse',\r\n        fontSize: `${T.small}px`\r\n    };\r\n    const thC = {\r\n        textAlign: 'left',\r\n        padding: '6px 8px',\r\n        borderBottom: `2px solid ${C.dorado}`,\r\n        color: C.guinda,\r\n        fontWeight: 700,\r\n        verticalAlign: 'bottom'\r\n    };\r\n    const tdC = (i) => ({\r\n        padding: '6px 8px',\r\n        borderBottom: `1px solid ${C.hair}`,\r\n        backgroundColor: i % 2 === 0 ? '#fff' : '#f9fafb',\r\n        color: C.ink,\r\n        verticalAlign: 'top'\r\n    });\r\n\r\n    // --- CITIZEN SUMMARY LOGIC ---\r\n    const getExplanation = () => {\r\n        const { status, zoningKey, isANP, alcaldia } = analysis;\r\n        if (status === 'OUTSIDE_CDMX') {\r\n            const estado = analysis.outsideContext || 'otro estado';\r\n            return `La ubicaci√≥n consultada se localiza en el ${estado}. Las regulaciones de la Ciudad de M√©xico no aplican en este territorio. La determinaci√≥n normativa corresponde a las autoridades locales del ${estado}.`;\r\n        }\r\n        if (status === 'URBAN_SOIL') {\r\n            if (isANP) return `Aunque es zona urbana, este punto est√° dentro de una √Årea Natural Protegida. Esto significa que la prioridad es el medio ambiente y aplican reglas especiales de conservaci√≥n por encima de las normas urbanas comunes.`;\r\n            return `Te encuentras en Suelo Urbano. Aqu√≠ predominan las actividades residenciales, comerciales y de servicios. Las reglas de construcci√≥n dependen de la SEDUVI y del Plan de Desarrollo Urbano de ${alcaldia || 'la alcald√≠a'}.`;\r\n        }\r\n        if (status === 'CONSERVATION_SOIL') {\r\n            if (isANP) return `¬°Est√°s en una zona muy importante! Este punto es parte de una √Årea Natural Protegida (ANP). Su objetivo principal es preservar la biodiversidad. Aqu√≠ las construcciones est√°n muy restringidas y se sigue un Plan de Manejo espec√≠fico.`;\r\n            switch (zoningKey) {\r\n                case 'RE': return `Est√°s en una zona de Rescate Ecol√≥gico. Estas √°reas han sido afectadas por actividades humanas pero buscamos restaurarlas. La prioridad es reforestar y evitar que la mancha urbana crezca m√°s.`;\r\n                case 'FC': case 'FCE': case 'FP': case 'FPE': return `Est√°s en una zona Forestal. Es el pulm√≥n de la ciudad. Aqu√≠ la prioridad absoluta es mantener el bosque sano. Pr√°cticamente no se permite construir viviendas ni comercios para proteger el agua y el aire de todos.`;\r\n                case 'PR': case 'PRA': return `Est√°s en una zona de Producci√≥n Rural. Aqu√≠ se fomenta la agricultura y la agroindustria tradicional. Se permiten actividades del campo, pero no fraccionamientos residenciales urbanos.`;\r\n                case 'AE': case 'AEE': case 'AF': case 'AFE': return `Est√°s en una zona Agroecol√≥gica. Se busca un equilibrio entre la agricultura tradicional y el cuidado de la naturaleza. Puedes cultivar la tierra, siempre y cuando uses t√©cnicas amigables con el medio ambiente.`;\r\n                case 'PDU_ER': return `Est√°s en una zona de Equipamiento Rural. Aqu√≠ se permiten instalaciones necesarias para la comunidad rural, como escuelas, centros de salud o deportivos, siempre bajo reglas estrictas.`;\r\n                case 'PDU_PR': return `Est√°s en un Poblado Rural. Es una comunidad hist√≥rica dentro del suelo de conservaci√≥n. Tienen reglas especiales que permiten vivienda y comercio local, pero siempre limitando el crecimiento hacia el bosque.`;\r\n                default: return `Te encuentras en Suelo de Conservaci√≥n. Es la reserva ecol√≥gica de la ciudad (bosques, humedales, zonas agr√≠colas). Aqu√≠ no aplican las normas urbanas comunes y el objetivo es evitar la urbanizaci√≥n para proteger los servicios ambientales.`;\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n    const summaryText = getExplanation();\r\n\r\n    return (\r\n        <div\r\n            ref={ref}\r\n            style={{\r\n                width: `${S.pageW}px`,\r\n                minHeight: '1080px', // A4 Height Context\r\n                padding: `40px 50px`, // Extended margins\r\n                fontFamily: T.font,\r\n                fontSize: `${T.base}px`,\r\n                lineHeight: T.lh,\r\n                color: C.ink,\r\n                backgroundColor: '#ffffff',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                justifyContent: 'space-between', // Footer push\r\n                boxSizing: 'border-box'\r\n            }}\r\n        >\r\n            <div>\r\n                {/* --- HEADER --- */}\r\n                <div id=\"pdf-header-row\" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end', marginBottom: '35px', borderBottom: `2px solid ${C.dorado}`, paddingBottom: '15px' }}>\r\n                    <div style={{ display: 'flex', flexDirection: 'column' }}>\r\n                        <img src={`${import.meta.env.BASE_URL}assets/logo-sedema.png`} alt=\"SEDEMA\" style={{ height: '65px', objectFit: 'contain', display: 'block', marginBottom: '10px' }} />\r\n                    </div>\r\n                    <div style={{ textAlign: 'right' }}>\r\n                        <div style={{ fontSize: '18px', fontWeight: 900, color: C.guinda, textTransform: 'uppercase', lineHeight: 1 }}>\r\n                            Ficha Informativa\r\n                        </div>\r\n                        <div style={{ fontSize: '12px', color: C.sub, marginTop: '4px', fontStyle: 'italic', marginBottom: '8px' }}>\r\n                            Consulta Ciudadana de Zonificaci√≥n\r\n                        </div>\r\n                        <div style={{ fontSize: '10px', color: C.ink, lineHeight: 1.4 }}>\r\n                            <div style={{ marginBottom: '2px' }}><strong>Folio:</strong> <span style={{ fontFamily: T.mono }}>{folio}</span></div>\r\n                            <div><strong>Fecha:</strong> {fecha}</div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* --- SECTION 1: UBICACI√ìN --- */}\r\n                <div style={{ marginBottom: '40px' }}>\r\n                    <div style={styleH2}>Ubicaci√≥n del Punto</div>\r\n                    <div style={{ display: 'flex', gap: '30px', alignItems: 'flex-start' }}>\r\n                        <div style={{ flex: '1' }}>\r\n                            <table style={{ width: '100%', borderCollapse: 'collapse', tableLayout: 'fixed' }}>\r\n                                <tbody>\r\n                                    {/* Row 1: Entidad & Coordenadas */}\r\n                                    <tr>\r\n                                        <td style={{ verticalAlign: 'top', width: '50%', paddingRight: '15px', paddingBottom: '10px' }}>\r\n                                            <PdfBox title=\"Entidad Federativa\">\r\n                                                {isOutside ? (outsideContextName || 'Otro Estado') : 'Ciudad de M√©xico'}\r\n                                            </PdfBox>\r\n                                        </td>\r\n                                        <td style={{ verticalAlign: 'top', width: '50%', paddingBottom: '10px' }}>\r\n                                            <PdfBox title=\"Coordenadas Geogr√°ficas\">\r\n                                                <span style={{ fontFamily: T.mono, fontSize: '11px', background: '#f3f4f6', padding: '4px 8px', borderRadius: '4px', display: 'inline-block' }}>\r\n                                                    {coordText}\r\n                                                </span>\r\n                                            </PdfBox>\r\n                                        </td>\r\n                                    </tr>\r\n\r\n                                    {/* Row 2: Alcaldia (Conditional) */}\r\n                                    {!isOutside && (\r\n                                        <tr>\r\n                                            <td style={{ verticalAlign: 'top', paddingRight: '15px', paddingBottom: '10px' }}>\r\n                                                <PdfBox title=\"Alcald√≠a\">{analysis.alcaldia || 'N/D'}</PdfBox>\r\n                                            </td>\r\n                                            <td style={{ verticalAlign: 'top', paddingBottom: '10px' }}></td>\r\n                                        </tr>\r\n                                    )}\r\n\r\n                                    {/* Row 3: Direccion (Full width) */}\r\n                                    <tr>\r\n                                        <td colSpan=\"2\" style={{ verticalAlign: 'top', paddingBottom: '10px' }}>\r\n                                            <PdfBox title=\"Direcci√≥n Aproximada / Lugar\">{direccion}</PdfBox>\r\n                                        </td>\r\n                                    </tr>\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                        {/* --- MAP --- */}\r\n                        <div style={{ flex: '0 0 320px' }}>\r\n                            <div style={{\r\n                                border: `1px solid ${C.hair}`,\r\n                                height: '200px',\r\n                                backgroundColor: '#f3f4f6',\r\n                                borderRadius: '6px',\r\n                                overflow: 'hidden',\r\n                                position: 'relative',\r\n                                boxShadow: '0 2px 4px rgba(0,0,0,0.05)'\r\n                            }}>\r\n                                {mapImage ? (\r\n                                    <img src={mapImage} style={{ width: '100%', height: '100%', objectFit: 'cover' }} alt=\"Mapa\" />\r\n                                ) : (\r\n                                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: C.sub, fontSize: '11px', flexDirection: 'column', gap: '5px' }}>\r\n                                        <div className=\"animate-pulse bg-gray-200 w-full h-full\"></div>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                            <div style={{ marginTop: '8px', fontSize: '9px', color: C.sub, textAlign: 'center', fontStyle: 'italic' }}>\r\n                                * Ubicaci√≥n referencial\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* --- SECTION 2: NORMATIVIDAD --- */}\r\n                <div style={{ marginBottom: `${S.gap3}px` }}>\r\n                    <div style={styleH2}>Normatividad Aplicable</div>\r\n\r\n                    {isOutside ? (\r\n                        <div style={{ background: '#FFF5F5', padding: '20px', borderRadius: '6px', border: `1px solid ${C.red}`, textAlign: 'center' }}>\r\n                            <div style={{ fontSize: '14px', fontWeight: 800, color: C.red, marginBottom: '10px', textTransform: 'uppercase' }}>\r\n                                Fuera de Jurisdicci√≥n de la CDMX\r\n                            </div>\r\n                            <div style={{ fontSize: '11px', color: C.ink, lineHeight: 1.5, maxWidth: '600px', margin: '0 auto' }}>\r\n                                El punto consultado no se encuentra dentro del territorio de la Ciudad de M√©xico.\r\n                                La Secretar√≠a del Medio Ambiente de la CDMX no tiene atribuciones para determinar la normatividad urbana o ambiental en esta ubicaci√≥n.\r\n                                <br /><br />\r\n                                Le sugerimos consultar a las autoridades estatales o municipales correspondientes de <strong>{outsideContextName || 'la entidad federativa respectiva'}</strong>.\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px', marginBottom: '15px' }}>\r\n                            {/* COL 1: SUELO */}\r\n                            <div style={{ background: C.panel, padding: '16px', borderRadius: '6px', border: `1px solid ${C.hair}` }}>\r\n                                <div style={{ fontSize: '11px', fontWeight: 700, color: C.sub, textTransform: 'uppercase', marginBottom: '8px', borderBottom: '1px solid #e5e7eb', paddingBottom: '4px' }}>Clasificaci√≥n de Suelo</div>\r\n                                <div style={{ fontSize: '15px', fontWeight: 800, color: isSC ? C.sc : isUrban ? C.su : C.red, lineHeight: 1.3 }}>\r\n                                    {statusLabel}\r\n                                </div>\r\n                                {isSC && (\r\n                                    <div style={{ fontSize: '10px', color: C.green, marginTop: '6px', fontStyle: 'italic' }}>\r\n                                        Regulado por el PGOEDF 2000\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* COL 2: ZONIFICACION / ANP */}\r\n                            {/* COL 2: ZONIFICACION / ANP (STACKED IF BOTH EXIST) */}\r\n                            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>\r\n\r\n                                {/* 1. ZONIFICATION SPECIFIC (Show if exists and is NOT just the ANP fallback) */}\r\n                                {analysis.zoningKey && analysis.zoningKey !== 'ANP' && (\r\n                                    <div>\r\n                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n                                            <div style={{ width: '12px', height: '12px', background: zoningColor, border: '1px solid #999', flexShrink: 0 }}></div>\r\n                                            <div style={{ fontSize: '12px', fontWeight: 800, color: C.ink, lineHeight: 1.2 }}>\r\n                                                {zoningDisplay}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {/* 2. REGIMEN ANP */}\r\n                                {isANP && (\r\n                                    <div style={{ background: '#FAF5FF', padding: '12px', borderRadius: '4px', border: `1px solid #7E22CE` }}>\r\n                                        <div style={{ fontSize: '10px', fontWeight: 700, color: '#7E22CE', textTransform: 'uppercase', marginBottom: '8px', borderBottom: `1px solid #E9D5FF`, paddingBottom: '4px' }}>R√©gimen ANP</div>\r\n\r\n                                        <div style={{ marginBottom: '6px' }}>\r\n                                            <div style={{ fontSize: '9px', fontWeight: 700, color: C.sub, textTransform: 'uppercase' }}>Nombre Oficial</div>\r\n                                            <div style={{ fontSize: '11px', fontWeight: 800, color: C.ink }}>{analysis.anpNombre || analysis.zoningName || '√Årea Natural Protegida'}</div>\r\n                                        </div>\r\n\r\n                                        <div style={{ marginBottom: '6px' }}>\r\n                                            <div style={{ fontSize: '9px', fontWeight: 700, color: C.sub, textTransform: 'uppercase' }}>Categor√≠a</div>\r\n                                            <div style={{ fontSize: '10px', color: C.ink }}>{analysis.anpCategoria || 'No disponible'}</div>\r\n                                        </div>\r\n\r\n                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '4px', marginBottom: '8px' }}>\r\n                                            <div>\r\n                                                <div style={{ fontSize: '8px', fontWeight: 700, color: C.sub, textTransform: 'uppercase' }}>Decreto</div>\r\n                                                <div style={{ fontSize: '10px', color: C.ink }}>{analysis.anpTipoDecreto || 'N/D'}</div>\r\n                                            </div>\r\n                                            <div>\r\n                                                <div style={{ fontSize: '8px', fontWeight: 700, color: C.sub, textTransform: 'uppercase' }}>Fecha</div>\r\n                                                <div style={{ fontSize: '10px', color: C.ink }}>{analysis.anpFechaDecreto || 'N/D'}</div>\r\n                                            </div>\r\n                                            <div>\r\n                                                <div style={{ fontSize: '8px', fontWeight: 700, color: C.sub, textTransform: 'uppercase' }}>Superficie</div>\r\n                                                <div style={{ fontSize: '10px', color: C.ink }}>{analysis.anpSupDecretada ? `${analysis.anpSupDecretada} ha` : 'N/D'}</div>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        {/* MANAGEMENT PROGRAM LINK */}\r\n                                        <div style={{ marginTop: '8px', borderTop: '1px solid #E9D5FF', paddingTop: '6px' }}>\r\n                                            <div style={{ fontSize: '8px', fontWeight: 700, color: C.sub, textTransform: 'uppercase' }}>Programa de Manejo</div>\r\n                                            <div style={{ fontSize: '9px', color: '#2563EB', wordBreak: 'break-all' }}>\r\n                                                {analysis.anpUrl ? analysis.anpUrl : 'Consulte en: sedema.cdmx.gob.mx/programas'}\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div style={{ fontSize: '10px', color: '#7E22CE', fontStyle: 'italic', lineHeight: 1.3, fontWeight: 500 }}>\r\n                                            √Årea Natural Protegida: Este punto se encuentra dentro de un ANP y se rige por su Programa de Manejo.\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* --- RESUMEN NORMATIVO (CITIZEN SUMMARY) --- */}\r\n                    {summaryText && !isOutside && (\r\n                        <div style={{\r\n                            marginBottom: '15px',\r\n                            background: isOutside ? 'linear-gradient(to bottom right, #fef2f2, #ffffff)' : 'linear-gradient(to bottom right, #eff6ff, #ffffff)',\r\n                            padding: '16px',\r\n                            borderRadius: '8px',\r\n                            border: isOutside ? '1px solid #fca5a5' : '1px solid #bfdbfe',\r\n                            display: 'flex',\r\n                            gap: '12px'\r\n                        }}>\r\n                            <div style={{\r\n                                flexShrink: 0,\r\n                                width: '24px',\r\n                                height: '24px',\r\n                                background: isOutside ? '#fee2e2' : '#dbeafe',\r\n                                borderRadius: '50%',\r\n                                color: isOutside ? '#b91c1c' : '#2563eb',\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                justifyContent: 'center',\r\n                                fontFamily: 'serif',\r\n                                fontSize: '14px',\r\n                                fontWeight: 'bold',\r\n                                lineHeight: 1\r\n                            }}>\r\n                                {isOutside ? '!' : 'i'}\r\n                            </div>\r\n                            <div>\r\n                                {!isOutside && (\r\n                                    <div style={{ fontSize: '11px', fontWeight: 800, color: '#2563eb', textTransform: 'uppercase', marginBottom: '4px' }}>\r\n                                        Resumen Normativo\r\n                                    </div>\r\n                                )}\r\n                                <div style={{ fontSize: '12px', color: isOutside ? '#991b1b' : '#1e3a8a', lineHeight: 1.5, fontWeight: 500 }}>\r\n                                    {summaryText}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n\r\n\r\n                    {/* --- INSTRUMENTO RECTOR (Urban Only) --- */}\r\n                    {!isOutside && isUrban && !isANP && !isSC && (\r\n                        <div style={{ marginTop: '15px', background: C.panel, padding: '16px', borderRadius: '6px', border: `1px solid ${C.hair}` }}>\r\n                            <div style={{ fontSize: '11px', fontWeight: 700, color: C.sub, textTransform: 'uppercase', marginBottom: '8px', borderBottom: '1px solid #e5e7eb', paddingBottom: '4px' }}>Instrumento Rector</div>\r\n                            <div style={{ fontSize: '13px', fontWeight: 800, color: C.ink, marginBottom: '6px' }}>\r\n                                Programa Delegacional de Desarrollo Urbano\r\n                            </div>\r\n                            <div style={{ fontSize: '10px', color: C.ink, marginBottom: '10px', lineHeight: 1.4 }}>\r\n                                Instrumento de planeaci√≥n urbana que establece los usos, reservas y destinos del suelo.\r\n                            </div>\r\n                            <div style={{ display: 'flex', gap: '15px' }}>\r\n                                <div style={{ fontSize: '10px', color: C.su, fontWeight: 700, textDecoration: 'underline' }}>\r\n                                    Ver Programas Delegacionales\r\n                                </div>\r\n                                <div style={{ fontSize: '10px', color: C.su, fontWeight: 700, textDecoration: 'underline' }}>\r\n                                    Ver Programas Parciales (Zonas Especiales)\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* ANP INTERNA */}\r\n                    {analysis.hasInternalAnpZoning && analysis.anpInternalFeature && (\r\n                        <div style={{ marginTop: '10px', padding: '10px', border: `1px solid #7E22CE`, background: '#FAF5FF', borderRadius: '4px' }}>\r\n                            <div style={{ fontSize: '11px', fontWeight: 700, color: '#7E22CE', textTransform: 'uppercase', marginBottom: '4px' }}>Zonificaci√≥n Interna ANP</div>\r\n                            <div style={{ fontSize: '9px', color: C.sub, textTransform: 'uppercase' }}>Zonificaci√≥n Programa de Manejo</div>\r\n                            <div style={{ fontSize: '12px', fontWeight: 800, color: C.heading, marginBottom: '6px' }}>\r\n                                {analysis.anpInternalFeature.properties?.ZONIFICACION || analysis.anpInternalFeature.properties?.CATEGORIA_PROTECCION || 'Zonificaci√≥n Espec√≠fica'}\r\n                            </div>\r\n                            <div style={{ fontSize: '10px', color: '#7E22CE', fontStyle: 'italic', fontWeight: 500 }}>\r\n                                √Årea Natural Protegida: Este punto se encuentra dentro de un ANP y se rige por su Programa de Manejo.\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* --- SECTION 3: ACTIVIDADES (Solo SC) --- */}\r\n                {/* CONDITIONAL RENDER: Only if includeActivities is TRUE */}\r\n                {includeActivities && isSC && !isANP && !analysis.isPDU && !analysis.noActivitiesCatalog && (\r\n                    <div>\r\n                        <div style={styleH2}>Cat√°logo de Actividades (Suelo de Conservaci√≥n)</div>\r\n\r\n                        <div style={{ marginBottom: '15px' }}>\r\n                            <div style={{ fontSize: '11px', fontWeight: 700, color: C.green, marginBottom: '6px', textTransform: 'uppercase' }}>Permitidas</div>\r\n                            {detallePermitidas.length === 0 ? (\r\n                                <div style={{ fontSize: '10px', fontStyle: 'italic', color: C.sub }}>Sin actividades permitidas espec√≠ficas listadas.</div>\r\n                            ) : (\r\n                                <table style={tblC}>\r\n                                    <thead>\r\n                                        <tr>\r\n                                            <th style={{ ...thC, color: C.green, borderBottomColor: C.green }}>Actividad</th>\r\n                                            <th style={{ ...thC, color: C.green, borderBottomColor: C.green }}>Detalle</th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody>\r\n                                        {detallePermitidas.map((a, i) => (\r\n                                            <tr key={i}>\r\n                                                <td style={tdC(i)} width=\"40%\"><strong>{a.general}</strong></td>\r\n                                                <td style={tdC(i)}>{a.specific}</td>\r\n                                            </tr>\r\n                                        ))}\r\n                                    </tbody>\r\n                                </table>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div>\r\n                            <div style={{ fontSize: '11px', fontWeight: 700, color: C.red, marginBottom: '6px', textTransform: 'uppercase' }}>Prohibidas</div>\r\n                            {detalleProhibidas.length === 0 ? (\r\n                                <div style={{ fontSize: '10px', fontStyle: 'italic', color: C.sub }}>Sin actividades prohibidas espec√≠ficas listadas.</div>\r\n                            ) : (\r\n                                <table style={tblC}>\r\n                                    <thead>\r\n                                        <tr>\r\n                                            <th style={{ ...thC, color: C.red, borderBottomColor: C.red }}>Actividad</th>\r\n                                            <th style={{ ...thC, color: C.red, borderBottomColor: C.red }}>Detalle</th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody>\r\n                                        {detalleProhibidas.map((a, i) => (\r\n                                            <tr key={i}>\r\n                                                <td style={tdC(i)} width=\"40%\"><strong>{a.general}</strong></td>\r\n                                                <td style={tdC(i)}>{a.specific}</td>\r\n                                            </tr>\r\n                                        ))}\r\n                                    </tbody>\r\n                                </table>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* --- FOOTER --- */}\r\n                <div style={{ marginTop: 'auto', paddingTop: '20px', borderTop: `1px solid ${C.dorado}` }}>\r\n                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '20px' }}>\r\n                        <div style={{ flex: '1' }}>\r\n                            <div style={{ fontSize: '9px', color: C.sub, textAlign: 'justify', lineHeight: 1.4, marginBottom: '5px' }}>\r\n                                <strong>Aviso Importante:</strong> Este documento es de car√°cter informativo y orientativo. No constituye un dictamen legal ni sustituye a los Certificados de Zonificaci√≥n de Uso del Suelo o Tr√°mites oficiales ante la SEDEMA o SEDUVI. La informaci√≥n presentada se basa en las capas geogr√°ficas vigentes en el Visor Ciudadano.\r\n                            </div>\r\n                            <div style={{ fontSize: '9px', color: C.sub }}>\r\n                                Para tr√°mites oficiales, acuda a la Ventanilla √önica de la SEDEMA.\r\n                            </div>\r\n                        </div>\r\n                        <div style={{ width: '120px', textAlign: 'right', display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '5px' }}>\r\n                            <div style={{ fontSize: '9px', fontWeight: 700, color: C.ink }}>\r\n                                Escanear para validar &rarr;\r\n                            </div>\r\n                            <QrCodeImg value={visorUrl} size={60} />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n        </div >\r\n    );\r\n});\r\n\r\nconst PdfExportController = ({\r\n    analysis,\r\n    onExportReady,\r\n    onProgress,\r\n    dataCache,\r\n    visibleMapLayers,\r\n    activeBaseLayer,\r\n    visibleZoningCats,\r\n    currentZoom = 14,\r\n    approximateAddress\r\n}) => {\r\n    // Direct Access to Constants (imported)\r\n    const { ZONING_ORDER, LAYER_STYLES, ZONING_CAT_INFO } = CONSTANTS;\r\n\r\n    const [mapImage, setMapImage] = useState(null);\r\n    // HYBRID MODE STATE: Controls if tables are shown in DOM for capture\r\n    const [includeActivities, setIncludeActivities] = useState(true);\r\n\r\n    const pdfRef = useRef(null);\r\n    const exportArmedRef = useRef(false);\r\n    const exportMapInstance = useRef(null);\r\n\r\n    // --- A. DIAGNOSTICS & HELPERS ---\r\n\r\n    // Helper for Grouping Table Rows\r\n    const processGroupedData = (items) => {\r\n        if (!items || !items.length) return [];\r\n        // Sort by General Activity to ensure adjacency\r\n        const sorted = [...items].sort((a, b) => (a.general || '').localeCompare(b.general || ''));\r\n\r\n        const resultRows = [];\r\n        let sameCount = 0;\r\n\r\n        for (let i = 0; i < sorted.length; i++) {\r\n            const gen = sorted[i].general || '';\r\n            const spec = sorted[i].specific || '';\r\n\r\n            // Look ahead to count identicals\r\n            if (i === 0 || gen !== (sorted[i - 1].general || '')) {\r\n                // New Group\r\n                let count = 1;\r\n                for (let j = i + 1; j < sorted.length; j++) {\r\n                    if ((sorted[j].general || '') === gen) count++;\r\n                    else break;\r\n                }\r\n                // Push First Row of Group\r\n                resultRows.push([\r\n                    { content: gen, rowSpan: count, styles: { valign: 'middle', fontStyle: 'bold' } },\r\n                    spec\r\n                ]);\r\n            } else {\r\n                // Subsequent row of same group\r\n                resultRows.push([spec]);\r\n            }\r\n        }\r\n        return resultRows;\r\n    };\r\n\r\n    const waitForMapReady = (map) => {\r\n        return new Promise((resolve) => {\r\n            let tilesLoaded = false;\r\n            map.on('load', () => { tilesLoaded = true; });\r\n            if (map._loaded) tilesLoaded = true;\r\n\r\n            // Optimized check loop\r\n            let attempts = 0;\r\n            const check = () => {\r\n                attempts++;\r\n                map.invalidateSize(true);\r\n\r\n                // If tiles loaded, wait a brief moment for render (300ms vs 800ms)\r\n                if (tilesLoaded) {\r\n                    setTimeout(() => resolve(true), 300);\r\n                    return;\r\n                }\r\n\r\n                // Max waits: 20 attempts * 100ms = 2000ms max\r\n                if (attempts > 20) {\r\n                    resolve(true); // Force proceed\r\n                    return;\r\n                }\r\n                setTimeout(check, 100);\r\n            };\r\n\r\n            // Backup safety timer reduced from 4000ms to 2500ms\r\n            setTimeout(() => resolve(true), 2500);\r\n            check();\r\n        });\r\n    };\r\n\r\n    const waitForImgLoaded = (container, selector) => {\r\n        return new Promise((resolve) => {\r\n            const img = container.querySelector(selector);\r\n            if (!img) return resolve(true);\r\n            if (img.complete && img.naturalHeight !== 0) return resolve(true);\r\n            img.onload = () => resolve(true);\r\n            img.onerror = () => resolve(true);\r\n            setTimeout(() => resolve(true), 1500);\r\n        });\r\n    };\r\n\r\n    const loadLogoData = async () => {\r\n        return new Promise(resolve => {\r\n            const img = new Image();\r\n            img.crossOrigin = 'Anonymous';\r\n            img.onload = () => {\r\n                const c = document.createElement('canvas');\r\n                c.width = img.width;\r\n                c.height = img.height;\r\n                const ctx = c.getContext('2d');\r\n                ctx.drawImage(img, 0, 0);\r\n                resolve(c.toDataURL('image/png'));\r\n            };\r\n            img.onerror = () => resolve(null);\r\n            img.src = `${import.meta.env.BASE_URL}assets/logo-sedema.png`; // Local asset\r\n        });\r\n    };\r\n\r\n    const buildExportMapImage = ({ lat, lng, zoom, analysisStatus, isANP }) => {\r\n        return new Promise(async (resolve) => {\r\n            try {\r\n                // L and leafletImage imported\r\n\r\n                if (!L || typeof leafletImage !== 'function') return resolve(null);\r\n\r\n                const el = document.getElementById('export-map');\r\n                if (!el) return resolve(null);\r\n\r\n                if (exportMapInstance.current) {\r\n                    try { exportMapInstance.current.remove(); } catch (e) { }\r\n                    exportMapInstance.current = null;\r\n                }\r\n                el.innerHTML = '';\r\n\r\n                // Create map off-screen\r\n                const m = L.map(el, {\r\n                    zoomControl: false, attributionControl: false, preferCanvas: true,\r\n                    fadeAnimation: false, zoomAnimation: false, markerZoomAnimation: false\r\n                }).setView([lat, lng], zoom);\r\n\r\n                exportMapInstance.current = m;\r\n\r\n                const baseLayerUrl = (typeof getBaseLayerUrl === 'function')\r\n                    ? getBaseLayerUrl(activeBaseLayer || 'SATELLITE')\r\n                    : 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';\r\n\r\n                // Force fast loading options\r\n                const base = L.tileLayer(baseLayerUrl, {\r\n                    crossOrigin: 'anonymous',\r\n                    maxZoom: 19,\r\n                    updateWhenIdle: false, // Load immediately\r\n                    updateWhenZooming: false,\r\n                    keepBuffer: 2\r\n                }).addTo(m);\r\n\r\n                const createPane = (name, zIndex) => {\r\n                    if (!m.getPane(name)) m.createPane(name);\r\n                    m.getPane(name).style.zIndex = zIndex;\r\n                    return name;\r\n                };\r\n\r\n                const contextPane = createPane('contextPane', 400);\r\n                const overlayPane = createPane('overlayPane', 450);\r\n                const markerPane = createPane('markerPane', 600);\r\n\r\n                const addGeoJson = (fc, style, pane) => {\r\n                    try {\r\n                        if (!fc?.features?.length) return;\r\n                        L.geoJSON(fc, { pane, style, interactive: false }).addTo(m);\r\n                    } catch (err) { }\r\n                };\r\n\r\n                // --- LAYERS ---\r\n                if (visibleMapLayers?.alcaldias && dataCache?.alcaldias) {\r\n                    addGeoJson(dataCache.alcaldias, { color: '#ffffff', weight: 3, dashArray: '8,4', opacity: 0.9, fillOpacity: 0 }, contextPane);\r\n                }\r\n                if (visibleMapLayers?.sc && dataCache?.sc) {\r\n                    addGeoJson(dataCache.sc, { color: LAYER_STYLES?.sc?.color || 'green', weight: 1.8, opacity: 0.9, fillColor: LAYER_STYLES?.sc?.fill, fillOpacity: 0.18 }, overlayPane);\r\n                }\r\n                if (visibleMapLayers?.anp && dataCache?.anp) {\r\n                    addGeoJson(dataCache.anp, { color: LAYER_STYLES?.anp?.color || '#9333ea', weight: 2, opacity: 1, fillColor: LAYER_STYLES?.anp?.fill || '#9333ea', fillOpacity: 0.2 }, overlayPane);\r\n                }\r\n                if (visibleMapLayers?.zoning && dataCache?.zoning?.features?.length) {\r\n                    const byKey = {};\r\n                    (ZONING_ORDER || []).forEach(k => (byKey[k] = []));\r\n                    dataCache.zoning.features.forEach(f => {\r\n                        let k = (f.properties?.CLAVE || '').toString().trim().toUpperCase();\r\n                        if (k === 'PDU' || k === 'PROGRAMAS' || k === 'ZONA URBANA') {\r\n                            const desc = (f.properties?.PGOEDF || '').toLowerCase();\r\n                            if (desc.includes('equipamiento')) k = 'PDU_ER';\r\n                            else if (desc.includes('parcial')) k = 'PDU_PP';\r\n                            else if (desc.includes('poblad') || desc.includes('rural') || desc.includes('habitacional')) k = 'PDU_PR';\r\n                            else if (desc.includes('urbana') || desc.includes('urbano') || desc.includes('barrio')) k = 'PDU_ZU';\r\n                        }\r\n                        if (byKey[k]) byKey[k].push(f);\r\n                    });\r\n                    (ZONING_ORDER || []).forEach((k) => {\r\n                        const isOn = (visibleZoningCats?.[k] !== false);\r\n                        if (!isOn) return;\r\n                        const feats = byKey[k];\r\n                        if (!feats?.length) return;\r\n                        const color = ZONING_CAT_INFO?.[k]?.color || '#9ca3af';\r\n                        addGeoJson({ type: 'FeatureCollection', features: feats }, { color, weight: 1.5, opacity: 0.9, fillColor: color, fillOpacity: 0.2, interactive: false }, overlayPane);\r\n                    });\r\n                }\r\n\r\n                // --- MARKER (SVG Data URI) ---\r\n                let bgColor = '#6b7280';\r\n                if (analysisStatus === 'OUTSIDE_CDMX') bgColor = '#ef4444';\r\n                else if (analysisStatus === 'CONSERVATION_SOIL') bgColor = LAYER_STYLES?.sc?.color || '#16a34a';\r\n                else if (isANP) bgColor = '#9333ea';\r\n                else if (analysisStatus === 'URBAN_SOIL') bgColor = '#3b82f6';\r\n\r\n                const svgString = `\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"40\" height=\"40\" viewBox=\"0 0 24 24\">\r\n                        <filter id=\"shadow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\r\n                            <feDropShadow dx=\"0\" dy=\"2\" stdDeviation=\"2\" flood-color=\"black\" flood-opacity=\"0.3\"/>\r\n                        </filter>\r\n                        <circle cx=\"12\" cy=\"12\" r=\"8\" fill=\"${bgColor}\" stroke=\"white\" stroke-width=\"2.5\" filter=\"url(#shadow)\"/>\r\n                    </svg>\r\n                `.trim();\r\n                const iconUrl = 'data:image/svg+xml;base64,' + btoa(svgString);\r\n                const icon = L.icon({ iconUrl, iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -10] });\r\n                L.marker([lat, lng], { icon, pane: markerPane, interactive: false }).addTo(m);\r\n\r\n                await waitForMapReady(m);\r\n\r\n                let settled = false;\r\n                const done = (img) => {\r\n                    if (settled) return; settled = true;\r\n                    if (exportMapInstance.current === m) {\r\n                        try { m.remove(); } catch { }\r\n                        exportMapInstance.current = null;\r\n                    }\r\n                    resolve(img || null);\r\n                };\r\n\r\n                const capture = () => {\r\n                    try {\r\n                        leafletImage(m, (err, canvas) => {\r\n                            if (err || !canvas) return done(null);\r\n                            done(canvas.toDataURL('image/png'));\r\n                        });\r\n                    } catch (err) { done(null); }\r\n                };\r\n\r\n                // OPTIMIZED TIMEOUTS\r\n                // Reduced safety timeout from 6000ms to 3000ms\r\n                const safetyTimeout = setTimeout(() => { capture(); }, 3000);\r\n\r\n                // Reduced active wait from 1200ms to 400ms after load\r\n                base.on('load', () => { setTimeout(() => { clearTimeout(safetyTimeout); capture(); }, 400); });\r\n\r\n                // Reduced fallback from 3500ms to 2000ms\r\n                setTimeout(() => { if (!settled) capture(); }, 2000);\r\n\r\n            } catch (e) { resolve(null); }\r\n        });\r\n    };\r\n\r\n    const handleExportPDF = useCallback(async () => {\r\n        if (!exportArmedRef.current) return;\r\n        exportArmedRef.current = false;\r\n\r\n        // Return a promise to allow caller to await\r\n        return new Promise(async (resolve, reject) => {\r\n            if (onProgress) onProgress(10); // START\r\n\r\n            if (!analysis || !pdfRef.current) {\r\n                reject(\"No analysis available\");\r\n                if (onProgress) onProgress(0);\r\n                return;\r\n            }\r\n\r\n            // check imports - they are imported\r\n            if (!jsPDF || typeof html2canvas !== 'function') {\r\n                alert('Error: Librer√≠a jsPDF/html2canvas no cargada.');\r\n                reject(\"Libs missing\");\r\n                return;\r\n            }\r\n\r\n            try {\r\n                // 0. Prepare Constants\r\n                const folio = `F-${new Date().toISOString().replace(/[-:T.Z]/g, '').slice(0, 14)}`;\r\n\r\n                // 1. Prepare Map Image\r\n                const hasActiveLayers = visibleMapLayers?.sc || (visibleMapLayers?.zoning && dataCache?.zoning) || visibleMapLayers?.anp || visibleMapLayers?.alcaldias;\r\n                let img = null;\r\n                let staticUrl = null;\r\n\r\n                if (!hasActiveLayers) {\r\n                    staticUrl = getStaticMapUrl({ lat: analysis.coordinate.lat, lng: analysis.coordinate.lng, zoom: currentZoom });\r\n                    const staticOk = await preloadImage(staticUrl);\r\n                    if (staticOk) img = staticUrl;\r\n                }\r\n                if (!img) {\r\n                    img = await buildExportMapImage({ lat: analysis.coordinate.lat, lng: analysis.coordinate.lng, zoom: currentZoom, analysisStatus: analysis.status, isANP: analysis.isANP });\r\n                }\r\n                if (onProgress) onProgress(40); // MAP READY\r\n                setMapImage(img);\r\n\r\n                // 2. Prepare View Mode (Hide Activities for Cover)\r\n                // We force exclude activities in DOM so we capture a clean single-page cover\r\n                setIncludeActivities(false);\r\n\r\n                // Wait for Render\r\n                await new Promise(r => setTimeout(r, 200));\r\n                await waitForImgLoaded(pdfRef.current, 'img[alt=\"Mapa\"]');\r\n                await waitForImgLoaded(pdfRef.current, 'img[alt=\"QR visor\"]');\r\n\r\n                const element = pdfRef.current;\r\n                const doc = new jsPDF('p', 'mm', 'a4');\r\n                const pdfW = doc.internal.pageSize.getWidth();\r\n                const pdfH = doc.internal.pageSize.getHeight();\r\n\r\n                const M = 15; // Global Margin\r\n                const hasAutoTable = !!doc.autoTable;\r\n\r\n                // --- HYBRID STRATEGY ---\r\n                if (hasAutoTable) {\r\n                    // STEP A: Capture Cover Page (DOM -> Image)\r\n                    const isMobile = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;\r\n                    const scale = isMobile ? 1.5 : 2.0; // Reduced to prevent freeze\r\n\r\n                    const canvas = await html2canvas(element, {\r\n                        scale,\r\n                        useCORS: true,\r\n                        backgroundColor: '#ffffff',\r\n                        logging: false,\r\n                        onclone: (clonedDoc) => {\r\n                            const header = clonedDoc.getElementById('pdf-header-row');\r\n                            if (header) header.style.opacity = '0'; // Hide header in capture to start with whitespace\r\n                        }\r\n                    });\r\n                    const coverImgData = canvas.toDataURL('image/jpeg', 0.8); // JPEG is faster/smaller than PNG\r\n                    if (onProgress) onProgress(70); // COVER READY\r\n\r\n                    // Yield to UI thread to prevent \"Page Unresponsive\"\r\n                    await new Promise(r => setTimeout(r, 100));\r\n\r\n                    // Pre-load Logo for headers\r\n                    const logoDataUrl = await loadLogoData();\r\n                    const headersDrawn = {};\r\n\r\n                    // Helper for Page Header \r\n                    const addHeader = (pdfDoc, pageNumber) => {\r\n                        if (headersDrawn[pageNumber]) return 15 + 35; // Already drawn\r\n\r\n                        let y = M;\r\n                        if (logoDataUrl) {\r\n                            // FIX LOGO ASPECT RATIO\r\n                            const logoProps = pdfDoc.getImageProperties(logoDataUrl);\r\n                            const desiredW = 90; // Increased from 60 for wider logos\r\n                            const ratio = logoProps.height / logoProps.width;\r\n                            const desiredH = desiredW * ratio;\r\n                            pdfDoc.addImage(logoDataUrl, 'PNG', M, y, desiredW, desiredH);\r\n                        }\r\n                        pdfDoc.setFontSize(14);\r\n                        pdfDoc.setFont(\"helvetica\", \"bold\");\r\n                        pdfDoc.setTextColor(157, 36, 73); // Guinda\r\n                        pdfDoc.text(\"FICHA INFORMATIVA\", pdfW - M, y + 8, { align: 'right' });\r\n\r\n                        pdfDoc.setFontSize(9);\r\n                        pdfDoc.setFont(\"helvetica\", \"italic\");\r\n                        pdfDoc.setTextColor(100);\r\n                        pdfDoc.text(\"Consulta Ciudadana de Zonificaci√≥n\", pdfW - M, y + 12, { align: 'right' });\r\n\r\n                        const dateTitle = analysis.timestamp || new Date().toLocaleString();\r\n                        pdfDoc.setFontSize(8);\r\n                        pdfDoc.setFont(\"helvetica\", \"normal\");\r\n                        pdfDoc.setTextColor(0);\r\n                        pdfDoc.text(`Folio: ${folio}`, pdfW - M, y + 16, { align: 'right' });\r\n                        pdfDoc.text(`Fecha: ${dateTitle}`, pdfW - M, y + 20, { align: 'right' });\r\n\r\n                        // Golden Line moved BELOW Page Number area (approx y+28)\r\n                        pdfDoc.setDrawColor(212, 193, 156); // Dorado\r\n                        pdfDoc.setLineWidth(0.5);\r\n                        pdfDoc.line(M, y + 28, pdfW - M, y + 28);\r\n\r\n                        headersDrawn[pageNumber] = true;\r\n                        return y + 35; // increased top margin\r\n                    };\r\n\r\n                    // Add Cover with FAST compression\r\n                    doc.addImage(coverImgData, 'JPEG', 0, 0, pdfW, pdfH, undefined, 'FAST');\r\n\r\n                    // DRAW HEADER ON PAGE 1 (Standardized Vector Header)\r\n                    addHeader(doc, 1);\r\n\r\n                    // STEP B: Append Native Table Pages (if SC)\r\n                    const isSC = analysis.status === 'CONSERVATION_SOIL';\r\n                    const isANP = analysis.isANP || analysis.zoningKey === 'ANP';\r\n                    const hasActivities = isSC && !isANP && !analysis.isPDU && !analysis.noActivitiesCatalog;\r\n\r\n\r\n                    if (hasActivities) {\r\n                        const gap = 8;\r\n                        const colW = (pdfW - (2 * M) - gap) / 2;\r\n\r\n                        doc.addPage();\r\n                        const startPage = doc.internal.getCurrentPageInfo().pageNumber;\r\n                        // Manual header for new page\r\n                        let startY = addHeader(doc, startPage);\r\n\r\n                        // Data Preparation with Grouping\r\n                        const allowed = processGroupedData(analysis.allowedActivities || []);\r\n                        const prohibited = processGroupedData(analysis.prohibitedActivities || []);\r\n\r\n                        // --- TABLE LEFT (Activities Allowed) ---\r\n                        let finalYLeft = startY;\r\n                        let finalPageLeft = startPage;\r\n\r\n                        if (allowed.length > 0) {\r\n                            doc.setFontSize(10);\r\n                            doc.setTextColor(21, 128, 61); // Green\r\n                            doc.setFont(\"helvetica\", \"bold\");\r\n\r\n                            doc.text(\"PERMITIDAS\", M, startY);\r\n                            doc.setFontSize(8);\r\n                            doc.setTextColor(100);\r\n                            doc.setFont(\"helvetica\", \"normal\");\r\n                            doc.text(\"Esta tabla detalla las actividades permitidas en la zona, conforme a la normatividad vigente.\", M, startY + 4, { maxWidth: colW });\r\n\r\n                            const tableStartY = startY + 12;\r\n\r\n                            doc.autoTable({\r\n                                startY: tableStartY,\r\n                                head: [['Actividad', 'Detalle']],\r\n                                body: allowed,\r\n                                theme: 'plain', // Custom styling\r\n                                headStyles: { fillColor: [21, 128, 61], textColor: 255, fontSize: 8, fontStyle: 'bold', halign: 'center', valign: 'middle' },\r\n                                styles: { fontSize: 5, cellPadding: 1.5, overflow: 'linebreak', halign: 'left', valign: 'middle', lineColor: [230, 230, 230], lineWidth: 0.1 },\r\n                                alternateRowStyles: { fillColor: [248, 248, 248] }, // Zebra\r\n                                columnStyles: { 0: { cellWidth: 25, fontStyle: 'bold' }, 1: { cellWidth: 'auto' } },\r\n                                tableWidth: colW,\r\n                                margin: { left: M, top: 45 },\r\n                                didDrawPage: (data) => {\r\n                                    addHeader(doc, data.pageNumber);\r\n                                }\r\n                            });\r\n                            finalYLeft = doc.lastAutoTable.finalY;\r\n                            finalPageLeft = doc.internal.getCurrentPageInfo().pageNumber;\r\n                        }\r\n\r\n                        // --- TABLE RIGHT (Activities Prohibited) ---\r\n                        // Reset cursor to start parallel render\r\n                        doc.setPage(startPage);\r\n\r\n                        let finalYRight = startY;\r\n                        let finalPageRight = startPage;\r\n\r\n                        if (prohibited.length > 0) {\r\n                            const leftM = M + colW + gap;\r\n                            doc.setFontSize(10);\r\n                            doc.setTextColor(185, 28, 28); // Red\r\n                            doc.setFont(\"helvetica\", \"bold\");\r\n\r\n                            doc.text(\"PROHIBIDAS\", leftM, startY);\r\n                            doc.setFontSize(8);\r\n                            doc.setTextColor(100);\r\n                            doc.setFont(\"helvetica\", \"normal\");\r\n                            doc.text(\"Esta tabla detalla las actividades prohibidas.\", leftM, startY + 4, { maxWidth: colW });\r\n\r\n                            const tableStartY = startY + 12;\r\n\r\n                            doc.autoTable({\r\n                                startY: tableStartY,\r\n                                head: [['Actividad', 'Detalle']],\r\n                                body: prohibited,\r\n                                theme: 'plain',\r\n                                headStyles: { fillColor: [185, 28, 28], textColor: 255, fontSize: 8, fontStyle: 'bold', halign: 'center', valign: 'middle' },\r\n                                styles: { fontSize: 5, cellPadding: 1.5, overflow: 'linebreak', halign: 'left', valign: 'middle', lineColor: [230, 230, 230], lineWidth: 0.1 },\r\n                                alternateRowStyles: { fillColor: [248, 248, 248] }, // Zebra\r\n                                columnStyles: { 0: { cellWidth: 25, fontStyle: 'bold' }, 1: { cellWidth: 'auto' } },\r\n                                tableWidth: colW,\r\n                                margin: { left: leftM, top: 45 },\r\n                                didDrawPage: (data) => {\r\n                                    addHeader(doc, data.pageNumber);\r\n                                }\r\n                            });\r\n                            finalYRight = doc.lastAutoTable.finalY;\r\n                            finalPageRight = doc.internal.getCurrentPageInfo().pageNumber;\r\n                        }\r\n\r\n                        // Sync Doc to Content End (Max of both)\r\n                        const maxPage = Math.max(finalPageLeft, finalPageRight);\r\n                        doc.setPage(maxPage);\r\n                    }\r\n\r\n                    // --- FINAL: ADD PAGE NUMBERS TO ALL PAGES ---\r\n                    const totalPages = doc.internal.getNumberOfPages();\r\n\r\n                    for (let i = 1; i <= totalPages; i++) {\r\n                        doc.setPage(i);\r\n                        // Page Number Position\r\n                        const footerY = 39; // y=15 + 24 = 39. Below Date (35), Above Line (43)\r\n\r\n                        doc.setFontSize(8);\r\n                        doc.setTextColor(100);\r\n                        doc.setFont(\"helvetica\", \"normal\");\r\n                        doc.text(`P√°gina ${i} de ${totalPages}`, pdfW - M, footerY, { align: 'right' });\r\n                    }\r\n                } else {\r\n                    // Fallback logic\r\n                    doc.text(\"Vista simplificada\", 10, 10);\r\n                }\r\n                // --- WATERMARK FUNCTION ---\r\n                const addWatermark = (pdfDoc, pageNum, total) => {\r\n                    pdfDoc.setPage(pageNum);\r\n                    pdfDoc.saveGraphicsState();\r\n                    pdfDoc.setGState(new pdfDoc.GState({ opacity: 0.1 }));\r\n                    pdfDoc.setFontSize(40);\r\n                    pdfDoc.setTextColor(150, 150, 150);\r\n                    pdfDoc.setFont('helvetica', 'bold');\r\n\r\n                    // Rotate 45 degrees around center\r\n                    // Translate to center first\r\n                    const cx = pdfW / 2;\r\n                    const cy = pdfH / 2;\r\n\r\n                    // jsPDF rotation is slightly tricky without advance API, \r\n                    // but we can use text rotation parameter.\r\n                    pdfDoc.text('DOCUMENTO INFORMATIVO', cx, cy, { align: 'center', angle: 45 });\r\n                    pdfDoc.text('SIN VALIDEZ LEGAL', cx, cy + 15, { align: 'center', angle: 45 });\r\n\r\n                    pdfDoc.restoreGraphicsState();\r\n                };\r\n\r\n                // --- GLOBAL FOOTER: PAGINATION & DISLAIMER ---\r\n                const totalPages = doc.internal.getNumberOfPages();\r\n                for (let i = 1; i <= totalPages; i++) {\r\n                    doc.setPage(i);\r\n\r\n                    // Apply Watermark\r\n                    addWatermark(doc, i, totalPages);\r\n\r\n                    // Disclaimer\r\n                    doc.setFontSize(7);\r\n                    doc.setTextColor(150);\r\n                    doc.setFont(\"helvetica\", \"italic\");\r\n                    doc.text(\"Este no es un documento oficial. Consulte la Ventanilla √önica de la SEDEMA para tr√°mites oficiales.\", pdfW / 2, pdfH - 14, { align: 'center' });\r\n\r\n                    // Page Number\r\n                    doc.setFontSize(8);\r\n                    doc.setTextColor(150);\r\n                    doc.setFont(\"helvetica\", \"normal\");\r\n                    const pageText = `P√°gina ${i} de ${totalPages}`;\r\n                    doc.text(pageText, pdfW / 2, pdfH - 10, { align: 'center' });\r\n                }\r\n\r\n                if (onProgress) onProgress(90); // TABLES DONE\r\n\r\n                // --- FILENAME GENERATION HELPER ---\r\n                const generateDetailedFilename = () => {\r\n                    const timestamp = new Date().toISOString().replace(/[-:T.Z]/g, '').slice(0, 14);\r\n                    const folio = `F${timestamp}`;\r\n\r\n                    let type = 'ND'; // No detemined\r\n                    const { status, zoningKey, isANP, alcaldia, outsideContext } = analysis;\r\n\r\n                    if (status === 'OUTSIDE_CDMX') {\r\n                        type = 'EXTERNO';\r\n                    } else if (status === 'URBAN_SOIL') {\r\n                        type = 'SU';\r\n                        if (isANP) type += '-ANP';\r\n                    } else if (status === 'CONSERVATION_SOIL') {\r\n                        type = 'SC';\r\n                        if (zoningKey) type += `-${zoningKey}`;\r\n                        if (isANP) type += '-ANP';\r\n                    }\r\n\r\n                    let location = 'CDMX';\r\n                    if (status === 'OUTSIDE_CDMX') {\r\n                        location = outsideContext || 'EDOMEX';\r\n                    } else {\r\n                        location = alcaldia || 'CDMX';\r\n                    }\r\n\r\n                    // Sanitize\r\n                    const cleanType = type.replace(/[^a-zA-Z0-9-]/g, '').toUpperCase();\r\n                    const cleanLoc = location.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase();\r\n\r\n                    return `FICHA_${folio}_${cleanType}_${cleanLoc}.pdf`;\r\n                };\r\n\r\n                const filename = generateDetailedFilename();\r\n                doc.save(filename);\r\n\r\n                // --- END SAVE ---\r\n                resolve();\r\n            } catch (error) {\r\n                console.error(\"PDF Export failed:\", error);\r\n                reject(error);\r\n            }\r\n        });\r\n    }, [analysis, dataCache, visibleMapLayers, activeBaseLayer, visibleZoningCats, currentZoom]);\r\n\r\n    const requestExportPDF = useCallback(async (e) => {\r\n        if (!e || !e.isTrusted) return;\r\n        exportArmedRef.current = true;\r\n        return await handleExportPDF(); // Forward promise\r\n    }, [handleExportPDF]);\r\n\r\n    useEffect(() => {\r\n        if (!onExportReady) return;\r\n        onExportReady(requestExportPDF);\r\n        return () => onExportReady(null);\r\n    }, [onExportReady, requestExportPDF]);\r\n\r\n    if (!analysis) return null;\r\n\r\n    return (\r\n        <>\r\n            <div id=\"export-map\" style={{ width: '900px', height: '520px', position: 'absolute', top: '-9999px', left: '-9999px', zIndex: -1 }}></div>\r\n            <div style={{ position: 'absolute', top: -9999, left: -9999, width: '794px', zIndex: -1 }}>\r\n                <div style={{ background: '#ffffff' }}>\r\n                    {/* Include Activities controlled by State */}\r\n                    <PdfFicha ref={pdfRef} analysis={analysis} mapImage={mapImage} includeActivities={includeActivities} approximateAddress={approximateAddress} />\r\n                </div>\r\n            </div>\r\n        </>\r\n    );\r\n};\r\n\r\nexport default PdfExportController;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jorge\\Documents\\consulta-de-predios-V3\\src\\components\\layout\\BottomSheetMobile.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  13 |\n  14 |     useEffect(() => {\n> 15 |         if (analysis) setSheetState('mid');\n     |                       ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  16 |         else setSheetState('collapsed');\n  17 |     }, [analysis]);\n  18 |","line":15,"column":23,"nodeType":null,"endLine":15,"endColumn":36},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":130,"column":41,"nodeType":"BlockStatement","messageId":"unexpected","endLine":130,"endColumn":44,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[7183,7184],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport Icons from '../ui/Icons';\r\nimport ResultsContent from '../analysis/ResultsContent';\r\n\r\nconst BottomSheetMobile = ({ analysis, onLocationSelect, onReset, onClose, onStateChange, onExportPDF, isExporting, exportProgress }) => {\r\n    const [sheetState, setSheetState] = useState('collapsed'); // 'collapsed' | 'mid' | 'full'\r\n    const sheetRef = useRef(null);\r\n    const startY = useRef(0);\r\n\r\n    useEffect(() => {\r\n        if (onStateChange) onStateChange(sheetState);\r\n    }, [sheetState, onStateChange]);\r\n\r\n    useEffect(() => {\r\n        if (analysis) setSheetState('mid');\r\n        else setSheetState('collapsed');\r\n    }, [analysis]);\r\n\r\n    const goUp = () => setSheetState(prev => (prev === 'collapsed' ? 'mid' : prev === 'mid' ? 'full' : 'full'));\r\n    const goDown = () => setSheetState(prev => (prev === 'full' ? 'mid' : prev === 'mid' ? 'collapsed' : 'collapsed'));\r\n    const toggleFromTap = () => setSheetState(prev => (prev === 'mid' ? 'full' : 'mid'));\r\n\r\n    const handleTouchStart = (e) => {\r\n        if (e.target.closest('.sheet-header')) startY.current = e.touches[0].clientY;\r\n    };\r\n\r\n    const handleTouchEnd = (e) => {\r\n        const endY = e.changedTouches[0].clientY;\r\n        const diff = startY.current - endY;\r\n        if (Math.abs(diff) < 60) return;\r\n        if (diff > 0) goUp();\r\n        else goDown();\r\n    };\r\n\r\n    const getHeight = () => {\r\n        if (sheetState === 'collapsed') return '18svh';\r\n        if (sheetState === 'mid') return '45svh';\r\n        return '85svh';\r\n    };\r\n\r\n    const isANP = analysis?.isANP;\r\n    const statusLabel = !analysis\r\n        ? 'Busca una direcci√≥n o toca el mapa para iniciar la consulta.'\r\n        : analysis?.status === 'OUTSIDE_CDMX'\r\n            ? 'El punto se encuentra fuera de la Ciudad de M√©xico.'\r\n            : isANP\r\n                ? '√Årea Natural Protegida ‚Äî consulte el Programa de Manejo correspondiente.'\r\n                : analysis?.status === 'NO_DATA'\r\n                    ? 'No encontramos informaci√≥n espec√≠fica para esta zona. Podr√≠a ser calle o zona federal.'\r\n                    : 'Aqu√≠ tienes la informaci√≥n normativa del punto.';\r\n\r\n    return (\r\n        <div\r\n            ref={sheetRef}\r\n            className=\"md:hidden fixed bottom-0 left-0 w-full glass-panel rounded-t-[24px] border-b-0 shadow-[0_-5px_30px_rgba(0,0,0,0.15)] z-[1050] flex flex-col transition-all duration-300 ease-out\"\r\n            style={{ height: getHeight() }}\r\n        >\r\n            <div\r\n                className=\"sheet-header flex-shrink-0 pt-1 pb-2 px-4 cursor-grab active:cursor-grabbing bg-white relative z-20 rounded-t-[24px]\"\r\n                onTouchStart={handleTouchStart}\r\n                onTouchEnd={handleTouchEnd}\r\n                onClick={analysis ? toggleFromTap : undefined}\r\n            >\r\n                <div className=\"w-10 h-1.5 bg-gray-300 rounded-full mx-auto mb-2\" />\r\n                <div className=\"flex items-start justify-between gap-2\">\r\n                    <div className=\"flex-1 min-w-0\">\r\n                        {analysis ? (\r\n                            <h3 className=\"font-bold text-sm text-[#9d2148] uppercase tracking-wide\">\r\n                                RESULTADO DE CONSULTA\r\n                            </h3>\r\n                        ) : (\r\n                            <div className=\"flex flex-col items-center justify-center pt-3 pb-1 w-full relative overflow-hidden\">\r\n                                <div className=\"absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-[#9d2148] via-[#bc955c] to-[#9d2148]\"></div>\r\n                                <div className=\"flex items-center gap-2 mb-1 mt-1 bg-white/50 backdrop-blur-sm px-2 py-0.5 rounded-full\">\r\n                                    <div className=\"w-2 h-2 rounded-full bg-[#9d2148]\"></div>\r\n                                    <span className=\"text-[10px] font-black tracking-[0.2em] text-gray-400 uppercase\">SEDEMA</span>\r\n                                    <div className=\"w-2 h-2 rounded-full bg-[#9d2148]\"></div>\r\n                                </div>\r\n                                <h3 className=\"font-extrabold text-[#9d2148] text-xl mb-1 uppercase tracking-tight leading-none\">\r\n                                    Visor de Consulta\r\n                                </h3>\r\n                                <p className=\"text-sm text-gray-500 text-center px-6 leading-tight font-medium max-w-xs mx-auto\">\r\n                                    {statusLabel}\r\n                                </p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                    {analysis && (\r\n                        <button\r\n                            onClick={(e) => {\r\n                                e.stopPropagation();\r\n                                onClose();\r\n                            }}\r\n                            className=\"p-1.5 rounded-full bg-[#9d2148] shadow-sm active:scale-95 transition\"\r\n                            aria-label=\"Cerrar resultados\"\r\n                            title=\"Cerrar ficha\"\r\n                        >\r\n                            <Icons.X className=\"h-4 w-4 text-white\" />\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n            <div className=\"h-px bg-gray-200 w-full\" />\r\n            {(sheetState === 'mid' || sheetState === 'full') && (\r\n                <div className=\"flex-1 overflow-y-auto custom-scrollbar p-4 bg-gray-50/50 mobile-upscale\">\r\n                    <ResultsContent analysis={analysis} onExportPDF={onExportPDF} isExporting={isExporting} />\r\n                </div>\r\n            )}\r\n            {analysis && (\r\n                <div className=\"flex-shrink-0 p-3 bg-white border-t border-gray-200 safe-area-bottom flex gap-3 overflow-x-auto\">\r\n                    <a\r\n                        href={`https://www.google.com/maps/search/?api=1&query=${analysis.coordinate.lat},${analysis.coordinate.lng}`}\r\n                        target=\"_blank\"\r\n                        rel=\"noreferrer\"\r\n                        className=\"flex-1 min-w-[100px] flex items-center justify-center gap-2 bg-[#9d2148] text-white py-2.5 px-4 rounded-full text-xs font-bold shadow-sm hover:bg-[#7d1d3a] transition-colors\"\r\n                        title=\"Ver ubicaci√≥n en Google Maps\"\r\n                    >\r\n                        <Icons.MapIcon className=\"h-4 w-4\" /> Google Maps\r\n                    </a>\r\n                    <button\r\n                        onClick={async () => {\r\n                            const url = `${window.location.origin}${window.location.pathname}?lat=${analysis.coordinate.lat}&lng=${analysis.coordinate.lng}&open=1`;\r\n                            if (navigator.share) {\r\n                                try {\r\n                                    await navigator.share({\r\n                                        title: 'Consulta Ciudadana SEDEMA',\r\n                                        text: `Ubicaci√≥n: ${analysis.alcaldia}`,\r\n                                        url\r\n                                    });\r\n                                } catch { }\r\n                            } else {\r\n                                navigator.clipboard.writeText(url);\r\n                            }\r\n                        }}\r\n                        className=\"flex-1 min-w-[100px] flex items-center justify-center gap-2 bg-white text-gray-700 border border-gray-300 py-2.5 px-4 rounded-full text-xs font-bold shadow-sm hover:bg-gray-50\"\r\n                        title=\"Compartir ubicaci√≥n\"\r\n                    >\r\n                        <Icons.Share className=\"h-4 w-4\" /> Compartir\r\n                    </button>\r\n                    <button\r\n                        type=\"button\"\r\n                        onClick={(e) => {\r\n                            if (isExporting) return;\r\n                            if (onExportPDF) onExportPDF(e);\r\n                            else alert('No se pudo generar el PDF. Intenta recargar la p√°gina.');\r\n                        }}\r\n                        disabled={isExporting}\r\n                        className={`flex-1 min-w-[110px] flex items-center justify-center gap-2 bg-white text-gray-700 border border-gray-300 py-2.5 px-4 rounded-full text-xs font-bold shadow-sm hover:bg-gray-50 ${isExporting ? 'opacity-75 cursor-not-allowed' : ''}`}\r\n                        title=\"Descargar ficha t√©cnica en PDF\"\r\n                    >\r\n                        {isExporting ? (\r\n                            <>\r\n                                {Icons.Loader2 ? <Icons.Loader2 className=\"h-4 w-4 animate-spin text-[#9d2148]\" /> : <span className=\"h-4 w-4 rounded-full border-2 border-t-[#9d2148] animate-spin\" />}\r\n                                Generando... {exportProgress ? `${exportProgress}%` : ''}\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <Icons.Pdf className=\"h-4 w-4\" /> Exportar PDF\r\n                            </>\r\n                        )}\r\n                    </button>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default BottomSheetMobile;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jorge\\Documents\\consulta-de-predios-V3\\src\\components\\map\\MapViewer.jsx","messages":[{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":131,"column":17,"nodeType":"BlockStatement","messageId":"unexpected","endLine":131,"endColumn":20,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[4000,4001],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":144,"column":25,"nodeType":"BlockStatement","messageId":"unexpected","endLine":144,"endColumn":28,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[4479,4480],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":153,"column":70,"nodeType":"BlockStatement","messageId":"unexpected","endLine":153,"endColumn":73,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[4796,4797],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":255,"column":49,"nodeType":"BlockStatement","messageId":"unexpected","endLine":255,"endColumn":52,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[8215,8216],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":259,"column":41,"nodeType":"BlockStatement","messageId":"unexpected","endLine":259,"endColumn":44,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[8304,8305],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  428 |     useEffect(() => {\n  429 |         if (!mapInstance.current || !layersRef.current.base) return;\n> 430 |         setTilesLoading(true);\n      |         ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  431 |         layersRef.current.base.setUrl(getBaseLayerUrl(activeBaseLayer));\n  432 |\n  433 |         if (layersRef.current.alcaldias) {","line":430,"column":9,"nodeType":null,"endLine":430,"endColumn":24},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":450,"column":77,"nodeType":"BlockStatement","messageId":"unexpected","endLine":451,"endColumn":18,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[16506,16524],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport L from 'leaflet';\r\nimport { Icons } from '../ui/Icons';\r\nimport { CONSTANTS } from '../../utils/constants';\r\nimport * as Utils from '../../utils/geoUtils';\r\n\r\n// Fix Leaflet Default Icon issue in Webpack/Vite\r\nimport iconArrow from 'leaflet/dist/images/marker-icon.png';\r\nimport iconShadow from 'leaflet/dist/images/marker-shadow.png';\r\n\r\nlet DefaultIcon = L.icon({\r\n    iconUrl: iconArrow,\r\n    shadowUrl: iconShadow,\r\n    iconAnchor: [12, 41]\r\n});\r\nL.Marker.prototype.options.icon = DefaultIcon;\r\n\r\nconst MapViewer = ({\r\n    location,\r\n    onLocationSelect,\r\n    analysisStatus,\r\n    isANP,\r\n    visibleMapLayers,\r\n    setVisibleMapLayers,\r\n    visibleZoningCats,\r\n    setVisibleZoningCats,\r\n    extraDataLoaded,\r\n    activeBaseLayer,\r\n    setActiveBaseLayer,\r\n    invalidateMapRef,\r\n    resetMapViewRef,\r\n    selectedAnpId,\r\n    dataCache,\r\n    onZoomChange,\r\n    globalOpacity = 0.7,\r\n    setGlobalOpacity,\r\n    zoomInRef,\r\n    zoomOutRef\r\n}) => {\r\n    // Access Constants lazily or directly\r\n    const {\r\n        LAYER_STYLES,\r\n        ZONING_ORDER,\r\n        ZONING_CAT_INFO,\r\n        INITIAL_CENTER = [19.32, -99.15],\r\n        INITIAL_ZOOM = 11,\r\n        FOCUS_ZOOM = 16\r\n    } = CONSTANTS;\r\n\r\n    const {\r\n        getBaseLayerUrl = () => '',\r\n        getZoningStyle = () => ({ color: '#ccc' })\r\n    } = Utils;\r\n\r\n    const mapRef = useRef(null);\r\n    const mapInstance = useRef(null);\r\n    const layersRef = useRef({});          // sc, alcaldias, edomex, morelos, base\r\n    const zoningLayersRef = useRef({});    // {ANP: layer, FC: layer, ... }\r\n    const selectedAnpLayerRef = useRef(null);\r\n    const markerRef = useRef(null);\r\n    const [tilesLoading, setTilesLoading] = useState(true);\r\n\r\n    const escapeHtml = (text) => {\r\n        if (!text) return '';\r\n        return text\r\n            .toString()\r\n            .replace(/&/g, \"&amp;\")\r\n            .replace(/</g, \"&lt;\")\r\n            .replace(/>/g, \"&gt;\")\r\n            .replace(/\"/g, \"&quot;\")\r\n            .replace(/'/g, \"&#039;\");\r\n    };\r\n\r\n    const bindColoredTooltip = (layerInstance, label, color, prefix = '') => {\r\n        const safeLabel = escapeHtml(label);\r\n        const html = `\r\n        <div style=\"\r\n            background: ${color};\r\n            color: #fff;\r\n            padding: 5px 10px;\r\n            border-radius: 6px;\r\n            font-weight: 600;\r\n            font-size: 11px;\r\n            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);\r\n            text-transform: uppercase;\r\n            letter-spacing: 0.025em;\r\n            border: 1px solid rgba(255,255,255,0.2);\r\n            white-space: nowrap;\r\n        \">\r\n            ${prefix ? `<span style=\"opacity:0.8; margin-right:4px;\">${prefix}</span>` : ''}\r\n            ${safeLabel}\r\n        </div>\r\n        `;\r\n        layerInstance.bindTooltip(html, {\r\n            sticky: true,\r\n            className: 'colored-tooltip-container',\r\n            direction: 'top',\r\n            offset: [0, -10]\r\n        });\r\n    };\r\n\r\n    // 1) INIT MAP\r\n    useEffect(() => {\r\n        if (!mapRef.current || mapInstance.current) return;\r\n\r\n        const bounds = L.latLngBounds([14.0, -106.0], [24.0, -93.0]);\r\n\r\n        const map = L.map(mapRef.current, {\r\n            zoomControl: false,\r\n            attributionControl: false,\r\n            minZoom: 9,\r\n            maxZoom: 18,\r\n            preferCanvas: true,\r\n            maxBounds: bounds,\r\n            maxBoundsViscosity: 0.5\r\n        }).setView(INITIAL_CENTER, INITIAL_ZOOM);\r\n\r\n        L.control.attribution({ position: 'topleft', prefix: false }).addTo(map);\r\n        mapInstance.current = map;\r\n\r\n        map.on('zoomend', () => {\r\n            if (onZoomChange) onZoomChange(map.getZoom());\r\n        });\r\n\r\n        let cdmxBounds = null;\r\n        try {\r\n            if (dataCache?.cdmx?.features?.length) {\r\n                const tmp = L.geoJSON(dataCache.cdmx);\r\n                cdmxBounds = tmp.getBounds();\r\n            }\r\n        } catch { }\r\n\r\n        if (resetMapViewRef) {\r\n            resetMapViewRef.current = () => {\r\n                try {\r\n                    const m = mapInstance.current;\r\n                    if (!m) return;\r\n\r\n                    if (cdmxBounds && cdmxBounds.isValid()) {\r\n                        m.fitBounds(cdmxBounds, { padding: [20, 20] });\r\n                    } else {\r\n                        m.setView(INITIAL_CENTER, INITIAL_ZOOM);\r\n                    }\r\n                } catch { }\r\n            };\r\n        }\r\n\r\n        if (zoomInRef) zoomInRef.current = () => map.zoomIn();\r\n        if (zoomOutRef) zoomOutRef.current = () => map.zoomOut();\r\n\r\n        if (invalidateMapRef) {\r\n            invalidateMapRef.current = () => {\r\n                try { mapInstance.current?.invalidateSize(); } catch { }\r\n            };\r\n        }\r\n\r\n        // PANES CONFIGURATION\r\n        map.createPane('paneBase');\r\n        map.getPane('paneBase').style.zIndex = 300;\r\n\r\n        map.createPane('paneContext');\r\n        map.getPane('paneContext').style.zIndex = 350;\r\n\r\n        map.createPane('paneSCOverlay');\r\n        map.getPane('paneSCOverlay').style.zIndex = 375;\r\n\r\n        map.createPane('paneOverlay');\r\n        map.getPane('paneOverlay').style.zIndex = 400;\r\n\r\n        // BASE TILE\r\n        const base = L.tileLayer(getBaseLayerUrl(activeBaseLayer || 'SATELLITE'), {\r\n            pane: 'paneBase',\r\n            maxZoom: 19,\r\n            tileSize: 256,\r\n            zoomOffset: 0,\r\n            crossOrigin: 'anonymous'\r\n        });\r\n\r\n        base.on('loading', () => setTilesLoading(true));\r\n        base.on('load', () => setTilesLoading(false));\r\n        base.addTo(map);\r\n        layersRef.current.base = base;\r\n\r\n        // CORE layers (SC, Alcald√≠as)\r\n        const sc = dataCache?.sc;\r\n        const alcaldias = dataCache?.alcaldias;\r\n        const styles = LAYER_STYLES || {};\r\n\r\n        const addCoreLayer = (name, data, style, tooltipField, pane, interactive = true) => {\r\n            if (!data?.features?.length) return;\r\n\r\n            const layer = L.geoJSON(data, {\r\n                pane,\r\n                style,\r\n                interactive,\r\n                onEachFeature: (feature, layerInstance) => {\r\n                    if (interactive && !L.Browser.mobile) {\r\n                        layerInstance.on('mouseover', () => {\r\n                            layerInstance.setStyle({ weight: 3, fillOpacity: 0.3 });\r\n                            layerInstance.bringToFront();\r\n                        });\r\n                        layerInstance.on('mouseout', () => {\r\n                            layerInstance.setStyle(style);\r\n                        });\r\n                    }\r\n\r\n                    if (name === 'sc') {\r\n                        bindColoredTooltip(layerInstance, \"Suelo de Conservaci√≥n\", styles.sc?.color || '#3B7D23');\r\n                    } else if (tooltipField && feature.properties?.[tooltipField]) {\r\n                        layerInstance.bindTooltip(escapeHtml(feature.properties[tooltipField]), {\r\n                            sticky: true,\r\n                            className: 'custom-tooltip'\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n\r\n            layersRef.current[name] = layer;\r\n            map.addLayer(layer);\r\n        };\r\n\r\n        addCoreLayer(\r\n            'sc',\r\n            sc,\r\n            {\r\n                color: styles.sc?.color || '#3B7D23',\r\n                weight: 1.5,\r\n                opacity: 1,\r\n                fillColor: styles.sc?.fill || '#3B7D23',\r\n                fillOpacity: 0.2,\r\n                interactive: true\r\n            },\r\n            null,\r\n            'paneSCOverlay',\r\n            true\r\n        );\r\n\r\n        addCoreLayer(\r\n            'alcaldias',\r\n            alcaldias,\r\n            {\r\n                color: activeBaseLayer === 'SATELLITE' ? '#FFFFFF' : '#374151',\r\n                weight: 2,\r\n                opacity: 0.9,\r\n                fillOpacity: 0\r\n            },\r\n            null,\r\n            'paneContext',\r\n            false\r\n        );\r\n\r\n        map.on('click', e => onLocationSelect(e.latlng));\r\n\r\n        setTimeout(() => {\r\n            try { map.invalidateSize(); } catch { }\r\n        }, 200);\r\n\r\n        return () => {\r\n            try { map.remove(); } catch { }\r\n            mapInstance.current = null;\r\n            if (resetMapViewRef) resetMapViewRef.current = null;\r\n            layersRef.current = {};\r\n            zoningLayersRef.current = {};\r\n            markerRef.current = null;\r\n            if (invalidateMapRef) invalidateMapRef.current = null;\r\n        };\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        if (!mapInstance.current || !extraDataLoaded || !L || !dataCache) return;\r\n\r\n        const { edomex, morelos, zoning, anp } = dataCache;\r\n        const styles = LAYER_STYLES || {};\r\n\r\n        const addLayer = (name, data, style, tooltipField, pane, interactive = true) => {\r\n            if (!data?.features?.length) return;\r\n\r\n            const layer = L.geoJSON(data, {\r\n                pane,\r\n                style,\r\n                interactive,\r\n                onEachFeature: (feature, layerInstance) => {\r\n                    if (interactive && !L.Browser.mobile) {\r\n                        layerInstance.on('mouseover', () => layerInstance.setStyle({ weight: 3, fillOpacity: 0.3 }));\r\n                        layerInstance.on('mouseout', () => layerInstance.setStyle(style));\r\n                    }\r\n\r\n                    if (name === 'anp' && feature.properties?.NOMBRE) {\r\n                        bindColoredTooltip(layerInstance, feature.properties.NOMBRE, styles.anp?.color || '#a855f7', \"ANP:\");\r\n                    } else if (tooltipField && feature.properties?.[tooltipField]) {\r\n                        layerInstance.bindTooltip(escapeHtml(feature.properties[tooltipField]), {\r\n                            sticky: true,\r\n                            className: 'custom-tooltip'\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n\r\n            layersRef.current[name] = layer;\r\n            mapInstance.current.addLayer(layer);\r\n        };\r\n\r\n        if (!layersRef.current.edomex) {\r\n            addLayer('edomex', edomex, {\r\n                color: styles.edomex?.color || '#64748b',\r\n                weight: 1.5,\r\n                dashArray: '4,4',\r\n                opacity: 0.9,\r\n                fillOpacity: 0.1\r\n            }, 'NOMGEO', 'paneContext', true);\r\n        }\r\n\r\n        if (!layersRef.current.morelos) {\r\n            addLayer('morelos', morelos, {\r\n                color: styles.morelos?.color || '#64748b',\r\n                weight: 1.5,\r\n                dashArray: '4,4',\r\n                opacity: 0.9,\r\n                fillOpacity: 0.1\r\n            }, 'NOMGEO', 'paneContext', true);\r\n        }\r\n\r\n        if (!layersRef.current.anp) {\r\n            addLayer('anp', anp, {\r\n                color: styles.anp?.color || '#a855f7',\r\n                weight: 1.5,\r\n                opacity: 0.9,\r\n                fillColor: styles.anp?.fill || '#a855f7',\r\n                fillOpacity: 0.2\r\n            }, 'NOMBRE', 'paneOverlay', true);\r\n        }\r\n\r\n        if (zoning?.features?.length && Object.keys(zoningLayersRef.current).length === 0) {\r\n            const byKey = {};\r\n            (ZONING_ORDER || []).forEach(k => (byKey[k] = []));\r\n\r\n            zoning.features.forEach(f => {\r\n                let k = (f.properties?.CLAVE || '').toString().trim().toUpperCase();\r\n\r\n                if (k === 'PDU' || k === 'PROGRAMAS' || k === 'ZONA URBANA') {\r\n                    const desc = (f.properties?.PGOEDF || '').toLowerCase();\r\n                    if (desc.includes('equipamiento')) k = 'PDU_ER';\r\n                    else if (desc.includes('parcial')) k = 'PDU_PP';\r\n                    else if (desc.includes('poblad') || desc.includes('rural') || desc.includes('habitacional')) k = 'PDU_PR';\r\n                    else if (desc.includes('urbana') || desc.includes('urbano') || desc.includes('barrio')) k = 'PDU_ZU';\r\n                }\r\n\r\n                if (byKey[k]) byKey[k].push(f);\r\n            });\r\n\r\n            (ZONING_ORDER || []).forEach(k => {\r\n                const feats = byKey[k];\r\n                if (!feats?.length) return;\r\n\r\n                const fc = { type: 'FeatureCollection', features: feats };\r\n                const catInfo = (ZONING_CAT_INFO || {})[k];\r\n                const fixedColor = catInfo ? catInfo.color : '#9ca3af';\r\n\r\n                const layer = L.geoJSON(fc, {\r\n                    pane: 'paneOverlay',\r\n                    style: {\r\n                        color: fixedColor,\r\n                        weight: 1.5,\r\n                        opacity: 0.9,\r\n                        fillColor: fixedColor,\r\n                        fillOpacity: 0.2,\r\n                        interactive: true\r\n                    },\r\n                    interactive: true,\r\n                    onEachFeature: (feature, layerInstance) => {\r\n                        if (!L.Browser.mobile) {\r\n                            layerInstance.on('mouseover', () => {\r\n                                layerInstance.setStyle({ weight: 3, fillOpacity: 0.4 });\r\n                            });\r\n                            layerInstance.on('mouseout', () => {\r\n                                layerInstance.setStyle({ weight: 1.5, fillOpacity: 0.2 });\r\n                            });\r\n                        }\r\n\r\n                        const label = feature.properties?.PGOEDF;\r\n                        if (label) {\r\n                            bindColoredTooltip(layerInstance, label, fixedColor);\r\n                        }\r\n                    }\r\n                });\r\n\r\n                zoningLayersRef.current[k] = layer;\r\n\r\n                const shouldShow = !!visibleMapLayers.zoning && (visibleZoningCats[k] !== false);\r\n                if (shouldShow) mapInstance.current.addLayer(layer);\r\n            });\r\n        }\r\n    }, [extraDataLoaded, dataCache]);\r\n\r\n    useEffect(() => {\r\n        if (!mapInstance.current || !dataCache?.anpInternal) return;\r\n\r\n        if (selectedAnpLayerRef.current) {\r\n            mapInstance.current.removeLayer(selectedAnpLayerRef.current);\r\n            selectedAnpLayerRef.current = null;\r\n        }\r\n\r\n        if (!selectedAnpId || !visibleMapLayers.selectedAnpZoning) return;\r\n\r\n        const sel = (selectedAnpId ?? '').toString().trim();\r\n        const candidates = dataCache.anpInternal.features.filter(f => {\r\n            const id = (f.properties?.ANP_ID ?? '').toString().trim();\r\n            return id && id === sel;\r\n        });\r\n\r\n        if (candidates.length) {\r\n            const layer = L.geoJSON({ type: 'FeatureCollection', features: candidates }, {\r\n                pane: 'paneOverlay',\r\n                style: (feature) => ({ ...getZoningStyle(feature), fillOpacity: globalOpacity }),\r\n                interactive: true,\r\n                onEachFeature: (feature, layerInstance) => {\r\n                    const label = feature.properties?.ZONIFICACION || 'Zonificaci√≥n ANP';\r\n                    const style = getZoningStyle(feature);\r\n                    bindColoredTooltip(layerInstance, label, style.color);\r\n                }\r\n            });\r\n            selectedAnpLayerRef.current = layer;\r\n            mapInstance.current.addLayer(layer);\r\n        }\r\n\r\n    }, [selectedAnpId, visibleMapLayers.selectedAnpZoning, extraDataLoaded, dataCache, globalOpacity]);\r\n\r\n    useEffect(() => {\r\n        if (!mapInstance.current || !layersRef.current.base) return;\r\n        setTilesLoading(true);\r\n        layersRef.current.base.setUrl(getBaseLayerUrl(activeBaseLayer));\r\n\r\n        if (layersRef.current.alcaldias) {\r\n            const newColor = activeBaseLayer === 'SATELLITE' ? '#FFFFFF' : '#374151';\r\n            layersRef.current.alcaldias.setStyle({ color: newColor });\r\n        }\r\n    }, [activeBaseLayer]);\r\n\r\n    useEffect(() => {\r\n        if (!mapInstance.current) return;\r\n\r\n        ['sc', 'anp', 'alcaldias', 'edomex', 'morelos'].forEach(k => {\r\n            const layer = layersRef.current[k];\r\n            if (!layer) return;\r\n\r\n            if (visibleMapLayers[k] && !mapInstance.current.hasLayer(layer)) mapInstance.current.addLayer(layer);\r\n            if (!visibleMapLayers[k] && mapInstance.current.hasLayer(layer)) mapInstance.current.removeLayer(layer);\r\n\r\n            if (layer && visibleMapLayers[k] && layer.setStyle) {\r\n                if (k === 'alcaldias' || k === 'edomex' || k === 'morelos') {\r\n                } else {\r\n                    layer.setStyle({ fillOpacity: globalOpacity });\r\n                }\r\n            }\r\n        });\r\n\r\n        if (Object.keys(zoningLayersRef.current).length) {\r\n            (ZONING_ORDER || []).forEach(k => {\r\n                const zLayer = zoningLayersRef.current[k];\r\n                if (!zLayer) return;\r\n\r\n                const shouldShow = !!visibleMapLayers.zoning && (visibleZoningCats[k] !== false);\r\n                const has = mapInstance.current.hasLayer(zLayer);\r\n\r\n                if (shouldShow && !has) mapInstance.current.addLayer(zLayer);\r\n                if (!shouldShow && has) mapInstance.current.removeLayer(zLayer);\r\n\r\n                if (shouldShow && zLayer) {\r\n                    zLayer.setStyle({ fillOpacity: globalOpacity });\r\n                }\r\n            });\r\n        }\r\n    }, [visibleMapLayers, visibleZoningCats, extraDataLoaded, globalOpacity]);\r\n\r\n    useEffect(() => {\r\n        if (!mapInstance.current || !location || !L) return;\r\n\r\n        if (markerRef.current) markerRef.current.remove();\r\n\r\n        const styles = LAYER_STYLES || {};\r\n\r\n        let label = '';\r\n        let bgColor = '#9ca3af';\r\n\r\n        if (analysisStatus === 'OUTSIDE_CDMX') {\r\n            label = 'X';\r\n            bgColor = '#b91c1c';\r\n        } else if (analysisStatus === 'CONSERVATION_SOIL') {\r\n            label = 'SC';\r\n            bgColor = styles.sc?.color || '#3B7D23';\r\n        } else if (isANP) {\r\n            label = 'ANP';\r\n            bgColor = '#9333ea';\r\n        } else if (analysisStatus === 'URBAN_SOIL') {\r\n            label = 'SU';\r\n            bgColor = '#3b82f6';\r\n        }\r\n\r\n        const safeLabel = escapeHtml(label);\r\n\r\n        const iconHtml = `\r\n          <div class=\"marker-pop\" style=\"\r\n            width:32px;height:32px;background:${bgColor};color:#fff;\r\n            border:3px solid #fff;border-radius:50%;\r\n            display:flex;align-items:center;justify-content:center;\r\n            font-weight:bold;font-size:10px;\r\n            box-shadow:0 2px 8px rgba(0,0,0,0.25);\r\n          \">\r\n            ${safeLabel}\r\n          </div>\r\n          `;\r\n\r\n        const icon = L.divIcon({\r\n            html: iconHtml,\r\n            className: '',\r\n            iconSize: [32, 32],\r\n            iconAnchor: [16, 16]\r\n        });\r\n\r\n        markerRef.current = L.marker([location.lat, location.lng], { icon }).addTo(mapInstance.current);\r\n\r\n        const currentZoom = mapInstance.current.getZoom();\r\n        const targetZoom = Math.max(currentZoom, FOCUS_ZOOM);\r\n        mapInstance.current.flyTo([location.lat, location.lng], targetZoom, { duration: 0.8 });\r\n    }, [location, analysisStatus, isANP]);\r\n\r\n    return (\r\n        <div className=\"relative h-full w-full\">\r\n            <div id=\"main-map\" ref={mapRef} className=\"h-full w-full bg-gray-200\" />\r\n\r\n            {tilesLoading && (\r\n                <div className=\"absolute inset-0 flex items-center justify-center z-[1200] bg-black/10 pointer-events-none\">\r\n                    <div className=\"flex flex-col items-center gap-2 bg-white/90 px-4 py-3 rounded-lg shadow\">\r\n                        {Icons.Loader2 ? <Icons.Loader2 className=\"h-5 w-5 animate-spin text-[#9d2148]\" /> : <span>Cargando...</span>}\r\n                        <span className=\"text-[11px] text-gray-700 font-medium\">Cargando informaci√≥n geogr√°fica...</span>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MapViewer;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jorge\\Documents\\consulta-de-predios-V3\\src\\components\\modals\\HelpModal.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  20 |             return () => clearTimeout(timer);\n  21 |         } else {\n> 22 |             setIsVisible(false);\n     |             ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  23 |         }\n  24 |     }, [isOpen]);\n  25 |","line":22,"column":13,"nodeType":null,"endLine":22,"endColumn":25},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n  70 |                         aria-label=\"Cerrar\"\n  71 |                     >\n> 72 |                         <XIcon className=\"h-6 w-6\" />\n     |                          ^^^^^ This component is created during render\n  73 |                     </button>\n  74 |                 </div>\n  75 |\n\n   9 |\n  10 |     // Fallback for missing icon\n> 11 |     const XIcon = Icons.X || (() => <span className=\"text-xl\">√ó</span>);\n     |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ The component is created during render here\n  12 |     const MapPinnedIcon = Icons.MapPinned || (() => <span>üìç</span>);\n  13 |\n  14 |     const [isVisible, setIsVisible] = useState(false);","line":72,"column":26,"nodeType":null,"endLine":72,"endColumn":31},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n  81 |                         <section>\n  82 |                             <h3 className=\"flex items-center gap-2 text-base font-bold text-[#9d2148] mb-3 uppercase tracking-wide\">\n> 83 |                                 <MapPinnedIcon className=\"h-4 w-4\" />\n     |                                  ^^^^^^^^^^^^^ This component is created during render\n  84 |                                 ¬øC√≥mo realizar una consulta?\n  85 |                             </h3>\n  86 |                             <ul className=\"space-y-3 pl-1\">\n\n  10 |     // Fallback for missing icon\n  11 |     const XIcon = Icons.X || (() => <span className=\"text-xl\">√ó</span>);\n> 12 |     const MapPinnedIcon = Icons.MapPinned || (() => <span>üìç</span>);\n     |                                               ^^^^^^^^^^^^^^^^^^^^^ The component is created during render here\n  13 |\n  14 |     const [isVisible, setIsVisible] = useState(false);\n  15 |","line":83,"column":34,"nodeType":null,"endLine":83,"endColumn":47},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":90,"column":136,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4319,4439],"text":" Escribe la calle y n√∫mero en el buscador lateral (ej. &quot;Av. Insurgentes Sur 100\").\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4319,4439],"text":" Escribe la calle y n√∫mero en el buscador lateral (ej. &ldquo;Av. Insurgentes Sur 100\").\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4319,4439],"text":" Escribe la calle y n√∫mero en el buscador lateral (ej. &#34;Av. Insurgentes Sur 100\").\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4319,4439],"text":" Escribe la calle y n√∫mero en el buscador lateral (ej. &rdquo;Av. Insurgentes Sur 100\").\r\n                                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":90,"column":160,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4319,4439],"text":" Escribe la calle y n√∫mero en el buscador lateral (ej. \"Av. Insurgentes Sur 100&quot;).\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4319,4439],"text":" Escribe la calle y n√∫mero en el buscador lateral (ej. \"Av. Insurgentes Sur 100&ldquo;).\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4319,4439],"text":" Escribe la calle y n√∫mero en el buscador lateral (ej. \"Av. Insurgentes Sur 100&#34;).\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4319,4439],"text":" Escribe la calle y n√∫mero en el buscador lateral (ej. \"Av. Insurgentes Sur 100&rdquo;).\r\n                                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":96,"column":116,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4899,4991],"text":" Ingresa latitud y longitud (ej. &quot;19.4326, -99.1332\").\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4899,4991],"text":" Ingresa latitud y longitud (ej. &ldquo;19.4326, -99.1332\").\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4899,4991],"text":" Ingresa latitud y longitud (ej. &#34;19.4326, -99.1332\").\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4899,4991],"text":" Ingresa latitud y longitud (ej. &rdquo;19.4326, -99.1332\").\r\n                                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":96,"column":134,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[4899,4991],"text":" Ingresa latitud y longitud (ej. \"19.4326, -99.1332&quot;).\r\n                                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[4899,4991],"text":" Ingresa latitud y longitud (ej. \"19.4326, -99.1332&ldquo;).\r\n                                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[4899,4991],"text":" Ingresa latitud y longitud (ej. \"19.4326, -99.1332&#34;).\r\n                                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[4899,4991],"text":" Ingresa latitud y longitud (ej. \"19.4326, -99.1332&rdquo;).\r\n                                    "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport Icons from '../ui/Icons';\r\nimport { CONSTANTS } from '../../utils/constants';\r\n\r\nconst HelpModal = ({ isOpen, onClose }) => {\r\n    // Direct Access\r\n    const { CONTACT_INFO } = CONSTANTS || {};\r\n\r\n\r\n    // Fallback for missing icon\r\n    const XIcon = Icons.X || (() => <span className=\"text-xl\">√ó</span>);\r\n    const MapPinnedIcon = Icons.MapPinned || (() => <span>üìç</span>);\r\n\r\n    const [isVisible, setIsVisible] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            // Small timeout to ensure DOM mount before transition\r\n            const timer = setTimeout(() => setIsVisible(true), 50);\r\n            return () => clearTimeout(timer);\r\n        } else {\r\n            setIsVisible(false);\r\n        }\r\n    }, [isOpen]);\r\n\r\n    useEffect(() => {\r\n        const handleKeyDown = (e) => {\r\n            if (e.key === 'Enter' || e.key === 'Escape') onClose();\r\n        };\r\n\r\n        if (isOpen) {\r\n            window.addEventListener('keydown', handleKeyDown);\r\n        }\r\n        return () => window.removeEventListener('keydown', handleKeyDown);\r\n    }, [isOpen, onClose]);\r\n\r\n    if (!CONTACT_INFO) return null;\r\n    if (!isOpen) return null;\r\n\r\n\r\n\r\n    return (\r\n        <div\r\n            className={`fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-300 ${isVisible ? 'opacity-100' : 'opacity-0'}`}\r\n            style={{ pointerEvents: 'auto' }}\r\n        >\r\n            <div\r\n                className={`bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden glass-panel transition-all duration-300 ease-out transform ${isVisible ? 'scale-100 opacity-100 translate-y-0' : 'scale-95 opacity-0 translate-y-4'}`}\r\n                onClick={(e) => e.stopPropagation()}\r\n            >\r\n                {/* Header */}\r\n                <div className=\"flex items-center justify-between p-5 border-b border-gray-100 bg-gray-50\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"flex-shrink-0 w-10 h-10 rounded-full bg-[#9d2148] flex items-center justify-center text-white shadow-sm\">\r\n                            <span className=\"font-bold text-xl\">?</span>\r\n                        </div>\r\n                        <div>\r\n                            <h2 className=\"text-base font-bold text-gray-800 leading-tight\">\r\n                                Verifica si un punto se encuentra en\r\n                            </h2>\r\n                            <p className=\"text-sm text-[#9d2148] font-semibold\">\r\n                                Suelo de Conservaci√≥n o √Årea Natural Protegida\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                    <button\r\n                        onClick={() => { console.log('Close clicked'); onClose(); }}\r\n                        className=\"p-2 rounded-full hover:bg-gray-200 text-gray-500 transition-colors cursor-pointer\"\r\n                        style={{ pointerEvents: 'auto' }}\r\n                        aria-label=\"Cerrar\"\r\n                    >\r\n                        <XIcon className=\"h-6 w-6\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Content */}\r\n                <div className=\"flex-1 overflow-y-auto p-6 custom-scrollbar\">\r\n                    <div className=\"space-y-6\">\r\n\r\n                        {/* Secci√≥n 1: C√≥mo Consultar */}\r\n                        <section>\r\n                            <h3 className=\"flex items-center gap-2 text-base font-bold text-[#9d2148] mb-3 uppercase tracking-wide\">\r\n                                <MapPinnedIcon className=\"h-4 w-4\" />\r\n                                ¬øC√≥mo realizar una consulta?\r\n                            </h3>\r\n                            <ul className=\"space-y-3 pl-1\">\r\n                                <li className=\"flex gap-3 text-sm text-gray-700\">\r\n                                    <span className=\"flex-shrink-0 w-5 h-5 rounded-full bg-gray-100 text-gray-600 font-bold flex items-center justify-center text-[10px] border border-gray-200\">1</span>\r\n                                    <span>\r\n                                        <strong>B√∫squeda por direcci√≥n:</strong> Escribe la calle y n√∫mero en el buscador lateral (ej. \"Av. Insurgentes Sur 100\").\r\n                                    </span>\r\n                                </li>\r\n                                <li className=\"flex gap-3 text-sm text-gray-700\">\r\n                                    <span className=\"flex-shrink-0 w-5 h-5 rounded-full bg-gray-100 text-gray-600 font-bold flex items-center justify-center text-[10px] border border-gray-200\">2</span>\r\n                                    <span>\r\n                                        <strong>B√∫squeda por coordenadas:</strong> Ingresa latitud y longitud (ej. \"19.4326, -99.1332\").\r\n                                    </span>\r\n                                </li>\r\n                                <li className=\"flex gap-3 text-sm text-gray-700\">\r\n                                    <span className=\"flex-shrink-0 w-5 h-5 rounded-full bg-gray-100 text-gray-600 font-bold flex items-center justify-center text-[10px] border border-gray-200\">3</span>\r\n                                    <span>\r\n                                        <strong>Navegaci√≥n manual:</strong> Navega por el mapa y haz clic directamente sobre la ubicaci√≥n de inter√©s.\r\n                                    </span>\r\n                                </li>\r\n                                <li className=\"flex gap-3 text-sm text-gray-700\">\r\n                                    <span className=\"flex-shrink-0 w-5 h-5 rounded-full bg-gray-100 text-gray-600 font-bold flex items-center justify-center text-[10px] border border-gray-200\">4</span>\r\n                                    <span>\r\n                                        <strong>Mi ubicaci√≥n:</strong> Utiliza el bot√≥n de geolocalizaci√≥n para ubicarte autom√°ticamente.\r\n                                    </span>\r\n                                </li>\r\n                            </ul>\r\n                        </section>\r\n\r\n                        <hr className=\"border-gray-100\" />\r\n\r\n                        {/* Secci√≥n 2: Qu√© puedes hacer */}\r\n                        <section>\r\n                            <h3 className=\"flex items-center gap-2 text-base font-bold text-[#9d2148] mb-3 uppercase tracking-wide\">\r\n                                <Icons.CheckCircle className=\"h-4 w-4\" />\r\n                                Acciones Disponibles\r\n                            </h3>\r\n                            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\r\n                                <div className=\"bg-gray-50 p-3 rounded-lg border border-gray-100 text-center\">\r\n                                    <Icons.Pdf className=\"h-5 w-5 text-[#9d2148] mx-auto mb-2\" />\r\n                                    <span className=\"text-xs font-semibold text-gray-700 block\">Descargar Ficha</span>\r\n                                    <span className=\"text-[10px] text-gray-500 block leading-tight mt-1\">Obt√©n un reporte oficial en PDF</span>\r\n                                </div>\r\n                                <div className=\"bg-gray-50 p-3 rounded-lg border border-gray-100 text-center\">\r\n                                    <Icons.MapIcon className=\"h-5 w-5 text-[#9d2148] mx-auto mb-2\" />\r\n                                    <span className=\"text-xs font-semibold text-gray-700 block\">Google Maps</span>\r\n                                    <span className=\"text-[10px] text-gray-500 block leading-tight mt-1\">Ver la ubicaci√≥n en Google Maps</span>\r\n                                </div>\r\n                                <div className=\"bg-gray-50 p-3 rounded-lg border border-gray-100 text-center\">\r\n                                    <Icons.Share className=\"h-5 w-5 text-[#9d2148] mx-auto mb-2\" />\r\n                                    <span className=\"text-xs font-semibold text-gray-700 block\">Compartir</span>\r\n                                    <span className=\"text-[10px] text-gray-500 block leading-tight mt-1\">Comparte el resultado por enlace</span>\r\n                                </div>\r\n                            </div>\r\n                        </section>\r\n\r\n                        <hr className=\"border-gray-100\" />\r\n\r\n                        {/* Contacto */}\r\n                        <div className=\"bg-blue-50 border border-blue-100 rounded-xl p-4 flex flex-col sm:flex-row gap-4 items-center justify-between\">\r\n                            <div>\r\n                                <h4 className=\"font-bold text-blue-900 text-sm mb-1\">¬øNecesitas m√°s informaci√≥n?</h4>\r\n                                <p className=\"text-xs text-blue-700\">Comun√≠cate a la Direcci√≥n General de Ordenamiento Ecol√≥gico.</p>\r\n                            </div>\r\n                            <div className=\"text-right\">\r\n                                <div className=\"text-xs font-bold text-blue-900\">{CONTACT_INFO.phone}</div>\r\n                                <div className=\"text-[10px] text-blue-700\">{CONTACT_INFO.hours}</div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"p-4 border-t border-gray-200 bg-gray-50 text-center\">\r\n                    <button\r\n                        onClick={() => { console.log('Entendido clicked'); onClose(); }}\r\n                        className=\"bg-[#9d2148] text-white px-8 py-2.5 rounded-full text-sm font-bold shadow-md hover:bg-[#7d1d3a] transition-all active:scale-95 cursor-pointer\"\r\n                        style={{ pointerEvents: 'auto' }}\r\n                    >\r\n                        Entendido\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default HelpModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jorge\\Documents\\consulta-de-predios-V3\\src\\components\\search\\MobileSearchBar.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  16 |     // ‚úÖ Sync con estado padre\n  17 |     useEffect(() => {\n> 18 |         setQuery(initialValue || '');\n     |         ^^^^^^^^ Avoid calling setState() directly within an effect\n  19 |     }, [initialValue]);\n  20 |\n  21 |     // ‚úÖ Setter externo (sin window) - Deprecated but kept for compatibility just in case","line":18,"column":9,"nodeType":null,"endLine":18,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport Icons from '../ui/Icons';\r\nimport { searchMapboxPlaces, parseCoordinateInput } from '../../utils/geoUtils';\r\n\r\nconst MobileSearchBar = ({ onLocationSelect, onReset, setInputRef, initialValue }) => {\r\n    // Direct usage from imports\r\n    const safeSearch = async (q) => (typeof searchMapboxPlaces === 'function' ? await searchMapboxPlaces(q) : []);\r\n    const safeParse = (q) => (typeof parseCoordinateInput === 'function' ? parseCoordinateInput(q) : null);\r\n\r\n    const [query, setQuery] = useState('');\r\n    const [suggestions, setSuggestions] = useState([]);\r\n    const [isSearching, setIsSearching] = useState(false);\r\n    const debounceRef = useRef(null);\r\n    const [flash, setFlash] = useState(false);\r\n\r\n    // ‚úÖ Sync con estado padre\r\n    useEffect(() => {\r\n        setQuery(initialValue || '');\r\n    }, [initialValue]);\r\n\r\n    // ‚úÖ Setter externo (sin window) - Deprecated but kept for compatibility just in case\r\n    useEffect(() => {\r\n        if (!setInputRef) return;\r\n        setInputRef.current = (text) => {\r\n            setQuery(text || '');\r\n            setSuggestions([]);\r\n        };\r\n        return () => { setInputRef.current = null; };\r\n    }, [setInputRef]);\r\n\r\n    const handleChange = (e) => {\r\n        const value = e.target.value;\r\n        setQuery(value);\r\n\r\n        if (debounceRef.current) clearTimeout(debounceRef.current);\r\n        if (!value.trim() || value.trim().length < 3) {\r\n            setSuggestions([]);\r\n            return;\r\n        }\r\n\r\n        debounceRef.current = setTimeout(async () => {\r\n            setIsSearching(true);\r\n            const res = await safeSearch(value);\r\n            setSuggestions(res);\r\n            setIsSearching(false);\r\n        }, 300);\r\n    };\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n        if (!query.trim()) return;\r\n\r\n        const coord = safeParse(query);\r\n        if (coord) {\r\n            onLocationSelect(coord);\r\n            setSuggestions([]);\r\n            return;\r\n        }\r\n\r\n        if (suggestions.length > 0) {\r\n            const s = suggestions[0];\r\n            onLocationSelect({ lat: s.lat, lng: s.lng });\r\n            setQuery(s.label);\r\n            setSuggestions([]);\r\n            return;\r\n        }\r\n\r\n        setIsSearching(true);\r\n        const res = await safeSearch(query);\r\n        setIsSearching(false);\r\n\r\n        if (res.length > 0) {\r\n            const s = res[0];\r\n            onLocationSelect({ lat: s.lat, lng: s.lng });\r\n            setQuery(s.label);\r\n            setSuggestions([]);\r\n        } else {\r\n            alert('No se encontraron coincidencias en Mapbox.');\r\n        }\r\n    };\r\n\r\n    const handleSelectSuggestion = (s) => {\r\n        setQuery(s.label);\r\n        setSuggestions([]);\r\n        onLocationSelect({ lat: s.lat, lng: s.lng });\r\n    };\r\n\r\n    const handleClear = () => {\r\n        setQuery('');\r\n        setSuggestions([]);\r\n        onReset();\r\n    };\r\n\r\n    return (\r\n        <div className=\"w-full flex flex-col gap-2 pointer-events-none\">\r\n            <div className=\"pointer-events-auto\">\r\n                <form\r\n                    onSubmit={handleSubmit}\r\n                    className={`\r\n    relative w-full\r\n    bg-white rounded-full shadow-md\r\n    flex items-center border border-gray-200\r\n    focus-within:ring-2 focus-within:ring-[#9d2449] focus-within:border-transparent\r\n    transition-all duration-200 ease-out\r\n    ${flash ? 'ring-2 ring-[#9d2148]/50' : ''}\r\n  `}\r\n                >\r\n                    <input\r\n                        type=\"text\"\r\n                        className=\"flex-1 bg-transparent outline-none text-[13px] text-gray-800 placeholder-gray-400 h-11 pl-4 pr-20 rounded-full\"\r\n                        placeholder=\"Buscar direcci√≥n...\"\r\n                        value={query}\r\n                        onChange={handleChange}\r\n                        onFocus={() => {\r\n                            if (!query.trim()) {\r\n                                const history = JSON.parse(localStorage.getItem('search_history') || '[]');\r\n                                if (history.length) setSuggestions(history.map(x => ({ ...x, _isHistory: true })));\r\n                            }\r\n                        }}\r\n                    />\r\n\r\n                    {/* Buttons Container */}\r\n                    <div className=\"absolute right-1 flex items-center gap-1\">\r\n                        {query && (\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={handleClear}\r\n                                className=\"p-2 text-gray-400 hover:text-gray-600 rounded-full active:bg-gray-100\"\r\n                                title=\"Limpiar\"\r\n                            >\r\n                                <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line><line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line></svg>\r\n                            </button>\r\n                        )}\r\n\r\n                        <div className=\"h-5 w-px bg-gray-200\"></div>\r\n\r\n                        <button\r\n                            type=\"submit\"\r\n                            className=\"p-2 text-[#9d2449] active:text-[#7d1d3a] rounded-full active:bg-red-50\"\r\n                        >\r\n                            <Icons.Search className=\"h-5 w-5\" />\r\n                        </button>\r\n                    </div>\r\n\r\n                </form>\r\n\r\n                {(suggestions.length > 0 || isSearching) && (\r\n                    <div className=\"mt-1 bg-white border border-gray-200 rounded-lg shadow-md max-h-64 overflow-y-auto\">\r\n                        {isSearching && (\r\n                            <div className=\"px-3 py-1.5 text-[11px] text-gray-500\">Buscando en Mapbox‚Ä¶</div>\r\n                        )}\r\n                        {suggestions[0]?._isHistory && (\r\n                            <div className=\"px-3 py-1.5 bg-gray-50 text-[10px] font-bold text-gray-400 uppercase tracking-widest border-b border-gray-100 flex items-center gap-2\">\r\n                                <Icons.Clock className=\"h-3 w-3\" /> B√∫squedas recientes\r\n                            </div>\r\n                        )}\r\n                        {suggestions.map(s => (\r\n                            <button\r\n                                key={s.id}\r\n                                type=\"button\"\r\n                                onClick={() => {\r\n                                    if (!s._isHistory) {\r\n                                        const history = JSON.parse(localStorage.getItem('search_history') || '[]');\r\n                                        const newEntry = { label: s.label, lat: s.lat, lng: s.lng, fullLabel: s.fullLabel };\r\n                                        const filtered = history.filter(h => h.label !== s.label).slice(0, 4);\r\n                                        localStorage.setItem('search_history', JSON.stringify([newEntry, ...filtered]));\r\n                                    }\r\n                                    handleSelectSuggestion(s);\r\n                                }}\r\n                                className=\"w-full text-left px-3 py-2 hover:bg-gray-50 border-t border-gray-50 flex flex-col\"\r\n                            >\r\n                                <span className=\"text-[12px] font-bold text-gray-800 leading-tight\">\r\n                                    {s.label}\r\n                                </span>\r\n                                {s.fullLabel && (\r\n                                    <span className=\"text-[10px] text-gray-500 leading-tight\">\r\n                                        {s.fullLabel.startsWith(s.label)\r\n                                            ? s.fullLabel.substring(s.label.length).replace(/^,\\s*/, '')\r\n                                            : s.fullLabel}\r\n                                    </span>\r\n                                )}\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default MobileSearchBar;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jorge\\Documents\\consulta-de-predios-V3\\src\\components\\search\\SearchLogicDesktop.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  19 |     // ‚úÖ Sync con estado padre (Solo al montar o reset expl√≠cito)\n  20 |     useEffect(() => {\n> 21 |         if (initialValue) setQuery(initialValue);\n     |                           ^^^^^^^^ Avoid calling setState() directly within an effect\n  22 |     }, []); // Removed [initialValue] to prevent overwriting user input on re-renders\n  23 |\n  24 |     // ‚úÖ Setter externo","line":21,"column":27,"nodeType":null,"endLine":21,"endColumn":35},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":147,"column":105,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22&apos;18.8\"N 99¬∞04'25.8\"W"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22&lsquo;18.8\"N 99¬∞04'25.8\"W"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22&#39;18.8\"N 99¬∞04'25.8\"W"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22&rsquo;18.8\"N 99¬∞04'25.8\"W"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":147,"column":110,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8&quot;N 99¬∞04'25.8\"W"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8&ldquo;N 99¬∞04'25.8\"W"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8&#34;N 99¬∞04'25.8\"W"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8&rdquo;N 99¬∞04'25.8\"W"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":147,"column":118,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8\"N 99¬∞04&apos;25.8\"W"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8\"N 99¬∞04&lsquo;25.8\"W"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8\"N 99¬∞04&#39;25.8\"W"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8\"N 99¬∞04&rsquo;25.8\"W"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":147,"column":123,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8\"N 99¬∞04'25.8&quot;W"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8\"N 99¬∞04'25.8&ldquo;W"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8\"N 99¬∞04'25.8&#34;W"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6424,6458],"text":"Ejemplo: 19¬∞22'18.8\"N 99¬∞04'25.8&rdquo;W"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\r\nimport Icons from '../ui/Icons';\r\nimport Tooltip from '../ui/Tooltip';\r\nimport { searchMapboxPlaces, parseCoordinateInput } from '../../utils/geoUtils';\r\n\r\nconst SearchLogicDesktop = ({ onLocationSelect, onReset, setInputRef, initialValue }) => {\r\n    // Direct imports usage\r\n    const safeSearch = async (q) => (typeof searchMapboxPlaces === 'function' ? await searchMapboxPlaces(q) : []);\r\n    const safeParse = (q) => (typeof parseCoordinateInput === 'function' ? parseCoordinateInput(q) : null);\r\n\r\n    const [query, setQuery] = useState('');\r\n    const [suggestions, setSuggestions] = useState([]);\r\n    const [isSearching, setIsSearching] = useState(false);\r\n    const [showInfo, setShowInfo] = useState(false); // NEW: Info Tooltip State\r\n    const [isLocating, setIsLocating] = useState(false); // NEW: Geolocation loading state\r\n    const debounceRef = useRef(null);\r\n    const localInputRef = useRef(null);\r\n\r\n    // ‚úÖ Sync con estado padre (Solo al montar o reset expl√≠cito)\r\n    useEffect(() => {\r\n        if (initialValue) setQuery(initialValue);\r\n    }, []); // Removed [initialValue] to prevent overwriting user input on re-renders\r\n\r\n    // ‚úÖ Setter externo\r\n    useEffect(() => {\r\n        if (!setInputRef) return;\r\n        setInputRef.current = (text) => {\r\n            setQuery(text || '');\r\n            setSuggestions([]);\r\n        };\r\n        return () => {\r\n            setInputRef.current = null;\r\n        };\r\n    }, [setInputRef]);\r\n\r\n    const handleChange = (e) => {\r\n        const value = e.target.value;\r\n        setQuery(value);\r\n\r\n        if (debounceRef.current) clearTimeout(debounceRef.current);\r\n        if (!value.trim() || value.trim().length < 3) {\r\n            setSuggestions([]);\r\n            return;\r\n        }\r\n\r\n        // NEW: Suppress suggestions for Coordinates\r\n        if (/^-?\\d+(\\.\\d+)?(\\s*,\\s*|\\s+)-?\\d+(\\.\\d+)?$/.test(value.trim())) {\r\n            setSuggestions([]);\r\n            return;\r\n        }\r\n\r\n        debounceRef.current = setTimeout(async () => {\r\n            setIsSearching(true);\r\n            const res = await safeSearch(value);\r\n            setSuggestions(res);\r\n            setIsSearching(false);\r\n        }, 300);\r\n    };\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n        const value = query.trim();\r\n        if (!value) return;\r\n\r\n        const coord = safeParse(value);\r\n        if (coord) {\r\n            onLocationSelect(coord);\r\n            setSuggestions([]);\r\n            return;\r\n        }\r\n\r\n        if (suggestions.length > 0) {\r\n            const s = suggestions[0];\r\n\r\n            // Save to history\r\n            const history = JSON.parse(localStorage.getItem('search_history') || '[]');\r\n            const newEntry = { label: s.label, lat: s.lat, lng: s.lng, fullLabel: s.fullLabel };\r\n            const filtered = history.filter(h => h.label !== s.label).slice(0, 4);\r\n            localStorage.setItem('search_history', JSON.stringify([newEntry, ...filtered]));\r\n\r\n            onLocationSelect({ lat: s.lat, lng: s.lng });\r\n            setQuery(s.fullLabel || s.label);\r\n            setSuggestions([]);\r\n            return;\r\n        }\r\n\r\n        setIsSearching(true);\r\n        const res = await safeSearch(value);\r\n        setIsSearching(false);\r\n\r\n        if (res.length > 0) {\r\n            const s = res[0];\r\n            onLocationSelect({ lat: s.lat, lng: s.lng });\r\n            setQuery(s.fullLabel || s.label);\r\n            setSuggestions([]);\r\n        } else {\r\n            alert('No se encontraron coincidencias en Mapbox.');\r\n        }\r\n    };\r\n\r\n    const handleSelectSuggestion = (s) => {\r\n        setQuery(s.fullLabel || s.label);\r\n        setSuggestions([]);\r\n        onLocationSelect({ lat: s.lat, lng: s.lng });\r\n    };\r\n\r\n    const handleResetAll = () => {\r\n        setQuery('');\r\n        setSuggestions([]);\r\n        onReset();\r\n    };\r\n\r\n    return (\r\n        <div className=\"space-y-2\">\r\n            <div className=\"relative\">\r\n                <div className=\"relative mb-3\">\r\n                    <div className=\"flex items-center justify-between mb-1\">\r\n\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={() => setShowInfo(!showInfo)}\r\n                            className=\"text-[10px] bg-white border border-gray-200 hover:bg-gray-50 text-[#9d2449] px-2 py-0.5 rounded-full flex items-center gap-1 transition-colors shadow-sm\"\r\n                        >\r\n                            <Icons.Info className=\"h-3 w-3\" />\r\n                            <span className=\"font-bold\">Ayuda</span>\r\n                        </button>\r\n                    </div>\r\n\r\n                    {showInfo && (\r\n                        <div className=\"mb-3 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-800 animate-in fade-in slide-in-from-top-1 shadow-sm\">\r\n                            <div className=\"font-bold mb-2 text-[#9d2449] flex items-center gap-2\">\r\n                                <Icons.Info className=\"h-3 w-3\" />\r\n                                ¬øC√≥mo realizar una b√∫squeda?\r\n                            </div>\r\n                            <p className=\"mb-2 opacity-90\">Puedes ingresar la ubicaci√≥n de cualquiera de las siguientes formas:</p>\r\n                            <ul className=\"space-y-2 text-[11px] opacity-90\">\r\n                                <li className=\"bg-white p-1.5 rounded border border-gray-200\">\r\n                                    <strong className=\"block text-gray-900 mb-0.5\">Direcci√≥n</strong>\r\n                                    <span className=\"text-gray-500\">Ejemplo: Calle 5 de Mayo, Centro</span>\r\n                                </li>\r\n                                <li className=\"bg-white p-1.5 rounded border border-gray-200\">\r\n                                    <strong className=\"block text-gray-900 mb-0.5\">Coordenadas (latitud, longitud)</strong>\r\n                                    <span className=\"font-mono text-[10px] text-gray-500\">Ejemplo: 19.4326, -99.1332</span>\r\n                                </li>\r\n                                <li className=\"bg-white p-1.5 rounded border border-gray-200\">\r\n                                    <strong className=\"block text-gray-900 mb-0.5\">Coordenadas DMS</strong>\r\n                                    <span className=\"font-mono text-[10px] text-gray-500\">Ejemplo: 19¬∞22'18.8\"N 99¬∞04'25.8\"W</span>\r\n                                </li>\r\n                                <li className=\"bg-white p-1.5 rounded border border-gray-200\">\r\n                                    <strong className=\"block text-gray-900 mb-0.5\">Colonia y alcald√≠a</strong>\r\n                                    <span className=\"text-gray-500\">Ejemplo: Polanco, Miguel Hidalgo</span>\r\n                                </li>\r\n                            </ul>\r\n                        </div>\r\n                    )}\r\n                    <div className=\"relative group\">\r\n                        <div className=\"relative flex items-center w-full shadow-sm hover:shadow-md transition-shadow bg-white rounded-full border border-gray-200 focus-within:ring-2 focus-within:ring-[#9d2449] focus-within:border-transparent\">\r\n                            <input\r\n                                type=\"text\"\r\n                                ref={localInputRef}\r\n                                placeholder=\"Buscar direcci√≥n, coordenadas, alcald√≠a...\"\r\n                                className=\"w-full h-12 pl-6 pr-24 bg-transparent border-none rounded-full text-sm text-gray-700 placeholder-gray-400 focus:ring-0 focus:outline-none\"\r\n                                value={query}\r\n                                onChange={handleChange}\r\n                                onKeyDown={(e) => {\r\n                                    if (e.key === 'Enter') {\r\n                                        handleSubmit(e);\r\n                                        setSuggestions([]);\r\n                                    }\r\n                                }}\r\n                                onFocus={() => {\r\n                                    if (!query.trim()) {\r\n                                        const history = JSON.parse(localStorage.getItem('search_history') || '[]');\r\n                                        if (history.length) setSuggestions(history.map(x => ({ ...x, _isHistory: true })));\r\n                                    }\r\n                                }}\r\n                            />\r\n\r\n                            {/* Buttons Container (Right) */}\r\n                            <div className=\"absolute right-2 flex items-center gap-1\">\r\n                                {query && (\r\n                                    <Tooltip content=\"Limpiar b√∫squeda\">\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={() => {\r\n                                                setQuery('');\r\n                                                setSuggestions([]);\r\n                                                localInputRef.current?.focus();\r\n                                            }}\r\n                                            className=\"p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition-colors\"\r\n                                        >\r\n                                            <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line><line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line></svg>\r\n                                        </button>\r\n                                    </Tooltip>\r\n                                )}\r\n\r\n                                <div className=\"h-6 w-px bg-gray-200 mx-1\"></div>\r\n\r\n                                <Tooltip content=\"Buscar\">\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={handleSubmit}\r\n                                        disabled={isSearching}\r\n                                        className=\"p-2 text-[#9d2449] hover:text-[#7d1d3a] rounded-full hover:bg-red-50 transition-colors disabled:opacity-50\"\r\n                                    >\r\n                                        {isSearching ? (\r\n                                            <div className=\"h-5 w-5 border-2 border-gray-200 border-t-[#9d2449] rounded-full animate-spin\"></div>\r\n                                        ) : (\r\n                                            <Icons.Search className=\"h-5 w-5\" />\r\n                                        )}\r\n                                    </button>\r\n                                </Tooltip>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Sugerencias y Recientes */}\r\n                    {suggestions.length > 0 && (\r\n                        <div className=\"absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-xl border border-gray-100 z-[3000] overflow-hidden max-h-60 overflow-y-auto\">\r\n                            {suggestions[0]._isHistory && (\r\n                                <div className=\"px-3 py-1.5 bg-gray-50 text-[10px] font-bold text-gray-400 uppercase tracking-widest border-b border-gray-100\">\r\n                                    B√∫squedas recientes\r\n                                </div>\r\n                            )}\r\n\r\n                            {suggestions.map((s, i) => (\r\n                                <button\r\n                                    key={i}\r\n                                    type=\"button\"\r\n                                    onClick={() => {\r\n                                        // Save to history logic\r\n                                        if (!s._isHistory) {\r\n                                            const history = JSON.parse(localStorage.getItem('search_history') || '[]');\r\n                                            const newEntry = { label: s.label, lat: s.lat, lng: s.lng, fullLabel: s.fullLabel };\r\n                                            const filtered = history.filter(h => h.label !== s.label).slice(0, 4); // Keep last 5\r\n                                            localStorage.setItem('search_history', JSON.stringify([newEntry, ...filtered]));\r\n                                        }\r\n                                        handleSelectSuggestion(s);\r\n                                    }}\r\n                                    className=\"w-full text-left px-3 py-2 text-[12px] hover:bg-gray-50 border-t border-gray-50 flex items-center gap-2\"\r\n                                >\r\n                                    {s._isHistory ? <Icons.Clock className=\"h-3 w-3 text-gray-400\" /> : <Icons.MapPin className=\"h-3 w-3 text-gray-400\" />}\r\n                                    <div>\r\n                                        <div className=\"font-bold text-gray-800\">{s.label}</div>\r\n                                        {s.fullLabel && (\r\n                                            <div className=\"text-[10px] text-gray-500\">\r\n                                                {s.fullLabel.startsWith(s.label)\r\n                                                    ? s.fullLabel.substring(s.label.length).replace(/^,\\s*/, '')\r\n                                                    : s.fullLabel}\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                </button>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* BOT√ìN MI UBICACI√ìN */}\r\n                <button\r\n                    type=\"button\"\r\n                    disabled={isLocating}\r\n                    onClick={() => {\r\n                        if (!navigator.geolocation) {\r\n                            alert(\"Tu navegador no soporta geolocalizaci√≥n.\");\r\n                            return;\r\n                        }\r\n\r\n                        setIsLocating(true);\r\n\r\n                        navigator.geolocation.getCurrentPosition(\r\n                            (pos) => {\r\n                                setIsLocating(false);\r\n                                const { latitude, longitude } = pos.coords;\r\n                                // Actualizar el input con las coordenadas\r\n                                setQuery(`${latitude.toFixed(5)}, ${longitude.toFixed(5)}`);\r\n                                // Disparar la selecci√≥n de ubicaci√≥n\r\n                                onLocationSelect({ lat: latitude, lng: longitude });\r\n                            },\r\n                            (err) => {\r\n                                setIsLocating(false);\r\n                                console.error(err);\r\n                                let msg = \"No pudimos obtener tu ubicaci√≥n.\";\r\n                                if (err.code === 1) msg = \"Permiso de ubicaci√≥n denegado.\";\r\n                                if (err.code === 2) msg = \"Ubicaci√≥n no disponible.\";\r\n                                if (err.code === 3) msg = \"Tiempo de espera agotado.\";\r\n                                alert(`${msg} Verifica tu conexi√≥n y permisos.`);\r\n                            },\r\n                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }\r\n                        );\r\n                    }}\r\n                    className=\"w-full mt-2 bg-white border border-gray-200 text-[#9d2449] hover:bg-gray-50 font-bold py-2 rounded-lg text-xs shadow-sm flex items-center justify-center gap-2 transition-colors disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                >\r\n                    {isLocating ? (\r\n                        <div className=\"h-4 w-4 border-2 border-gray-200 border-t-[#9d2449] rounded-full animate-spin\"></div>\r\n                    ) : (\r\n                        <Icons.Navigation className=\"h-4 w-4\" />\r\n                    )}\r\n                    {isLocating ? \"Obteniendo ubicaci√≥n...\" : \"Usar mi ubicaci√≥n actual\"}\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default SearchLogicDesktop;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jorge\\Documents\\consulta-de-predios-V3\\src\\components\\ui\\ToastSystem.jsx","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`removeToast` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\n  12 |         const id = Date.now();\n  13 |         setToasts(prev => [...prev, { id, message, type }]);\n> 14 |         setTimeout(() => removeToast(id), 3000);\n     |                          ^^^^^^^^^^^ `removeToast` accessed before it is declared\n  15 |     }, []);\n  16 |\n  17 |     const removeToast = useCallback((id) => {\n\n  15 |     }, []);\n  16 |\n> 17 |     const removeToast = useCallback((id) => {\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 18 |         setToasts(prev => prev.filter(t => t.id !== id));\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 19 |     }, []);\n     | ^^^^^^^^^^^^ `removeToast` is declared here\n  20 |\n  21 |     return (\n  22 |         <ToastContext.Provider value={{ addToast, toasts }}>","line":14,"column":26,"nodeType":null,"endLine":14,"endColumn":37}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, createContext, useContext, useCallback } from 'react';\r\nimport { Icons } from './Icons';\r\n\r\nconst ToastContext = createContext(null);\r\n\r\nexport const useToast = () => useContext(ToastContext);\r\n\r\nexport const ToastProvider = ({ children }) => {\r\n    const [toasts, setToasts] = useState([]);\r\n\r\n    const addToast = useCallback((message, type = 'info') => {\r\n        const id = Date.now();\r\n        setToasts(prev => [...prev, { id, message, type }]);\r\n        setTimeout(() => removeToast(id), 3000);\r\n    }, []);\r\n\r\n    const removeToast = useCallback((id) => {\r\n        setToasts(prev => prev.filter(t => t.id !== id));\r\n    }, []);\r\n\r\n    return (\r\n        <ToastContext.Provider value={{ addToast, toasts }}>\r\n            {children}\r\n        </ToastContext.Provider>\r\n    );\r\n};\r\n\r\nexport const ToastContainer = () => {\r\n    const { toasts } = useToast();\r\n    return (\r\n        <div className=\"absolute md:bottom-24 bottom-auto top-32 md:top-auto left-1/2 transform -translate-x-1/2 z-[5000] flex flex-col gap-2 pointer-events-none w-max max-w-[90%]\">\r\n            {toasts.map(t => (\r\n                <div\r\n                    key={t.id}\r\n                    className={`\r\n              pointer-events-auto px-4 py-3 rounded-lg shadow-lg text-sm font-semibold text-white animate-slide-up flex items-center gap-2\r\n              ${t.type === 'error' ? 'bg-red-600' : t.type === 'success' ? 'bg-green-600' : 'bg-gray-800'}\r\n            `}\r\n                >\r\n                    {Icons.AlertCircle && t.type === 'error' && <Icons.AlertCircle className=\"h-4 w-4\" />}\r\n                    {Icons.CheckCircle && t.type === 'success' && <Icons.CheckCircle className=\"h-4 w-4\" />}\r\n                    {t.message}\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jorge\\Documents\\consulta-de-predios-V3\\src\\utils\\geoUtils.js","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\'.","line":219,"column":48,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":219,"endColumn":49,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7578,7579],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7578,7578],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\\".","line":219,"column":71,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":219,"endColumn":72,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7601,7602],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7601,7601],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\'.","line":220,"column":48,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":220,"endColumn":49,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7667,7668],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7667,7667],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\\".","line":220,"column":71,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":220,"endColumn":72,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7690,7691],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7690,7690],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { CONSTANTS } from './constants';\r\n\r\n// --- HELPERS GEOESPACIALES ---\r\n\r\nexport const isPointInPolygon = (point, feature) => {\r\n    if (!point || typeof point.lat !== 'number' || typeof point.lng !== 'number') return false;\r\n    if (!feature?.geometry?.type || !feature?.geometry?.coordinates) return false;\r\n    const x = point.lng; // GeoJSON: X = longitud\r\n    const y = point.lat; // GeoJSON: Y = latitud\r\n\r\n    const { type, coordinates } = feature.geometry;\r\n\r\n    const pointInRing = (ring) => {\r\n        let inside = false;\r\n\r\n        for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {\r\n            const xi = ring[i][0]; // lng\r\n            const yi = ring[i][1]; // lat\r\n            const xj = ring[j][0]; // lng\r\n            const yj = ring[j][1]; // lat\r\n\r\n            const denom = (yj - yi);\r\n            if (denom === 0) continue;\r\n            const intersect =\r\n                ((yi > y) !== (yj > y)) &&\r\n                (x < ((xj - xi) * (y - yi)) / denom + xi);\r\n\r\n            if (intersect) inside = !inside;\r\n        }\r\n\r\n        return inside;\r\n    };\r\n\r\n    if (type === 'Polygon') {\r\n        if (!pointInRing(coordinates[0])) return false;\r\n        const holes = coordinates.slice(1);\r\n        if (holes.length && holes.some(h => pointInRing(h))) return false;\r\n        return true;\r\n    }\r\n\r\n    if (type === 'MultiPolygon') {\r\n        return coordinates.some(poly => {\r\n            if (!pointInRing(poly[0])) return false;\r\n            const holes = poly.slice(1);\r\n            if (holes.length && holes.some(h => pointInRing(h))) return false;\r\n            return true;\r\n        });\r\n    }\r\n\r\n    return false;\r\n};\r\n\r\n// OPTIMIZATION: BBox Helper (Lazy Calculation)\r\nexport const getFeatureBounds = (feature) => {\r\n    if (feature._bbox) return feature._bbox;\r\n\r\n    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\r\n\r\n    const processRing = (ring) => {\r\n        for (let i = 0; i < ring.length; i++) {\r\n            const [x, y] = ring[i];\r\n            if (x < minX) minX = x;\r\n            if (x > maxX) maxX = x;\r\n            if (y < minY) minY = y;\r\n            if (y > maxY) maxY = y;\r\n        }\r\n    };\r\n\r\n    const geom = feature.geometry;\r\n    if (geom.type === 'Polygon') {\r\n        processRing(geom.coordinates[0]);\r\n    } else if (geom.type === 'MultiPolygon') {\r\n        for (let i = 0; i < geom.coordinates.length; i++) {\r\n            processRing(geom.coordinates[i][0]);\r\n        }\r\n    }\r\n\r\n    // Cache the result directly on the feature object\r\n    feature._bbox = { minX, minY, maxX, maxY };\r\n    return feature._bbox;\r\n};\r\n\r\nexport const findFeature = (p, c) => {\r\n    if (!c?.features) return null;\r\n\r\n    const x = p.lng;\r\n    const y = p.lat;\r\n\r\n    // ‚úÖ Reverse loop: prioritize layers on top (last in array)\r\n    for (let i = c.features.length - 1; i >= 0; i--) {\r\n        const f = c.features[i];\r\n\r\n        // 1. FAST CHECK: Bounding Box\r\n        const bbox = getFeatureBounds(f);\r\n        if (x < bbox.minX || x > bbox.maxX || y < bbox.minY || y > bbox.maxY) {\r\n            continue; // Skip complex calculation\r\n        }\r\n\r\n        // 2. SLOW CHECK: Point in Polygon (Only if passed BBox)\r\n        if (isPointInPolygon(p, f)) return f;\r\n    }\r\n    return null;\r\n};\r\n\r\nexport const getZoningColor = (key) => {\r\n    if (!key) return '#ccc';\r\n    const k = key.toString().toUpperCase();\r\n    const catInfo = CONSTANTS.ZONING_CAT_INFO || {};\r\n    const cat = Object.keys(catInfo).find(c => k.startsWith(c));\r\n    return cat ? catInfo[cat].color : '#9ca3af';\r\n};\r\n\r\nexport const getAnpZoningColor = (zoningName) => {\r\n    const name = (zoningName || '').toLowerCase();\r\n\r\n    // Paleta sem√°ntica\r\n    if (name.includes('protecci√≥n') || name.includes('nucleo') || name.includes('n√∫cleo')) return '#ef4444';\r\n    if (name.includes('restringid')) return '#f97316';\r\n    if (name.includes('aprovechamiento')) return '#84cc16';\r\n    if (name.includes('tradicional')) return '#eab308';\r\n    if (name.includes('publico') || name.includes('p√∫blico')) return '#06b6d4';\r\n    if (name.includes('restauraci')) return '#10b981';\r\n    if (name.includes('recuperacion') || name.includes('recuperaci√≥n')) return '#10b981';\r\n\r\n    let hash = 0;\r\n    for (let i = 0; i < name.length; i++) {\r\n        hash = name.charCodeAt(i) + ((hash << 5) - hash);\r\n    }\r\n    const fallbackPalette = ['#f472b6', '#22d3ee', '#fbbf24', '#a3e635', '#f87171', '#c084fc'];\r\n    return fallbackPalette[Math.abs(hash) % fallbackPalette.length];\r\n};\r\n\r\nexport const getZoningStyle = (feature) => {\r\n    let color;\r\n    let fillOpacity = 0.2;\r\n\r\n    if (feature.properties?.CLAVE) {\r\n        color = getZoningColor(feature.properties.CLAVE);\r\n    }\r\n    else if (feature.properties?.ZONIFICACION) {\r\n        color = getAnpZoningColor(feature.properties.ZONIFICACION);\r\n        fillOpacity = 0.4;\r\n    }\r\n    else {\r\n        color = '#8b5cf6';\r\n    }\r\n\r\n    return {\r\n        color: color,\r\n        weight: 1.5,\r\n        opacity: 0.9,\r\n        fillColor: color,\r\n        fillOpacity: fillOpacity,\r\n        interactive: true\r\n    };\r\n};\r\n\r\nexport const getSectorStyle = (sectorName) => {\r\n    const norm = (sectorName || '').toLowerCase().trim();\r\n    if (norm.includes('agr√≠cola') || norm.includes('agricola') || norm.includes('agro')) {\r\n        return { bg: '#FEF9C3', border: '#FACC15', text: '#854D0E' };\r\n    }\r\n    if (norm.includes('pecuario') || norm.includes('ganad')) {\r\n        return { bg: '#FFEDD5', border: '#FB923C', text: '#9A3412' };\r\n    }\r\n    if (norm.includes('forestal') || norm.includes('bosque')) {\r\n        return { bg: '#DCFCE7', border: '#22C55E', text: '#14532D' };\r\n    }\r\n    if (norm.includes('turismo') || norm.includes('eco')) {\r\n        return { bg: '#E0E7FF', border: '#6366F1', text: '#312E81' };\r\n    }\r\n    if (norm.includes('infra') || norm.includes('equip')) {\r\n        return { bg: '#F3F4F6', border: '#9CA3AF', text: '#374151' };\r\n    }\r\n    return { bg: '#F3F4F6', border: '#9CA3AF', text: '#374151' };\r\n};\r\n\r\n\r\n// --- SEARCH HELPERS ---\r\n\r\nexport const isStrictNumber = (val) => {\r\n    if (typeof val !== 'string') return false;\r\n    return !isNaN(val) && !isNaN(parseFloat(val));\r\n};\r\n\r\nexport const parseCoordinateInput = (input) => {\r\n    if (!input || typeof input !== 'string') return null;\r\n    const s = input.trim();\r\n\r\n    const tryDecimal = (text) => {\r\n        if (/[¬∞'\"NnSsEeWw]/.test(text)) return null;\r\n        if (text.includes(',')) {\r\n            const parts = text.split(',').map(p => p.trim());\r\n            if (parts.length === 2 && isStrictNumber(parts[0]) && isStrictNumber(parts[1])) {\r\n                const lat = Number(parts[0]);\r\n                const lng = Number(parts[1]);\r\n                if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };\r\n            }\r\n        }\r\n        const spaceParts = text.trim().split(/\\s+/);\r\n        if (spaceParts.length === 2 && isStrictNumber(spaceParts[0]) && isStrictNumber(spaceParts[1])) {\r\n            const lat = Number(spaceParts[0]);\r\n            const lng = Number(spaceParts[1]);\r\n            if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return { lat, lng };\r\n        }\r\n        return null;\r\n    };\r\n\r\n    const decimal = tryDecimal(s);\r\n    if (decimal) return decimal;\r\n\r\n    const dmsToDecimal = (deg, min, sec, hemi) => {\r\n        let d = parseFloat(deg) + parseFloat(min) / 60 + parseFloat(sec) / 3600;\r\n        hemi = (hemi || '').toUpperCase();\r\n        if (hemi === 'S' || hemi === 'W') d *= -1;\r\n        return d;\r\n    };\r\n\r\n    const latMatch = s.match(/(\\d+)[¬∞\\s]+(\\d+)[\\'‚Äô\\s]+(\\d+(?:\\.\\d+)?)[\\\"\\s]*([NnSs])/);\r\n    const lonMatch = s.match(/(\\d+)[¬∞\\s]+(\\d+)[\\'‚Äô\\s]+(\\d+(?:\\.\\d+)?)[\\\"\\s]*([EeWw])/);\r\n\r\n    if (latMatch && lonMatch) {\r\n        const lat = dmsToDecimal(latMatch[1], latMatch[2], latMatch[3], latMatch[4]);\r\n        const lng = dmsToDecimal(lonMatch[1], lonMatch[2], lonMatch[3], lonMatch[4]);\r\n        if (!isNaN(lat) && !isNaN(lng)) return { lat, lng };\r\n    }\r\n    return null;\r\n};\r\n\r\nexport const searchMapboxPlaces = async (query) => {\r\n    if (!query) return [];\r\n    const token = CONSTANTS.MAPBOX_TOKEN;\r\n    const bbox = '-99.3649,19.0482,-98.9403,19.5927';\r\n    const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${token}&bbox=${bbox}&country=mx&limit=5&language=es`;\r\n\r\n    try {\r\n        const r = await fetch(url);\r\n        if (!r.ok) return [];\r\n        const d = await r.json();\r\n        return d.features.map(f => ({\r\n            id: f.id,\r\n            label: f.text, // Nombre corto\r\n            fullLabel: f.place_name,\r\n            lat: f.center[1],\r\n            lng: f.center[0]\r\n        }));\r\n    } catch (e) {\r\n        console.error('Mapbox error:', e);\r\n        return [];\r\n    }\r\n};\r\n\r\nexport const getBaseLayerUrl = (name) => {\r\n    const token = CONSTANTS.MAPBOX_TOKEN;\r\n    if (name === 'STREETS') return `https://api.mapbox.com/styles/v1/mapbox/light-v11/tiles/256/{z}/{x}/{y}?access_token=${token}`;\r\n    if (name === 'SATELLITE') return `https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/tiles/256/{z}/{x}/{y}?access_token=${token}`;\r\n    if (name === 'TOPO') return `https://api.mapbox.com/styles/v1/mapbox/outdoors-v12/tiles/256/{z}/{x}/{y}?access_token=${token}`;\r\n    return `https://api.mapbox.com/styles/v1/mapbox/light-v11/tiles/256/{z}/{x}/{y}?access_token=${token}`;\r\n};\r\n\r\nexport const getReverseGeocoding = async (lat, lng, apiKey) => {\r\n    const token = apiKey || CONSTANTS.MAPBOX_TOKEN;\r\n    if (!token) {\r\n        console.warn(\"Mapbox API Key no configurada.\");\r\n        return null;\r\n    }\r\n    const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?types=address,poi&language=es&access_token=${token}`;\r\n    try {\r\n        const response = await fetch(url);\r\n        if (!response.ok) throw new Error('Error fetching address');\r\n        const data = await response.json();\r\n        if (data.features && data.features.length > 0) {\r\n            return data.features[0].place_name;\r\n        }\r\n        return null;\r\n    } catch (error) {\r\n        console.error(\"Error en geocodificaci√≥n:\", error);\r\n        return null;\r\n    }\r\n};\r\n\r\nexport const formatDateTime = (dateStr) => {\r\n    const d = new Date(dateStr);\r\n    return d.toLocaleString('es-MX', {\r\n        year: 'numeric', month: 'long', day: 'numeric',\r\n        hour: '2-digit', minute: '2-digit'\r\n    });\r\n};\r\n\r\nexport const generateFolio = () => {\r\n    const now = new Date();\r\n    const iso = now.toISOString().replace(/[-:T.Z]/g, '').slice(0, 14);\r\n    return `F-${iso}`;\r\n};\r\n","usedDeprecatedRules":[]}]
